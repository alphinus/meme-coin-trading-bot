---
phase: 18-sdk-auth-cleanup
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - server/src/agent/auth-check.ts
  - server/src/app.ts
  - server/src/agent/session-manager.ts
  - .env.example
autonomous: true

must_haves:
  truths:
    - "Server logs which auth method is active at startup (API key vs subscription vs none)"
    - "Server warns visibly when both ANTHROPIC_API_KEY and CLAUDE_CODE_OAUTH_TOKEN are set"
    - "User can start agent sessions using CLAUDE_CODE_OAUTH_TOKEN without ANTHROPIC_API_KEY"
    - "Runtime apiKeySource from SDK init message is logged per session"
  artifacts:
    - path: "server/src/agent/auth-check.ts"
      provides: "checkAgentAuth() function for startup logging and warning"
      exports: ["checkAgentAuth"]
    - path: "server/src/app.ts"
      provides: "checkAgentAuth() called at startup before route setup"
      contains: "checkAgentAuth"
    - path: "server/src/agent/session-manager.ts"
      provides: "apiKeySource capture from init message"
      contains: "apiKeySource"
    - path: ".env.example"
      provides: "Documentation of both auth methods"
      contains: "CLAUDE_CODE_OAUTH_TOKEN"
  key_links:
    - from: "server/src/app.ts"
      to: "server/src/agent/auth-check.ts"
      via: "import and call at module scope"
      pattern: "import.*checkAgentAuth.*auth-check"
    - from: "server/src/agent/session-manager.ts"
      to: "@anthropic-ai/claude-agent-sdk"
      via: "init message apiKeySource field"
      pattern: "apiKeySource"
---

<objective>
Add startup auth detection logging and dual-auth warning, capture runtime apiKeySource from SDK init messages, and document subscription auth configuration in .env.example.

Purpose: Operators know which billing path (API key vs subscription) is active at startup, get warned about ambiguous dual-auth config, and have clear documentation for switching to subscription auth. Runtime auth verification via apiKeySource confirms what the SDK subprocess actually resolved.

Output: New auth-check.ts module, updated app.ts with startup call, enhanced session-manager.ts init capture, updated .env.example with both auth methods documented.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@server/src/app.ts
@server/src/agent/session-manager.ts
@.env.example
@.planning/phases/18-sdk-auth-cleanup/18-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth-check module and wire into startup</name>
  <files>server/src/agent/auth-check.ts, server/src/app.ts</files>
  <action>
1. Create `server/src/agent/auth-check.ts` with a single exported function `checkAgentAuth()`:

```typescript
/**
 * Detect and log which authentication method the Agent SDK will use.
 * Called once at server startup before any agent sessions.
 *
 * The SDK subprocess inherits process.env and checks:
 * 1. ANTHROPIC_API_KEY (highest priority, pay-per-token)
 * 2. CLAUDE_CODE_OAUTH_TOKEN (subscription auth, Claude Max quota)
 */
export function checkAgentAuth(): void {
  const hasApiKey = !!process.env.ANTHROPIC_API_KEY;
  const hasOAuthToken = !!process.env.CLAUDE_CODE_OAUTH_TOKEN;

  // SDKA-03: Warn if both are set (API key silently wins)
  if (hasApiKey && hasOAuthToken) {
    console.warn(
      "[agent-auth] WARNING: Both ANTHROPIC_API_KEY and CLAUDE_CODE_OAUTH_TOKEN are set. " +
      "The SDK will use the API key (higher priority). " +
      "The subscription token will be silently ignored. " +
      "To use subscription auth, remove ANTHROPIC_API_KEY from your environment."
    );
  }

  // SDKA-02: Log active auth method
  if (hasApiKey) {
    console.log("[agent-auth] Auth method: API key (pay-per-token billing)");
  } else if (hasOAuthToken) {
    console.log("[agent-auth] Auth method: Subscription (Claude Max quota)");
  } else {
    console.warn(
      "[agent-auth] WARNING: No agent authentication configured. " +
      "Set ANTHROPIC_API_KEY or CLAUDE_CODE_OAUTH_TOKEN in your environment. " +
      "Agent sessions will fail until auth is configured."
    );
  }
}
```

2. In `server/src/app.ts`, add an import for `checkAgentAuth` from `./agent/auth-check.js` after the existing imports (near the other agent import on line 31). Then call `checkAgentAuth()` right after the `initEventStore()` call (line 34), before the memory subsystem initialization. This ensures auth status is the first thing logged after event store init.

Add import:
```typescript
import { checkAgentAuth } from "./agent/auth-check.js";
```

Add call (after line 34, after `initEventStore();`):
```typescript
// Check and log agent SDK authentication method
checkAgentAuth();
```
  </action>
  <verify>
1. `cat server/src/agent/auth-check.ts` shows the checkAgentAuth function with three branches (both, apiKey-only, oauth-only, neither).
2. `grep "checkAgentAuth" server/src/app.ts` shows both the import line and the function call.
3. `npm run build -w server` passes with zero TypeScript errors.
  </verify>
  <done>
- auth-check.ts exists with checkAgentAuth() exported
- app.ts imports and calls checkAgentAuth() at startup
- TypeScript build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Capture apiKeySource from init message and update .env.example</name>
  <files>server/src/agent/session-manager.ts, .env.example</files>
  <action>
1. In `server/src/agent/session-manager.ts`, find the init message capture block in `consumeStream()` (around lines 320-323):

```typescript
// Current code:
if (msg.type === "system" && msg.subtype === "init" && msg.session_id) {
  session.sdkSessionId = msg.session_id as string;
}
```

Replace with enhanced capture that also logs apiKeySource:

```typescript
if (msg.type === "system" && msg.subtype === "init") {
  if (msg.session_id) {
    session.sdkSessionId = msg.session_id as string;
  }
  // Log the auth method the SDK subprocess actually resolved (SDKA-02 runtime verification)
  if (msg.apiKeySource) {
    console.log(`[agent] Session ${session.id} auth: apiKeySource=${msg.apiKeySource}`);
  }
}
```

Key changes: (a) remove `&& msg.session_id` from outer condition so apiKeySource is logged even if session_id is somehow missing, (b) add inner `if (msg.apiKeySource)` block for runtime auth logging.

2. Update `.env.example` to document both auth methods. Replace the entire file with:

```
PORT=3000
NODE_ENV=development
SESSION_SECRET=change-me
DATA_DIR=./data
RP_ID=localhost
ORIGIN=http://localhost:3000

# --- Agent SDK Authentication ---
# Choose ONE method. If both are set, API key takes priority.
#
# Option A: API key (pay-per-token billing)
# ANTHROPIC_API_KEY=sk-ant-...
#
# Option B: Subscription auth (Claude Max quota, zero per-token cost)
# Run `claude setup-token` to generate, then paste here:
# CLAUDE_CODE_OAUTH_TOKEN=<token>
```

Do NOT modify the `.env` file itself -- it contains real credentials. Only update `.env.example`.
  </action>
  <verify>
1. `grep -n "apiKeySource" server/src/agent/session-manager.ts` shows the new logging line in consumeStream().
2. `grep "CLAUDE_CODE_OAUTH_TOKEN" .env.example` shows the subscription auth documentation.
3. `grep "ANTHROPIC_API_KEY" .env.example` shows the API key option.
4. `npm run build -w server` passes with zero TypeScript errors.
  </verify>
  <done>
- session-manager.ts captures and logs apiKeySource from SDK init messages
- .env.example documents both auth methods with "choose ONE" guidance
- TypeScript build passes
  </done>
</task>

</tasks>

<verification>
1. `npm run build -w server` completes with exit code 0
2. `cat server/src/agent/auth-check.ts` shows checkAgentAuth with both-auth warning, single-auth logging, no-auth warning
3. `grep -c "checkAgentAuth" server/src/app.ts` returns 2 (import + call)
4. `grep "apiKeySource" server/src/agent/session-manager.ts` shows runtime logging
5. `grep "CLAUDE_CODE_OAUTH_TOKEN" .env.example` shows subscription auth documentation
6. `.env` file is UNCHANGED (no credential modifications)
</verification>

<success_criteria>
- Server startup logs active auth method (API key, subscription, or none)
- Server warns when both ANTHROPIC_API_KEY and CLAUDE_CODE_OAUTH_TOKEN are set
- Runtime apiKeySource from SDK init messages is logged per session
- .env.example documents both auth methods with clear guidance
- All TypeScript builds pass cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/18-sdk-auth-cleanup/18-02-SUMMARY.md`
</output>
