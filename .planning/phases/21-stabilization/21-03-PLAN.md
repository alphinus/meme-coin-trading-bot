---
phase: 21-stabilization
plan: 03
type: execute
wave: 3
depends_on: ["21-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Every test that failed in 21-02 has been analyzed and a fix attempted"
    - "Fixed tests pass on re-verification by the human"
    - "No regressions introduced -- previously passing tests still pass"
  artifacts:
    - path: ".planning/phases/21-stabilization/21-VERIFICATION-RESULTS.md"
      provides: "Updated with re-verification results showing fixes confirmed"
      contains: "Re-verification"
  key_links:
    - from: ".planning/phases/21-stabilization/21-VERIFICATION-RESULTS.md"
      to: "source files"
      via: "Failure descriptions guide targeted code fixes"
      pattern: "FAIL"
---

<objective>
Fix all test failures identified in Plan 21-02's verification results, then have the human re-verify that the fixes work.

Purpose: STAB-02 requires all failures from the verification pass to be fixed. This is a fix-then-verify cycle: the agent analyzes each failure, implements code fixes, and the human confirms the fixes work.

Output: All previously failing tests now pass. Updated verification results document.

NOTE: This plan's `files_modified` is empty because the specific files depend on which tests failed. The agent will modify whatever files are needed based on the failure reports from 21-02. If all tests passed in 21-02, this plan completes immediately with no changes needed.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-stabilization/21-RESEARCH.md
@.planning/phases/21-stabilization/21-01-SUMMARY.md
@.planning/phases/21-stabilization/21-02-SUMMARY.md
@.planning/phases/21-stabilization/21-VERIFICATION-RESULTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze failures and implement fixes</name>
  <files>Determined by failure reports from 21-02</files>
  <action>
**If all tests passed in 21-02:** Create 21-03-SUMMARY.md noting "All 31 tests passed -- no remediation needed" and complete immediately.

**If failures exist:**

1. Read `.planning/phases/21-stabilization/21-VERIFICATION-RESULTS.md` to get the failure list
2. For each failure:
   a. Identify the root cause by reading the relevant source files
   b. Determine the minimal fix (do NOT refactor or add features -- just fix the failing behavior)
   c. Implement the fix
   d. Run TypeScript compilation to verify no errors introduced: `cd /Users/developer/eluma && npx tsc --noEmit -p client/tsconfig.json`

**Common failure patterns and fix approaches (from research):**

- **Wizard transition bug:** Check WizardShell.tsx goNext/goBack callbacks, wizardData propagation, step component key prop
- **Mode toggle not updating UI:** Check useMode hook's setMode, verify localStorage key `eluma-mode`, check ModeToggle component state
- **Command palette not opening:** Check GsdCommandPalette.tsx keyboard event listener (Cmd+K / Ctrl+K), verify isExpert guard
- **Route guard not redirecting:** Check ExpertRoute component, verify it reads from useMode and redirects to /home
- **Agent session not starting:** Check CLAUDE_CODE_OAUTH_TOKEN validity, session-manager.ts, check for auth-check errors in server logs
- **i18n key showing instead of text:** Missing key in en.json/de.json -- add the key to both locale files
- **CollapsibleSection not expanding:** Check CollapsibleSection.tsx isOpen state, default expansion logic based on mode

**Scope boundaries:**
- Do NOT fix the 17 pre-existing server TypeScript errors (Google Calendar, Gmail, Telegram menus, notification emitter)
- Do NOT add new features
- Do NOT refactor working code
- Only fix what the tests revealed as broken

3. After all fixes are implemented, update 21-VERIFICATION-RESULTS.md to note which failures were addressed and what was changed
  </action>
  <verify>
1. `cd /Users/developer/eluma && npx tsc --noEmit -p client/tsconfig.json` -- zero errors
2. Each failure has a documented fix in the verification results
3. No unrelated files were modified
  </verify>
  <done>
All identified failures have code fixes implemented. TypeScript compiles cleanly. Verification results document updated with fix descriptions.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human re-verifies fixed tests</name>
  <files>.planning/phases/21-stabilization/21-VERIFICATION-RESULTS.md</files>
  <action>
CHECKPOINT: Human re-runs previously failing tests to confirm fixes work.

What was built: Code fixes for all test failures identified in Plan 21-02. Each fix targets the specific behavior that was failing.

How to verify -- re-run ONLY the tests that previously failed:
1. Restart the dev server: `cd /Users/developer/eluma && npm run dev`
2. Open browser to http://localhost:3000
3. For each previously failing test, repeat the test steps from 21-VERIFICATION-RESULTS.md
4. Verify the fix resolves the original failure
5. Spot-check 2-3 previously passing tests to confirm no regressions

Report format:
RE-VERIFY 13-4: PASS (reconnection now works)
RE-VERIFY 16-3: PASS (Cmd+K palette opens correctly)
REGRESSION CHECK: Phase 15 tests still pass

Resume signal: Paste re-verification results. Type "all fixed" if everything now passes, or list any remaining failures.
  </action>
  <verify>Human has reported re-verification results for all previously failing tests, plus spot-checked regressions.</verify>
  <done>All previously failing tests now pass on re-verification, and no regressions detected in spot checks.</done>
</task>

<task type="auto">
  <name>Task 3: Finalize verification results and update STATE.md</name>
  <files>
    .planning/phases/21-stabilization/21-VERIFICATION-RESULTS.md
    .planning/STATE.md
  </files>
  <action>
Based on the human's re-verification results:

1. Update 21-VERIFICATION-RESULTS.md:
   - Change previously FAIL results to PASS (if confirmed fixed) or note "Still failing" with details
   - Add a "Re-Verification" section at the bottom documenting the fix-verify cycle
   - Update the Summary totals

2. Update `.planning/STATE.md`:
   - Change "Current Position" to: Phase 21 of 21 (Stabilization) -- complete
   - Update status to reflect Phase 21 completion
   - Update progress to 100% (v1.3: 4/4 phases)
   - Remove "23 human verification tests pending from v1.2" from Blockers
   - Update "Next step" to: v1.3 milestone complete -- ready for milestone audit

3. If any tests are STILL failing after the fix cycle, document them as known issues in STATE.md Blockers section with a note that they need another fix cycle.
  </action>
  <verify>
1. 21-VERIFICATION-RESULTS.md has re-verification results recorded
2. Summary totals are updated and accurate
3. STATE.md reflects Phase 21 completion (or remaining issues if any)
  </verify>
  <done>
Verification results are finalized. STATE.md updated to reflect Phase 21 status. If all tests pass: milestone v1.3 is ready for audit. If some tests still fail: remaining failures are documented as blockers for a follow-up cycle.
  </done>
</task>

</tasks>

<verification>
1. All previously failing tests now pass (or are documented as known remaining issues)
2. No regressions in previously passing tests
3. TypeScript compiles cleanly (client)
4. STATE.md accurately reflects project status
5. 21-VERIFICATION-RESULTS.md is a complete audit trail of test -> fail -> fix -> re-verify
</verification>

<success_criteria>
- Zero test failures remaining (ideal) OR all remaining failures documented with clear next steps
- No regressions introduced by fixes
- STATE.md updated to reflect Phase 21 completion status
- Verification results document is a complete record of the stabilization effort
</success_criteria>

<output>
After completion, create `.planning/phases/21-stabilization/21-03-SUMMARY.md`
</output>
