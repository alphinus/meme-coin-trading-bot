---
phase: 20-sdk-feature-adoption
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/agent/session-id.ts
  - server/src/agent/session-manager.ts
  - server/src/agent/sse-adapter.ts
  - server/src/agent/types.ts
  - client/src/hooks/useAgentStream.ts
  - client/src/components/AgentOutput.tsx
  - client/src/i18n/locales/en.json
  - client/src/i18n/locales/de.json
autonomous: true

must_haves:
  truths:
    - "When an agent session ends successfully, the UI displays 'Task complete' (EN) or 'Aufgabe abgeschlossen' (DE) as the stop reason"
    - "When an agent session hits the turn limit, the UI displays 'Maximum turns reached' as the stop reason"
    - "When an agent session hits the budget limit, the UI displays 'Budget limit reached' as the stop reason"
    - "Agent sessions for the same project always get the same deterministic session ID derived from the project ID"
    - "The deterministic session ID is a valid UUID that the SDK accepts without error"
    - "Interactive agent sessions use persistSession: true so the SDK writes session files for later recovery"
  artifacts:
    - path: "server/src/agent/session-id.ts"
      provides: "deterministicSessionId() function"
      exports: ["deterministicSessionId"]
    - path: "server/src/agent/sse-adapter.ts"
      provides: "stopReason field in result and error SSE events"
      contains: "stopReason"
    - path: "server/src/agent/types.ts"
      provides: "Updated SSE event types with stopReason"
      contains: "stopReason"
    - path: "client/src/hooks/useAgentStream.ts"
      provides: "stopReason in AgentResult interface"
      contains: "stopReason"
    - path: "client/src/components/AgentOutput.tsx"
      provides: "Stop reason chip displayed in result area"
      contains: "stop_reason"
  key_links:
    - from: "server/src/agent/sse-adapter.ts"
      to: "client/src/hooks/useAgentStream.ts"
      via: "SSE event data.stopReason field"
      pattern: "stopReason"
    - from: "client/src/hooks/useAgentStream.ts"
      to: "client/src/components/AgentOutput.tsx"
      via: "AgentResult.stopReason prop"
      pattern: "result\\.stopReason"
    - from: "server/src/agent/session-id.ts"
      to: "server/src/agent/session-manager.ts"
      via: "deterministicSessionId(projectId) import"
      pattern: "deterministicSessionId"
---

<objective>
Add stop reason surfacing and deterministic session IDs to the agent session system.

Purpose: Users currently have no indication of WHY a session ended (success, budget, turns). Also, session IDs are random UUIDs making pause/resume fragile across restarts. This plan fixes both issues.

Output: Stop reason visible in UI after every session end; deterministic session IDs from project ID; `persistSession: true` for interactive sessions enabling SDK file persistence.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-sdk-feature-adoption/20-RESEARCH.md

@server/src/agent/session-manager.ts
@server/src/agent/sse-adapter.ts
@server/src/agent/types.ts
@client/src/hooks/useAgentStream.ts
@client/src/components/AgentOutput.tsx
@client/src/i18n/locales/en.json
@client/src/i18n/locales/de.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add stop reason to SSE adapter + types, create deterministic session ID utility</name>
  <files>
    server/src/agent/session-id.ts
    server/src/agent/sse-adapter.ts
    server/src/agent/types.ts
    server/src/agent/session-manager.ts
  </files>
  <action>
**1. Create `server/src/agent/session-id.ts`:**

Create a new file with a `deterministicSessionId(projectId: string): string` function:
- Import `createHash` from `crypto`
- Hash `"eluma-agent-session:" + projectId` with SHA-256
- Format the first 32 hex chars as a valid UUID v4:
  - Positions: `xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx`
  - Set version nibble (position 12) to `4`
  - Set variant nibble (position 16) to `8|9|a|b` by doing `(parseInt(hash[16], 16) & 0x3) | 0x8`
- Export the function as a named export

**2. Update `server/src/agent/types.ts`:**

Add a `stopReason` optional field to the SSEEvent `data` typing. Since `data` is `Record<string, unknown>`, this is already flexible. No structural change needed to the SSEEvent interface itself.

Add a new exported type for stop reasons:
```typescript
/** Stop reason subtypes from the SDK result message */
export type AgentStopReason =
  | "success"
  | "error_max_turns"
  | "error_max_budget_usd"
  | "error_during_execution"
  | "error_max_structured_output_retries";
```

**3. Update `server/src/agent/sse-adapter.ts`:**

In the `case "result":` block:
- For `message.subtype === "success"`: add `stopReason: "success"` to the `data` object of the returned SSE event
- For error results: add `stopReason: message.subtype` to the `data` object (this gives "error_max_turns", "error_max_budget_usd", etc.)

The existing fields (`output`, `cost`, `duration`, `turns` for success; `message`, `subtype`, `cost`, `duration` for error) remain unchanged. Only ADD the `stopReason` field.

**4. Update `server/src/agent/session-manager.ts`:**

In the `start()` method:
- Import `deterministicSessionId` from `./session-id.js`
- Replace `const id = randomUUID()` with `const id = deterministicSessionId(projectId)`
- In the `query()` options, add `sessionId: id` so the SDK uses our deterministic ID
- Change `persistSession: false` to `persistSession: true` so the SDK writes session JSONL files for later recovery
- Remove the `randomUUID` import from `crypto` (no longer needed in start)

In the `resume()` method:
- Replace `const id = randomUUID()` with `const id = deterministicSessionId(projectId)`
- The `resume` option already uses `paused.sdkSessionId` which is correct

Keep `randomUUID` imported only if still needed elsewhere (check -- it is NOT used elsewhere in this file after both start/resume changes, so remove the import entirely).
  </action>
  <verify>
Run `npm run build` from the eluma project root -- zero TypeScript errors. Verify `session-id.ts` exists and exports `deterministicSessionId`. Verify `sse-adapter.ts` result case includes `stopReason` in both success and error branches. Verify `session-manager.ts` uses `deterministicSessionId` instead of `randomUUID` and has `persistSession: true`.
  </verify>
  <done>
SSE adapter emits `stopReason` field in result/error events. Session manager uses deterministic IDs from project ID. Interactive sessions use `persistSession: true`. All TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Display stop reason in client UI with i18n</name>
  <files>
    client/src/hooks/useAgentStream.ts
    client/src/components/AgentOutput.tsx
    client/src/i18n/locales/en.json
    client/src/i18n/locales/de.json
  </files>
  <action>
**1. Update `client/src/hooks/useAgentStream.ts`:**

Add `stopReason` field to the `AgentResult` interface:
```typescript
export interface AgentResult {
  output: string;
  cost: number;
  duration: number;
  turns: number;
  stopReason?: string;  // "success" | "error_max_turns" | "error_max_budget_usd" | etc.
}
```

In the `es.addEventListener("error", ...)` handler, also capture `stopReason` if present in the parsed data. Currently, the error handler sets `setError(data.message)`. Also check for `data.stopReason` and if the data has cost/duration fields, construct an AgentResult-like object and set it via setResult so the result area shows even on error paths:

```typescript
es.addEventListener("error", (e: MessageEvent) => {
  if (e.data) {
    const data = JSON.parse(e.data) as { message: string; stopReason?: string; cost?: number; duration?: number };
    setError(data.message);
    setStatus("error");
    setCurrentTool(null);
    // Surface stop reason and stats even on error completion
    if (data.stopReason) {
      setResult({
        output: "",
        cost: data.cost ?? 0,
        duration: data.duration ?? 0,
        turns: 0,
        stopReason: data.stopReason,
      });
    }
    es.close();
  }
});
```

**2. Update `client/src/components/AgentOutput.tsx`:**

Add a stop reason mapping constant (after the existing TOOL_LABELS):
```typescript
const STOP_REASON_KEYS: Record<string, string> = {
  success: "agent.stop_reason.success",
  error_max_turns: "agent.stop_reason.max_turns",
  error_max_budget_usd: "agent.stop_reason.budget_exceeded",
  error_during_execution: "agent.stop_reason.execution_error",
  error_max_structured_output_retries: "agent.stop_reason.output_error",
};
```

In the result area section (inside `{result && ( ... )}`), add a stop reason chip BEFORE the stats row:
```tsx
{result?.stopReason && (
  <div style={styles.stopReasonChip}>
    {t(STOP_REASON_KEYS[result.stopReason] || "agent.stop_reason.unknown")}
  </div>
)}
```

Add the `stopReasonChip` style to the styles object:
```typescript
stopReasonChip: {
  display: "inline-block",
  padding: "3px 10px",
  fontSize: "12px",
  fontWeight: 600,
  borderRadius: "12px",
  backgroundColor: "#dbeafe",
  color: "#1e40af",
  marginBottom: "8px",
},
```

For error stop reasons (non-success), use a different color. Adjust the JSX to conditionally style:
```tsx
{result?.stopReason && (
  <div style={{
    ...styles.stopReasonChip,
    ...(result.stopReason !== "success" ? {
      backgroundColor: "#fef2f2",
      color: "#991b1b",
    } : {}),
  }}>
    {t(STOP_REASON_KEYS[result.stopReason] || "agent.stop_reason.unknown")}
  </div>
)}
```

**3. Update `client/src/i18n/locales/en.json`:**

Inside the existing `"agent"` object, add these keys:
```json
"stop_reason": {
  "success": "Task complete",
  "max_turns": "Maximum turns reached",
  "budget_exceeded": "Budget limit reached",
  "execution_error": "Error during execution",
  "output_error": "Output format error",
  "unknown": "Session ended"
}
```

**4. Update `client/src/i18n/locales/de.json`:**

Inside the existing `"agent"` object, add the matching German keys:
```json
"stop_reason": {
  "success": "Aufgabe abgeschlossen",
  "max_turns": "Maximale Durchläufe erreicht",
  "budget_exceeded": "Budgetlimit erreicht",
  "execution_error": "Fehler bei der Ausführung",
  "output_error": "Ausgabeformatfehler",
  "unknown": "Sitzung beendet"
}
```

IMPORTANT: Use proper Unicode characters for German -- `ä`, `ü`, `ö`, `ß` (not ASCII approximations). The research file used `Ausfuhrung` (missing umlaut) -- use `Ausführung` instead. Similarly `Durchläufe` not `Durchlaufe`.
  </action>
  <verify>
Run `npm run build` from project root -- zero TypeScript errors. Check that `en.json` and `de.json` both have the `stop_reason` nested object inside `agent`. Verify `AgentOutput.tsx` renders the stop reason chip when `result.stopReason` is present.
  </verify>
  <done>
Stop reason appears as a styled chip in the result area of AgentOutput. Success shows blue chip "Task complete". Error subtypes show red chip with the specific reason. Both EN and DE translations present with correct Unicode umlauts.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes with zero TypeScript errors
2. `grep -r "stopReason" server/src/agent/sse-adapter.ts` returns matches in both success and error branches
3. `grep -r "deterministicSessionId" server/src/agent/session-manager.ts` confirms import and usage
4. `grep "persistSession" server/src/agent/session-manager.ts` shows `true` (not `false`)
5. `grep "stop_reason" client/src/i18n/locales/en.json` and `de.json` both return matches
6. `grep "randomUUID" server/src/agent/session-manager.ts` returns zero matches (removed)
</verification>

<success_criteria>
- SSE result events contain `stopReason: "success"` for successful sessions
- SSE error events contain `stopReason: "error_max_turns"` (or equivalent subtype) for limit-hit sessions
- Session IDs are deterministic: same projectId always produces the same session UUID
- `persistSession: true` is set for interactive agent sessions (not warm session)
- Client UI shows a labeled chip with the stop reason in both English and German
- Zero TypeScript build errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-sdk-feature-adoption/20-01-SUMMARY.md`
</output>
