---
phase: 03-documentation-engine
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - server/src/routes/projects.ts
  - server/src/routes/teams.ts
  - server/src/routes/memory.ts
  - server/src/docs/meta-soul.ts
  - server/src/routes/docs.ts
autonomous: true

must_haves:
  truths:
    - "Creating a project automatically appends a 'decision' entry to the creator's Soul Document"
    - "Advancing a project phase automatically appends a 'status_change' entry to the user's Soul Document"
    - "Adding a KPI automatically appends a 'kpi' entry to the user's Soul Document"
    - "Meta Soul Document for a team returns aggregated statistics per member with entry counts by source type"
    - "No soul_document.* events trigger further Soul Document entries (no circular loops)"
  artifacts:
    - path: "server/src/routes/projects.ts"
      provides: "processEventForDocumentation calls after project events"
      contains: "processEventForDocumentation"
    - path: "server/src/docs/meta-soul.ts"
      provides: "Meta Soul Document generation with per-member aggregation"
      exports: ["generateMetaSoulDocument"]
    - path: "server/src/routes/docs.ts"
      provides: "Updated meta routes calling generateMetaSoulDocument"
      contains: "generateMetaSoulDocument"
  key_links:
    - from: "server/src/routes/projects.ts"
      to: "server/src/docs/writer.ts"
      via: "processEventForDocumentation called after each appendEvent"
      pattern: "processEventForDocumentation"
    - from: "server/src/docs/meta-soul.ts"
      to: "server/src/events/reducers/soul-document.ts"
      via: "getAllSoulDocumentEntries for team-wide aggregation"
      pattern: "getAllSoulDocumentEntries"
    - from: "server/src/routes/docs.ts"
      to: "server/src/docs/meta-soul.ts"
      via: "GET /meta/:teamId calls generateMetaSoulDocument"
      pattern: "generateMetaSoulDocument"
---

<objective>
Wire the DocumentWriter into existing event-producing routes so domain events automatically generate Soul Document entries, and build the Meta Soul Document generation logic.

Purpose: This fulfills DOCS-04 ("every decision, assumption, status change, KPI evaluation triggers an immediate append-only write") and DOCS-03 (Meta Soul Document data aggregation). Without this wiring, Soul Documents would only grow from manual user input.

Output: Existing route handlers call processEventForDocumentation after domain events; Meta Soul Document endpoint returns structured aggregation per team member.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-documentation-engine/03-RESEARCH.md
@.planning/phases/03-documentation-engine/03-01-SUMMARY.md

@server/src/routes/projects.ts
@server/src/routes/teams.ts
@server/src/routes/memory.ts
@server/src/docs/writer.ts
@server/src/events/reducers/soul-document.ts
@server/src/events/reducers/team.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire processEventForDocumentation into existing route handlers</name>
  <files>
    server/src/routes/projects.ts
    server/src/routes/teams.ts
    server/src/routes/memory.ts
  </files>
  <action>
Add `processEventForDocumentation` calls to every route that emits domain events. Import from `"../docs/writer.js"`.

**server/src/routes/projects.ts** -- After each `appendEvent()` call, add `processEventForDocumentation(event)` where `event` is the return value of appendEvent. This applies to:
- POST / (project.created)
- PUT /:id (project.updated)
- POST /:id/advance (both project.phase_completed and project.phase_advanced)
- POST /:id/kpi (project.roi_kpi_added)
The project.archived event (auto-archive on review_extraction) also needs the call.

**server/src/routes/teams.ts** -- After each appendEvent call:
- POST / (team.created -- documents "Created team {name}")
- POST /:id/members (team.member_added -- documents "Added member to team")

**server/src/routes/memory.ts** -- After each appendEvent call:
- POST /projects/:projectId/files (memory.file_created -- documents "Created file in project memory")
- PUT /projects/:projectId/files/:fileName (memory.file_updated -- can skip, too noisy for Soul Documents)

NOTE on future phase integration: The EVENT_TO_ENTRY_MAP in writer.ts (built in Plan 01) currently maps only the domain events listed above. Two EntrySourceType values are intentionally unmapped at this stage:
- "audio" source type: Will be wired in Phase 6 (Voice & Idea Pool) when voice input events are available. Phase 6 will add audio event types and corresponding mappings to EVENT_TO_ENTRY_MAP.
- "ai_reflection" source type: Will be wired in Phase 4 (AI Foundation) when AI analysis events are available. Phase 4 will add AI reflection event types and corresponding mappings to EVENT_TO_ENTRY_MAP.
These source types exist in the type system for forward-compatibility but have no event producers yet.

IMPORTANT: The `processEventForDocumentation` function already has the circular loop guard (ignores soul_document.* events). No additional guards needed in route handlers. The function is fire-and-forget -- do NOT await it or handle errors from it. Document entries are best-effort; a failed documentation write should never break the primary operation.

Pattern for each route:
```typescript
const event = appendEvent({ ... });
processEventForDocumentation(event); // Fire-and-forget Soul Document entry
res.json({ success: true, data: ... });
```
  </action>
  <verify>
    1. Run `cd /Users/developer/eluma && npx tsc --build --noEmit` -- must compile cleanly.
    2. Check that `processEventForDocumentation` is imported in all 3 route files using grep.
    3. Count the number of processEventForDocumentation calls -- should be at least 6 (project.created, project.updated, project.phase_completed, project.phase_advanced, project.roi_kpi_added, project.archived, team.created, team.member_added, memory.file_created).
  </verify>
  <done>
    - All project event-producing routes call processEventForDocumentation after appendEvent
    - Team creation and member addition routes call processEventForDocumentation
    - Memory file creation calls processEventForDocumentation
    - All calls are fire-and-forget (no await, no error handling that blocks primary operation)
    - TypeScript compiles cleanly
    - Audio event mappings deferred to Phase 6, AI reflection event mappings deferred to Phase 4 (documented in writer.ts EVENT_TO_ENTRY_MAP comments)
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Meta Soul Document generation and update docs API routes</name>
  <files>
    server/src/docs/meta-soul.ts
    server/src/routes/docs.ts
  </files>
  <action>
1. **server/src/docs/meta-soul.ts** -- Create the Meta Soul Document generator:
   - `generateMetaSoulDocument(teamId: string): Promise<MetaSoulDocument>` --
     (a) Get team state via `getTeamById(teamId)` from `../events/reducers/team.js`. Throw if team not found.
     (b) Get user display names by importing `getUserById` (or reading user events) from `../events/reducers/user.js`.
     (c) For each team member, call `getSoulDocumentEntries(member.userId)` from the reducer.
     (d) Filter to non-deleted entries only.
     (e) Build `entriesBySourceType`: a Record<string, number> counting entries per source type.
     (f) Get `recentEntries`: last 10 entries sorted by timestamp.
     (g) Build the MetaSoulDocument object:
        - teamId, generatedAt (ISO string)
        - members array with userId, displayName, totalEntries, entriesBySourceType, recentEntries
        - patterns: empty array (Phase 4 will populate via AI analysis). Add a comment: `// Phase 4: AI will populate patterns here`
     (h) Optionally emit a `soul_document.meta_generated` event for audit tracking (using appendEvent with aggregateType "soul_document", aggregateId = teamId).

   Helper: `groupBySourceType(entries: SoulDocumentEntry[]): Record<string, number>` -- reduce entries into a count-by-sourceType map.

2. **server/src/routes/docs.ts** -- Update the placeholder meta routes from Plan 01:
   - `GET /meta/:teamId` -- call `generateMetaSoulDocument(teamId)`. Return `{ success: true, data: MetaSoulDocument }`. Validate that the requesting user is a member of the team (check via getTeamForUser or compare teamId with user's team).
   - `POST /meta/:teamId/generate` -- same logic but explicitly regenerates (force-refresh). Returns the same MetaSoulDocument structure.
   - Add error handling: if team not found return 404, if user not in team return 403.
  </action>
  <verify>
    1. Run `cd /Users/developer/eluma && npx tsc --build --noEmit` -- must compile cleanly.
    2. Verify server/src/docs/meta-soul.ts exists and exports generateMetaSoulDocument.
    3. Verify server/src/routes/docs.ts imports and uses generateMetaSoulDocument.
  </verify>
  <done>
    - generateMetaSoulDocument returns a MetaSoulDocument with per-member stats (entry counts by source type, recent entries, total counts)
    - patterns array is empty with comment indicating Phase 4 will add AI analysis
    - GET /meta/:teamId returns the generated MetaSoulDocument
    - POST /meta/:teamId/generate forces regeneration
    - Team membership validation prevents unauthorized access
  </done>
</task>

</tasks>

<verification>
- `npx tsc --build --noEmit` passes with zero errors
- grep confirms processEventForDocumentation is called in projects.ts, teams.ts, memory.ts
- server/src/docs/meta-soul.ts exists with generateMetaSoulDocument export
- Meta routes in docs.ts call generateMetaSoulDocument instead of placeholder logic
</verification>

<success_criteria>
Domain events from project/team/memory operations automatically produce Soul Document entries via the DocumentWriter. The Meta Soul Document endpoint aggregates entries across all team members with entry counts by source type and recent entries. No circular event loops exist. Audio and AI reflection source types are documented as future integration points (Phase 6 and Phase 4 respectively).
</success_criteria>

<output>
After completion, create `.planning/phases/03-documentation-engine/03-02-SUMMARY.md`
</output>
