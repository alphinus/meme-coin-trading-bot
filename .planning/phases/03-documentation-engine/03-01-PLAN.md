---
phase: 03-documentation-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/types/events.ts
  - shared/types/models.ts
  - server/src/events/reducers/soul-document.ts
  - server/src/docs/types.ts
  - server/src/docs/writer.ts
  - server/src/docs/soul-document.ts
  - server/src/routes/docs.ts
  - server/src/app.ts
autonomous: true

must_haves:
  truths:
    - "Soul Document events (entry_added, entry_deleted, entry_manual, meta_generated) are recognized by the event store"
    - "A Soul Document entry can be written via API and persists in both JSONL events and a Markdown file on disk"
    - "Soft-deleting an entry marks it deleted in events and regenerates the Markdown file without the deleted entry"
    - "GET /api/docs/soul/:userId returns all entries with deleted status"
    - "The DocumentWriter converts domain events into Soul Document entries without circular loops"
  artifacts:
    - path: "shared/types/events.ts"
      provides: "Soul document event types in EventType union and EVENT_TYPES array"
      contains: "soul_document.entry_added"
    - path: "shared/types/models.ts"
      provides: "SoulDocumentEntry, EntrySourceType, MetaSoulDocument interfaces"
      contains: "EntrySourceType"
    - path: "server/src/events/reducers/soul-document.ts"
      provides: "Soul document reducer and query functions"
      exports: ["reduceSoulDocumentState", "getSoulDocumentEntries"]
    - path: "server/src/docs/writer.ts"
      provides: "DocumentWriter that maps domain events to Soul Document entries"
      exports: ["writeSoulDocumentEntry", "processEventForDocumentation"]
    - path: "server/src/docs/soul-document.ts"
      provides: "CRUD operations for Soul Documents including soft-delete and Markdown regeneration"
      exports: ["softDeleteEntry", "getSoulDocumentEntries", "regenerateMarkdownFile"]
    - path: "server/src/routes/docs.ts"
      provides: "API routes for Soul Document CRUD"
      exports: ["default"]
    - path: "server/src/app.ts"
      provides: "Docs router wired at /api/docs"
      contains: "docsRouter"
  key_links:
    - from: "server/src/docs/writer.ts"
      to: "server/src/events/store.ts"
      via: "appendEvent call for soul_document.entry_added events"
      pattern: "appendEvent.*soul_document"
    - from: "server/src/docs/writer.ts"
      to: "server/src/fs/paths.ts"
      via: "resolvePath + getMemoryDir for Markdown file writes"
      pattern: "getMemoryDir|resolvePath"
    - from: "server/src/docs/soul-document.ts"
      to: "server/src/events/store.ts"
      via: "readEvents for soul_document aggregate"
      pattern: "readEvents.*soul_document"
    - from: "server/src/routes/docs.ts"
      to: "server/src/docs/soul-document.ts"
      via: "Route handlers calling CRUD functions"
      pattern: "getSoulDocumentEntries|softDeleteEntry"
---

<objective>
Build the complete backend foundation for Soul Documents: shared types, event-sourced reducer, DocumentWriter service with dual JSONL+Markdown writes, GDPR soft-delete logic, and API routes.

Purpose: This is the data layer that everything in Phase 3 builds on. Without these types, reducer, and API endpoints, neither the event integration (Plan 02) nor the client UI (Plan 03) can function.

Output: 8 files -- extended shared types, soul-document reducer, docs/ service module (types, writer, soul-document CRUD), API routes at /api/docs/*, wired into Express app.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-documentation-engine/03-RESEARCH.md

@shared/types/events.ts
@shared/types/models.ts
@server/src/events/store.ts
@server/src/events/reducers/project.ts
@server/src/events/reducers/team.ts
@server/src/fs/paths.ts
@server/src/fs/memory.ts
@server/src/fs/git.ts
@server/src/app.ts
@server/src/routes/projects.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Soul Document types to shared package and create event-sourced reducer</name>
  <files>
    shared/types/events.ts
    shared/types/models.ts
    server/src/events/reducers/soul-document.ts
    server/src/docs/types.ts
  </files>
  <action>
1. **shared/types/events.ts** -- Add 4 new event types to the EventType union and EVENT_TYPES array:
   - `"soul_document.entry_added"` -- auto or manual entry created
   - `"soul_document.entry_deleted"` -- GDPR soft-delete
   - `"soul_document.entry_manual"` -- user manually wrote to their Soul Document
   - `"soul_document.meta_generated"` -- Meta Soul Document was regenerated
   Place them after the existing `memory.*` events, before `system.*`.

2. **shared/types/models.ts** -- Add at the end of the file:
   - `EntrySourceType` type union: `"text" | "audio" | "decision" | "ai_reflection" | "status_change" | "kpi" | "pattern_match" | "override" | "assumption"`
   - `SoulDocumentEntry` interface with fields: entryId (string), userId (string), teamId (string), projectId (string optional), sourceType (EntrySourceType), content (string), triggerEventId (string), triggerEventType (string), timestamp (string), deleted (boolean), deletedAt (string optional), deletedBy (string optional)
   - `MetaSoulDocument` interface with fields: teamId (string), generatedAt (string), members (array of {userId, displayName, totalEntries, entriesBySourceType: Record<string, number>, recentEntries: SoulDocumentEntry[]}), patterns (array of {type: "thinking_error"|"bias"|"abort_pattern"|"over_engineering"|"under_engineering", description: string, affectedMembers: string[], evidence: string[], detectedAt: string})

3. **server/src/docs/types.ts** -- Create internal server-side types:
   - `WriteSoulDocumentInput` interface (omits entryId and deleted from SoulDocumentEntry -- these are generated server-side)
   - Re-export EntrySourceType from shared for convenience

4. **server/src/events/reducers/soul-document.ts** -- Create following the exact pattern of project.ts and team.ts:
   - `reduceSoulDocumentState(events: DomainEvent[])` -- builds a Map of entryId -> SoulDocumentEntry, tracking deletions via a Set of deleted entryIds. Returns the array of all entries (with `deleted` flag set correctly).
   - `getSoulDocumentEntries(userId: string)` -- reads events for soul_document aggregate filtered by aggregateId=userId, sorts chronologically, reduces to entries array.
   - `getAllSoulDocumentEntries(teamId: string)` -- reads ALL soul_document events, reduces, then filters by teamId. Used for Meta Soul Document.
   - `getSoulDocumentVersion(userId: string)` -- counts events for optimistic concurrency (same pattern as `getCurrentVersion` in project.ts).
   Import from `"../store.js"` for readEvents (matching existing reducer import pattern).
  </action>
  <verify>
    Run `cd /Users/developer/eluma && npx tsc --build --noEmit` to confirm all types compile cleanly with no errors. Verify the new files exist at their expected paths.
  </verify>
  <done>
    - 4 new event types in EventType union and EVENT_TYPES array
    - SoulDocumentEntry, EntrySourceType, MetaSoulDocument in shared/types/models.ts
    - Soul document reducer with getSoulDocumentEntries, getAllSoulDocumentEntries functions
    - All existing code still compiles (no regressions)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DocumentWriter service, Soul Document CRUD, API routes, and wire into Express</name>
  <files>
    server/src/docs/writer.ts
    server/src/docs/soul-document.ts
    server/src/routes/docs.ts
    server/src/app.ts
  </files>
  <action>
1. **server/src/docs/writer.ts** -- The DocumentWriter service:
   - `writeSoulDocumentEntry(input: WriteSoulDocumentInput): DomainEvent` -- Dual-write pattern:
     (a) Call `appendEvent()` with type "soul_document.entry_added", aggregateType "soul_document", aggregateId = input.userId, correlationId = input.triggerEventId, data containing entryId (randomUUID), teamId, projectId, sourceType, content, triggerEventId, triggerEventType.
     (b) Call `appendToMarkdownFile()` to append a formatted section to the user's Markdown Soul Document.
   - `appendToMarkdownFile(userId, teamId, sourceType, content, timestamp)` -- private function:
     (a) Use `getMemoryDir()` from `../fs/paths.js` to get memory directory.
     (b) Use `resolvePath(memDir, "_soul_documents")` for the soul docs directory. Call `ensureDir()` on it.
     (c) Build file path as `resolvePath(soulDocDir, "${userId}.md")`.
     (d) If file does not exist, write a header first: frontmatter with type, userId, created date, followed by `# Soul Document: {userId}` heading and description.
     (e) Append formatted entry: `\n---\n\n**[{dateStr}]** _{sourceType}_\n\n{content}\n` using `appendFileSync`.
     (f) Call `scheduleCommit(filePath)` from `../fs/git.js` for Git versioning.
     Format dates using `toLocaleDateString("de-CH", { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" })`.
   - `processEventForDocumentation(event: DomainEvent): void` -- Event listener:
     (a) Build an EVENT_TO_ENTRY_MAP (Record<string, mapper function>) mapping domain event types to Soul Document entry generators. Cover: `project.created` (sourceType: decision), `project.phase_completed` (sourceType: status_change), `project.phase_advanced` (sourceType: status_change), `project.roi_kpi_added` (sourceType: kpi), `project.archived` (sourceType: status_change), `team.member_added` (sourceType: decision), `memory.file_created` (sourceType: text).
     (b) CRITICAL: Ignore ALL `soul_document.*` events to prevent circular loops.
     (c) Look up the mapper, call it, if it returns content then call `writeSoulDocumentEntry()`.
     (d) Resolve teamId by importing `getTeamForUser` from `../events/reducers/team.js`. Cache the result in a module-level `Map<string, string>` (userId -> teamId) since there are only 2 users.

2. **server/src/docs/soul-document.ts** -- CRUD operations:
   - `getEntries(userId: string)` -- calls `getSoulDocumentEntries(userId)` from the reducer. Returns active (non-deleted) entries.
   - `getAllEntries(userId: string)` -- same but returns ALL entries including deleted ones (for admin/audit).
   - `addManualEntry(userId: string, teamId: string, content: string)` -- writes a manual entry with sourceType "text", triggerEventType "soul_document.entry_manual". Uses appendEvent for the trigger event first, then calls writeSoulDocumentEntry.
   - `softDeleteEntry(userId: string, entryId: string, deletedBy: string)` -- appends a `soul_document.entry_deleted` event, then calls `regenerateMarkdownFile(userId)`.
   - `regenerateMarkdownFile(userId: string)` -- reads all non-deleted entries via the reducer, writes a fresh Markdown file from scratch (header + all entries in chronological order). Uses `writeFile` (async, from fs/promises) since this is a full rewrite not an append. Calls `scheduleCommit()`.
   - `getMarkdownContent(userId: string)` -- reads the Markdown file from disk and returns it as a string. Returns empty string if file doesn't exist.

3. **server/src/routes/docs.ts** -- Express router with these routes:
   - `GET /soul/:userId` -- returns entries (non-deleted) via getEntries(). Response: `{ success: true, data: SoulDocumentEntry[] }`.
   - `POST /soul/:userId/entry` -- body: `{ content: string }` validated by Zod (min 1 char, max 5000 chars). Calls addManualEntry(). Resolves teamId from `getTeamForUser(req.session.userId)`. Response: `{ success: true, data: event }`.
   - `DELETE /soul/:userId/:entryId` -- calls softDeleteEntry(). Only allows if req.session.userId === params.userId (owner-only delete). Response: `{ success: true, data: { deleted: true } }`.
   - `GET /soul/:userId/markdown` -- calls getMarkdownContent(). Response: `{ success: true, data: { content: string } }`.
   - `GET /meta/:teamId` -- placeholder that returns basic aggregation (calls getAllSoulDocumentEntries, groups by member). Full implementation in Plan 02.
   - `POST /meta/:teamId/generate` -- placeholder that regenerates and returns Meta Soul Document.
   Use `validate()` middleware from `../middleware/validate.js` for Zod schemas, matching the pattern in projects.ts.

4. **server/src/app.ts** -- Add import for docsRouter and wire it:
   - `import docsRouter from "./routes/docs.js";`
   - `app.use("/api/docs", requireAuth, docsRouter);` -- place after the projects router line.
  </action>
  <verify>
    1. Run `cd /Users/developer/eluma && npx tsc --build --noEmit` -- must compile cleanly.
    2. Run `cd /Users/developer/eluma && npm run dev &` then after 3s:
       - `curl -s http://localhost:3000/api/health` returns 200
       - Check that the server starts without errors related to docs routes
    3. Kill the dev server.
  </verify>
  <done>
    - DocumentWriter service writes entries to both JSONL event store and Markdown files in data/memory/_soul_documents/
    - API routes at /api/docs/soul/:userId, /api/docs/soul/:userId/entry, /api/docs/soul/:userId/:entryId, /api/docs/soul/:userId/markdown, /api/docs/meta/:teamId exist and respond
    - Soft-delete marks entries as deleted and regenerates Markdown excluding deleted entries
    - processEventForDocumentation() maps 7 domain event types to Soul Document entries without circular loops
    - Express app serves docs routes at /api/docs with requireAuth middleware
  </done>
</task>

</tasks>

<verification>
- `npx tsc --build --noEmit` passes with zero errors
- Server starts cleanly with docs routes registered
- shared/types/events.ts contains 4 new soul_document.* event types
- shared/types/models.ts contains SoulDocumentEntry, EntrySourceType, MetaSoulDocument
- server/src/docs/ directory contains types.ts, writer.ts, soul-document.ts
- server/src/routes/docs.ts defines all 6 API endpoints
- server/src/app.ts imports and wires docsRouter at /api/docs
</verification>

<success_criteria>
The complete backend for Soul Documents is operational: types compile, reducer builds state from events, DocumentWriter creates dual JSONL+Markdown entries, CRUD operations work including GDPR soft-delete with Markdown regeneration, and all API endpoints are wired into Express.
</success_criteria>

<output>
After completion, create `.planning/phases/03-documentation-engine/03-01-SUMMARY.md`
</output>
