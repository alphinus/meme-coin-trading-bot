---
phase: 01-foundation-authentication
plan: 04
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - server/src/routes/teams.ts
  - server/src/events/reducers/team.ts
  - server/src/events/reducers/user.ts
  - client/src/pages/Dashboard.tsx
  - client/src/components/ActivityFeed.tsx
  - client/src/components/TeamManager.tsx
  - client/src/components/InviteForm.tsx
  - client/src/hooks/useTeam.ts
  - client/src/hooks/useEvents.ts
  - shared/types/models.ts
autonomous: true

must_haves:
  truths:
    - "User can create a team with a name"
    - "User can invite another user to their team by email/username"
    - "All team members see all projects within their team (open visibility)"
    - "Activity feed shows recent events as a timeline of who did what, when"
    - "Dashboard displays team info, member list, and activity feed"
  artifacts:
    - path: "server/src/routes/teams.ts"
      provides: "Team CRUD and invite API endpoints"
      exports: ["teamsRouter"]
    - path: "server/src/events/reducers/team.ts"
      provides: "Team state projection from events"
      exports: ["reduceTeamState"]
    - path: "client/src/pages/Dashboard.tsx"
      provides: "Main dashboard with team info and activity feed"
      min_lines: 60
    - path: "client/src/components/ActivityFeed.tsx"
      provides: "Event timeline component"
      min_lines: 40
    - path: "client/src/components/TeamManager.tsx"
      provides: "Team creation and member management UI"
      min_lines: 30
    - path: "client/src/hooks/useTeam.ts"
      provides: "Team state management hook"
      exports: ["useTeam"]
  key_links:
    - from: "server/src/routes/teams.ts"
      to: "server/src/events/store.ts"
      via: "emits team.created, team.member_added events"
      pattern: "appendEvent.*team\\."
    - from: "server/src/routes/teams.ts"
      to: "server/src/events/reducers/team.ts"
      via: "projects team state from events"
      pattern: "reduceTeamState"
    - from: "client/src/components/ActivityFeed.tsx"
      to: "/api/events"
      via: "fetches activity feed"
      pattern: "api/events"
    - from: "client/src/pages/Dashboard.tsx"
      to: "client/src/components/ActivityFeed.tsx"
      via: "renders activity feed on dashboard"
      pattern: "ActivityFeed"
    - from: "client/src/pages/Dashboard.tsx"
      to: "client/src/components/TeamManager.tsx"
      via: "renders team management panel"
      pattern: "TeamManager"
---

<objective>
Implement team management (create, invite, member list) and the main dashboard with an activity feed timeline.

Purpose: Elvis and Mario need to form a team and see what each other is doing. The activity feed is the team awareness mechanism -- showing who did what, when (per user decision). Open visibility means all team members see everything (AUTH-04).
Output: Working team creation, member invitation, dashboard with activity timeline, and open-visibility project listing foundation.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-CONTEXT.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Team management API with event-sourced state</name>
  <files>
    server/src/routes/teams.ts
    server/src/events/reducers/team.ts
    server/src/events/reducers/user.ts
    shared/types/models.ts
  </files>
  <action>
    server/src/events/reducers/team.ts:
    - Define TeamState interface: { id, name, ownerId, members: Array<{userId, role, joinedAt}>, createdAt, updatedAt }
    - reduceTeamState(events: DomainEvent[]): TeamState -- reducer that processes team events:
      - "team.created": initializes team state
      - "team.member_added": adds member to members array
      - "team.member_removed": removes member
      - "team.updated": updates name or other fields
    - getTeamById(teamId: string): TeamState | null -- reads events for team aggregate, reduces to current state
    - getTeamForUser(userId: string): TeamState | null -- finds team containing user as member (scans all team events -- fine for small scale)

    server/src/events/reducers/user.ts:
    - Helper to get user's team membership from events
    - getUserTeamId(userId: string): string | null

    server/src/routes/teams.ts:
    - POST /api/teams -- Create team. Accepts { name }. Creates team with current user as owner/member. Emits "team.created" event with { name, ownerId }. Emits "team.member_added" for the creator. Returns team state.
    - GET /api/teams/current -- Get current user's team (open visibility: returns full team with all members)
    - POST /api/teams/invite -- Invite member. Accepts { username or email }. Looks up user by username. If user exists, adds them to team immediately. Emits "team.member_added" event. If user doesn't exist, store a pending invite (as an event "team.invite_created" with the email/username). Returns success.
    - GET /api/teams/members -- List all team members with their display names
    - All team endpoints require auth (requireAuth middleware).

    Update shared/types/models.ts:
    - Add TeamMember interface: { userId, role: 'owner' | 'member', joinedAt }
    - Add Invite interface: { id, teamId, inviteeUsername, status: 'pending' | 'accepted', createdAt }

    IMPORTANT: Open visibility (AUTH-04) means team membership grants access to ALL projects within the team. No per-project access control. This is enforced by checking team membership in route middleware.

    Add a teamMember middleware: checks that the authenticated user belongs to the requested team. Apply to team-scoped routes.
  </action>
  <verify>
    1. `npx tsc --noEmit` compiles without errors
    2. Register two users (elvis and mario) via /api/auth/register
    3. As elvis: `curl -X POST /api/teams -d '{"name":"Eluma"}' -b cookies-elvis.txt` -- creates team
    4. As elvis: `curl -X POST /api/teams/invite -d '{"username":"mario"}' -b cookies-elvis.txt` -- invites mario
    5. As mario: `curl /api/teams/current -b cookies-mario.txt` -- sees the Eluma team with both members
    6. Verify events: `cat data/events/team.jsonl` shows team.created and team.member_added events with correlation IDs
  </verify>
  <done>
    Team can be created, members invited, and team state is derived from events. Open visibility is enforced at the team level. All team mutations emit events with correlation IDs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Dashboard page with activity feed and team panel</name>
  <files>
    client/src/pages/Dashboard.tsx
    client/src/components/ActivityFeed.tsx
    client/src/components/TeamManager.tsx
    client/src/components/InviteForm.tsx
    client/src/hooks/useTeam.ts
    client/src/hooks/useEvents.ts
  </files>
  <action>
    client/src/hooks/useTeam.ts:
    - useTeam() hook: fetches current team from GET /api/teams/current
    - Exposes: team (TeamState | null), members, loading, error
    - createTeam(name): POST /api/teams
    - inviteMember(username): POST /api/teams/invite
    - If user has no team yet, team is null (triggers team creation flow)

    client/src/hooks/useEvents.ts:
    - useEvents(options?: { limit?, since? }) hook
    - Fetches activity feed from GET /api/events
    - Exposes: events (DomainEvent[]), loading, error, refresh()
    - Auto-refresh every 30 seconds (simple polling -- sufficient for 2 users)
    - Optional: filter events by type

    client/src/components/ActivityFeed.tsx:
    - Renders a vertical timeline of events
    - Each event shows: timestamp (relative, e.g., "5 min ago"), user display name, event description in human-readable form
    - Event type to description mapping: "user.created" -> "joined the platform", "team.created" -> "created team {name}", "team.member_added" -> "added {member} to the team", etc.
    - All text through t() translation function (both DE and EN mappings for event descriptions)
    - Empty state: friendly message "No activity yet" when no events
    - Shows latest 20 events by default with "Load more" button

    client/src/components/TeamManager.tsx:
    - If no team exists: shows "Create Team" form (name input + submit)
    - If team exists: shows team name, member list with avatars/initials and roles
    - "Invite Member" button opens InviteForm

    client/src/components/InviteForm.tsx:
    - Simple form: username/email input + "Send Invite" button
    - Shows success ("Invitation sent") or error feedback
    - All text translated

    client/src/pages/Dashboard.tsx:
    - Main authenticated page
    - Layout: two-column on desktop (team panel left, activity feed right), single column on mobile
    - Header section: "Welcome, {displayName}" with team name
    - Left/top panel: TeamManager component
    - Right/bottom panel: ActivityFeed component
    - Clean, calm styling per project vision (not playful -- professional, minimal)
    - All text translated via useTranslation()

    Update de.json and en.json with:
    - dashboard.* keys for welcome, section titles
    - activity.* keys for event type descriptions
    - team.* keys for team management labels
  </action>
  <verify>
    1. `npx tsc --noEmit` compiles without errors
    2. Start app, log in as elvis
    3. Dashboard shows "Create Team" prompt (no team yet)
    4. Create team "Eluma" -- team panel updates to show team with elvis as owner
    5. Invite mario -- shows success message
    6. Activity feed shows events: "elvis created team Eluma", "elvis added mario to the team"
    7. Log in as mario in another browser/incognito -- mario sees the same team and activity feed
    8. Switch language to English -- all dashboard text switches to English
    9. Switch language to German -- all text switches to German
  </verify>
  <done>
    Dashboard displays team information and activity feed. Team creation and member invitation work through the UI. Activity feed shows recent events as a human-readable timeline. Both users see the same data (open visibility). All text is translated in DE and EN.
  </done>
</task>

</tasks>

<verification>
- Team creation works through both API and UI
- Member invitation adds existing users to the team
- Activity feed shows events as a timeline
- Dashboard renders team panel and activity feed
- All text is translated in German and English
- Open visibility: both team members see all data
</verification>

<success_criteria>
1. User can create a team from the dashboard
2. User can invite another user by username
3. Both team members see the same projects and activity (AUTH-04)
4. Activity feed shows who did what, when as a timeline
5. All team/dashboard events are recorded in the event store with correlation IDs
6. Dashboard text renders correctly in both DE and EN
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-04-SUMMARY.md`
</output>
