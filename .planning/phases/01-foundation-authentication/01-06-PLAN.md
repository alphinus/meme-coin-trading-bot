---
phase: 01-foundation-authentication
plan: 06
type: execute
wave: 4
depends_on: ["01-04", "01-05"]
files_modified:
  - server/src/routes/github.ts
  - server/src/system/discovery.ts
  - server/src/system/config.ts
  - server/src/routes/system.ts
  - client/src/pages/Setup.tsx
  - client/src/components/SetupWizard/Step1Account.tsx
  - client/src/components/SetupWizard/Step2Team.tsx
  - client/src/components/SetupWizard/Step3System.tsx
  - client/src/hooks/useSystemCapabilities.ts
autonomous: true
user_setup:
  - service: cloudflare-tunnel
    why: "Remote access to local app via HTTPS"
    env_vars:
      - name: TUNNEL_TOKEN
        source: "Cloudflare Zero Trust dashboard -> Tunnels -> Create tunnel -> copy token"
    dashboard_config:
      - task: "Create Cloudflare account and set up tunnel"
        location: "https://one.dash.cloudflare.com -> Networks -> Tunnels"

must_haves:
  truths:
    - "Per-project GitHub repositories can be auto-created using the host machine's gh CLI"
    - "Setup wizard scans the host OS and shows discovered programs/capabilities"
    - "Setup wizard has 3 steps: Account, Team, System scan"
    - "Discovered capabilities show toggle switches for permissions"
    - "GitHub repo creation is only available when gh CLI is detected as installed"
  artifacts:
    - path: "server/src/routes/github.ts"
      provides: "GitHub repo creation API using gh CLI"
      exports: ["githubRouter"]
    - path: "server/src/system/discovery.ts"
      provides: "OS capability scanner"
      exports: ["discoverCapabilities"]
    - path: "server/src/system/config.ts"
      provides: "System configuration persistence"
      exports: ["loadSystemConfig", "saveSystemConfig"]
    - path: "client/src/pages/Setup.tsx"
      provides: "3-step setup wizard page"
      min_lines: 40
    - path: "client/src/components/SetupWizard/Step3System.tsx"
      provides: "System capability display with toggles"
      min_lines: 50
  key_links:
    - from: "server/src/routes/github.ts"
      to: "gh CLI"
      via: "child_process.execSync to run gh repo create"
      pattern: "execSync.*gh repo create"
    - from: "server/src/system/discovery.ts"
      to: "child_process"
      via: "which/command -v to detect installed programs"
      pattern: "execSync.*which"
    - from: "client/src/pages/Setup.tsx"
      to: "/api/system/capabilities"
      via: "fetches discovered capabilities"
      pattern: "api/system"
    - from: "server/src/routes/github.ts"
      to: "server/src/events/store.ts"
      via: "emits project.github_repo_created event"
      pattern: "appendEvent.*github"
---

<objective>
Implement per-project GitHub repository auto-creation and the first-launch setup wizard with system capability discovery.

Purpose: GitHub repos are auto-created using the host machine's credentials (INFRA-06). The setup wizard provides a guided first-launch experience that scans the system and sets up the app (per user decision: 3-step essential wizard).
Output: Working GitHub repo creation via gh CLI, system capability scanner, and 3-step setup wizard UI.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-CONTEXT.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-02-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: GitHub repo auto-creation and system capability discovery (server)</name>
  <files>
    server/src/routes/github.ts
    server/src/system/discovery.ts
    server/src/system/config.ts
    server/src/routes/system.ts
  </files>
  <action>
    server/src/system/discovery.ts:
    - Programs to detect (organized by category):
      - cli: git, gh (GitHub CLI), node, npm, python3, curl, wget, ssh, docker, pm2, cloudflared
      - editor: code (VS Code), vim, nano, emacs, subl (Sublime)
      - browser: google-chrome / "Google Chrome" (macOS), firefox
      - media: ffmpeg, ffprobe
      - ai: claude (Anthropic CLI -- future use)
    - discoverCapabilities(): Capability[] -- iterates programs, runs `which {binary}` (or `command -v` as fallback), gets version where possible via `{binary} --version`. Returns array of Capability objects with: name, category, installed (boolean), path, version.
    - On macOS: use `open -Ra "{AppName}" 2>/dev/null` for GUI apps (Chrome, Firefox) since `which` doesn't find .app bundles
    - discoverGitHubAuth(): { authenticated: boolean, username?: string } -- runs `gh auth status` to check if gh CLI is authenticated. Returns parsed result.

    server/src/system/config.ts:
    - SystemConfig interface: { capabilities: Capability[], enabledCapabilities: string[] (names), claudeApiKey?: string, setupComplete: boolean, discoveredAt: string }
    - loadSystemConfig(): SystemConfig | null -- reads from `{DATA_DIR}/system/config.json`
    - saveSystemConfig(config: SystemConfig): void -- writes to `{DATA_DIR}/system/config.json`
    - isSetupComplete(): boolean -- checks if config exists and setupComplete is true

    server/src/routes/system.ts:
    - GET /api/system/capabilities -- runs discoverCapabilities(), returns results. If config already saved, returns cached capabilities with enabled status.
    - POST /api/system/capabilities -- save enabled capabilities selection. Body: { enabled: string[], claudeApiKey?: string }. Saves config. Emits "system.config_updated" event. Sets setupComplete to true.
    - GET /api/system/status -- returns { setupComplete, hasUsers } for app state detection
    - GET /api/system/github/status -- returns GitHub auth status via discoverGitHubAuth()
    - All system routes require auth EXCEPT GET /api/system/status (needed before login to detect first launch)

    server/src/routes/github.ts:
    - POST /api/github/repos -- Create a GitHub repo. Body: { name, description?, private: boolean (default true) }.
      - First checks gh CLI availability via discovery
      - Runs: `gh repo create {name} --{public|private} --description "{desc}" --confirm` via child_process.execSync
      - Captures output to get repo URL
      - Emits "project.github_repo_created" event with repo URL
      - Returns { repoUrl, name }
    - GET /api/github/repos -- List repos (runs `gh repo list --json name,url,isPrivate --limit 20`)
    - POST /api/github/repos/:projectId/link -- Link an existing GitHub repo to a project. Body: { repoUrl }. Emits event.
    - All GitHub routes require auth. GitHub operations fail gracefully with clear error message if `gh` is not installed or not authenticated.

    Mount systemRouter on /api/system and githubRouter on /api/github in app.ts.
  </action>
  <verify>
    1. `npx tsc --noEmit` compiles without errors
    2. `curl /api/system/status` returns { setupComplete: false, hasUsers: false } on fresh install
    3. `curl /api/system/capabilities -b cookies.txt` returns list of discovered capabilities with installed status
    4. Verify gh CLI detection: if gh is installed, it should show as installed with version
    5. `curl -X POST /api/github/repos -d '{"name":"test-eluma-repo","private":true}' -b cookies.txt` -- if gh is authenticated, creates the repo (test with a disposable name). If not authenticated, returns clear error.
    6. `curl /api/system/github/status -b cookies.txt` returns authentication status
  </verify>
  <done>
    System capability scanner detects installed programs across macOS and Linux. GitHub repos can be auto-created via gh CLI. System config is persisted to filesystem. GitHub operations fail gracefully when gh is not available.
  </done>
</task>

<task type="auto">
  <name>Task 2: Setup wizard UI -- 3-step first-launch experience</name>
  <files>
    client/src/pages/Setup.tsx
    client/src/components/SetupWizard/Step1Account.tsx
    client/src/components/SetupWizard/Step2Team.tsx
    client/src/components/SetupWizard/Step3System.tsx
    client/src/hooks/useSystemCapabilities.ts
    client/src/App.tsx
  </files>
  <action>
    Per user decision: 3-step essential wizard with optional advanced sections.

    client/src/hooks/useSystemCapabilities.ts:
    - useSystemCapabilities() hook
    - Fetches from GET /api/system/capabilities
    - Exposes: capabilities, loading, saveCapabilities(enabled, claudeApiKey?)

    client/src/pages/Setup.tsx:
    - Step indicator showing current step (1/3, 2/3, 3/3) with labels
    - Navigation: Back/Next buttons, step indicator shows progress
    - Renders Step1Account, Step2Team, or Step3System based on current step
    - After Step 3 completes, redirects to Dashboard
    - All text translated (DE/EN)
    - Clean, professional styling (centered card layout, consistent spacing)

    client/src/components/SetupWizard/Step1Account.tsx:
    - "Create Your Account" / "Konto erstellen"
    - Fields: username, display name, password, confirm password
    - On submit: calls register() from useAuth
    - Optional: "Add Passkey" prompt after successful registration (reuse PasskeyPrompt component)
    - Language selector at the top (LanguageSwitcher component) so user can choose language before anything else
    - Validation: username 2-30 chars, password 8+ chars, passwords match

    client/src/components/SetupWizard/Step2Team.tsx:
    - "Create Your Team" / "Team erstellen"
    - Fields: team name
    - On submit: calls createTeam() from useTeam
    - Optional: invite field for second team member (username/email)
    - Shows success message after creation

    client/src/components/SetupWizard/Step3System.tsx:
    - "System Capabilities" / "Systemerkennung"
    - Auto-runs capability scan on mount (calls GET /api/system/capabilities)
    - Shows loading spinner during scan
    - Results displayed as a categorized list:
      - Each capability: icon/emoji, name, version (if available), toggle switch
      - Categories: CLI Tools, Editors, Browsers, Media, AI
      - Installed items shown with green checkmark, toggle ON by default
      - Not installed shown with gray X, toggle OFF and disabled
    - "Claude API Key" input field (text input, not a toggle) -- marked as required for AI features but skippable in Phase 1
    - "Advanced Settings" expandable section with: data directory path, allowed paths configuration
    - "Complete Setup" button saves config and marks setup as complete

    Update client/src/App.tsx:
    - Add setup detection: on app load, check GET /api/system/status
    - If setupComplete is false AND no users exist, redirect to /setup
    - If setupComplete is true, redirect to /login or /dashboard based on auth state
    - The /setup route is accessible without authentication (first launch)
  </action>
  <verify>
    1. `npx tsc --noEmit` compiles without errors
    2. Reset app state (delete data/ directory) and restart
    3. Open http://localhost:3000 -- should redirect to /setup
    4. Step 1: Create account -- fills in fields, submits, account created
    5. Step 2: Create team -- fills in team name, submits, team created
    6. Step 3: System scan -- shows discovered capabilities with toggles, Claude API key input
    7. Complete setup -- redirected to Dashboard
    8. Refresh -- goes to Dashboard (not back to setup)
    9. Open in new incognito -- goes to /login (setup complete, but not authenticated)
    10. All wizard text in correct language based on Step 1 language choice
  </verify>
  <done>
    Setup wizard guides first-time users through account creation, team setup, and system capability discovery. Capabilities are displayed with toggle switches. Setup state is persisted. App correctly routes between setup, login, and dashboard based on state.
  </done>
</task>

</tasks>

<verification>
- GitHub repo creation works via gh CLI when available
- System capability scanner detects installed programs
- Setup wizard completes 3 steps successfully
- Setup state persists (doesn't show wizard again after completion)
- App routing: fresh install -> setup, configured -> login, authenticated -> dashboard
- All setup wizard text translated in DE and EN
</verification>

<success_criteria>
1. `gh repo create` executed successfully via API when gh CLI is installed and authenticated
2. System scan detects at least git, node, npm on any development machine
3. Setup wizard completes all 3 steps without errors
4. After setup, app routes to login (not back to setup)
5. Capability toggles persist to system config file
6. GitHub operations return clear error when gh is not available
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-06-SUMMARY.md`
</output>
