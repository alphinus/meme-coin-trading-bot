---
phase: 01-foundation-authentication
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - client/src/i18n/config.ts
  - client/src/i18n/locales/de.json
  - client/src/i18n/locales/en.json
  - client/src/components/LanguageSwitcher.tsx
  - client/src/hooks/useLanguage.ts
  - server/src/i18n/server.ts
  - ecosystem.config.js
  - scripts/install.sh
  - scripts/start.sh
  - scripts/stop.sh
autonomous: true

must_haves:
  truths:
    - "UI renders in German when browser language is German"
    - "UI renders in English when browser language is English"
    - "User can switch language via a UI control and the choice persists across sessions"
    - "Fallback language is German when browser language is unsupported"
    - "App can be started via pm2 on both macOS and Linux"
    - "Install script sets up dependencies on macOS (brew) and Linux (apt)"
  artifacts:
    - path: "client/src/i18n/config.ts"
      provides: "i18next initialization with language detection"
      contains: "i18next"
    - path: "client/src/i18n/locales/de.json"
      provides: "German translation strings"
      contains: "Anmelden"
    - path: "client/src/i18n/locales/en.json"
      provides: "English translation strings"
      contains: "Sign in"
    - path: "client/src/components/LanguageSwitcher.tsx"
      provides: "Language toggle component"
      min_lines: 15
    - path: "ecosystem.config.js"
      provides: "pm2 process configuration"
      contains: "ecosystem"
    - path: "scripts/install.sh"
      provides: "Cross-platform install script"
      contains: "#!/bin/bash"
  key_links:
    - from: "client/src/i18n/config.ts"
      to: "client/src/i18n/locales/de.json"
      via: "imports translation resources"
      pattern: "import.*de.*from"
    - from: "client/src/components/LanguageSwitcher.tsx"
      to: "client/src/i18n/config.ts"
      via: "uses i18next to change language"
      pattern: "i18n\\.changeLanguage"
    - from: "client/src/main.tsx"
      to: "client/src/i18n/config.ts"
      via: "imports i18n config to initialize"
      pattern: "import.*i18n"
---

<objective>
Set up internationalization (German/English) with browser auto-detection and user preference persistence, plus deployment configuration for native pm2/systemd operation.

Purpose: Users need to work in their preferred language (I18N-01). The app must run natively on local hardware via pm2 without Docker (INFRA-01, INFRA-02).
Output: Working i18n with DE/EN translations, language switcher, pm2 config, and install/start scripts for macOS and Linux.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-CONTEXT.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: i18n framework with German/English translations and language switcher</name>
  <files>
    client/src/i18n/config.ts
    client/src/i18n/locales/de.json
    client/src/i18n/locales/en.json
    client/src/components/LanguageSwitcher.tsx
    client/src/hooks/useLanguage.ts
    client/src/main.tsx
    server/src/i18n/server.ts
  </files>
  <action>
    Install i18n dependencies: `npm install i18next react-i18next i18next-browser-languagedetector` in the client package.

    client/src/i18n/config.ts:
    - Initialize i18next with react-i18next and browser language detector
    - Resources: import de.json and en.json as translation namespaces
    - Detection order: ['localStorage', 'navigator'] -- check localStorage first (persisted preference), then browser language
    - lookupLocalStorage: 'eluma-language'
    - caches: ['localStorage'] -- persist detected/chosen language
    - fallbackLng: 'de' (German fallback per user decision)
    - interpolation.escapeValue: false (React handles escaping)
    - saveMissing: true in development mode (logs missing keys to console)
    - Export initialized i18n instance

    client/src/i18n/locales/de.json:
    - Comprehensive German translations covering ALL existing UI elements:
      common: { save, cancel, delete, loading, error, success, back, next, submit, confirm }
      auth: { login, logout, register, username, password, confirmPassword, displayName, passkey_prompt, passkey_login, passkey_register, passkey_skip, first_launch_title, first_launch_subtitle, login_title, error_invalid_credentials, error_username_taken }
      nav: { dashboard, settings, logout }
      dashboard: { welcome, activity_feed, no_activity, recent_events }
      setup: { welcome, step1_title, step2_title, step3_title }
      settings: { title, language, language_de, language_en }

    client/src/i18n/locales/en.json:
    - Same structure as de.json but in English
    - Every key in de.json MUST have a corresponding key in en.json

    client/src/hooks/useLanguage.ts:
    - useLanguage() hook wrapping useTranslation from react-i18next
    - Exposes: currentLanguage ('de' | 'en'), setLanguage(lang), t (translation function)
    - setLanguage saves to localStorage AND calls i18n.changeLanguage
    - Also saves language preference to the server via POST /api/auth/preferences (for user model persistence -- add this endpoint to auth routes as a small addition)

    client/src/components/LanguageSwitcher.tsx:
    - Simple toggle/dropdown showing "DE | EN"
    - Highlights current language
    - On click, calls setLanguage from useLanguage hook
    - Minimal styling: inline or CSS module

    Update client/src/main.tsx:
    - Import './i18n/config' BEFORE React render to ensure i18n is initialized
    - Wrap App in Suspense (i18next may lazy-load)

    server/src/i18n/server.ts:
    - Server-side i18n utility for API error messages
    - Simple function: t(key: string, lang: 'de' | 'en'): string
    - Loads from same JSON files (or a simplified server translation map)
    - Used for API error responses in user's language

    Update all existing UI components to use useTranslation() hook:
    - Login.tsx: all visible text through t() function
    - App.tsx header: nav items through t()
    - Any placeholder page text through t()
  </action>
  <verify>
    1. `npx tsc --noEmit` compiles without errors
    2. Start app, open in browser with German browser locale -- UI shows German text
    3. Click language switcher to English -- UI switches to English immediately
    4. Refresh browser -- language preference persists (stays English)
    5. Switch back to German, refresh -- stays German
    6. Open in a new incognito window with English browser locale -- UI shows English
    7. No untranslated keys visible (no raw key strings like "auth.login" showing in UI)
  </verify>
  <done>
    UI renders in German or English based on browser detection. User can toggle language. Preference persists in localStorage and survives browser refresh. German is the fallback language. All visible text is translated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Deployment configuration -- pm2, install scripts, cross-platform support</name>
  <files>
    ecosystem.config.js
    scripts/install.sh
    scripts/start.sh
    scripts/stop.sh
  </files>
  <action>
    ecosystem.config.js (pm2 configuration):
    - App name: 'eluma'
    - Script: './server/dist/index.js' (production builds to dist)
    - instances: 1 (single instance -- filesystem-first, no clustering)
    - exec_mode: 'fork'
    - watch: false (chokidar handles file watching internally)
    - max_memory_restart: '500M'
    - env: NODE_ENV=production, PORT=3000
    - env_development: NODE_ENV=development, PORT=3000
    - error_file: './logs/eluma-error.log'
    - out_file: './logs/eluma-out.log'
    - merge_logs: true
    - log_date_format: 'YYYY-MM-DD HH:mm:ss Z'

    scripts/install.sh:
    - Shebang: #!/bin/bash, set -e
    - Detect OS: macOS (darwin) or Linux (check for apt/dpkg)
    - macOS: check for Homebrew (install if missing), install node@20 via brew, install pm2 globally
    - Linux (Ubuntu/Debian): install Node.js 20 via NodeSource, install pm2 globally
    - Both: run `npm install` in project root, run `npm run build`
    - Create data directories: data/events, data/sessions, data/users, data/teams, data/projects, data/memory, data/system, logs
    - Generate a random SESSION_SECRET if .env doesn't exist, create .env from .env.example with generated secret
    - Initialize Git repo in data/memory/ for Git-backed versioning
    - Print success message with next steps
    - Make executable: chmod +x

    scripts/start.sh:
    - Shebang: #!/bin/bash
    - Build the project: npm run build
    - Start with pm2: pm2 start ecosystem.config.js
    - Print status: pm2 status
    - Print access URL

    scripts/stop.sh:
    - Shebang: #!/bin/bash
    - pm2 stop eluma
    - Print stopped message

    Add npm scripts to root package.json:
    - "start": "pm2 start ecosystem.config.js"
    - "stop": "pm2 stop eluma"
    - "restart": "pm2 restart eluma"
    - "logs": "pm2 logs eluma"
    - "build": build all packages (shared first, then server, then client)

    Add a "build" script to server/package.json that compiles TypeScript to dist/.
    Add a "build" script to client/package.json that runs vite build (outputs to client/dist/).
    Ensure server in production mode serves client/dist/ static files.

    IMPORTANT: The install script must work on BOTH macOS and Linux (Ubuntu/Debian) per user decision. Test-friendly: use functions, clear error messages.
  </action>
  <verify>
    1. `bash scripts/install.sh` runs without errors (on current platform)
    2. `npm run build` completes without errors (TypeScript compilation + Vite build)
    3. `bash scripts/start.sh` starts the app via pm2
    4. `pm2 status` shows eluma process running
    5. `curl http://localhost:3000/api/health` returns OK from the pm2-managed process
    6. `bash scripts/stop.sh` stops the process
    7. `pm2 status` shows eluma stopped
    8. Log files exist in logs/ directory
  </verify>
  <done>
    App runs via pm2 in production mode. Install script works on macOS and Linux. Start/stop scripts manage the pm2 process. Build pipeline compiles TypeScript server and bundles React client. Logs are written to files.
  </done>
</task>

</tasks>

<verification>
- Language detection works from browser settings
- Language switcher toggles between DE and EN
- Language preference persists across sessions
- pm2 starts and manages the app process
- Install script works on the current platform
- Production build serves the React SPA correctly
</verification>

<success_criteria>
1. UI shows German text when browser is set to German
2. UI shows English text when browser is set to English
3. Language toggle switches immediately and persists on refresh
4. German is the fallback when browser language is unsupported
5. `pm2 start ecosystem.config.js` runs the production app
6. `scripts/install.sh` sets up all dependencies and data directories
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-03-SUMMARY.md`
</output>
