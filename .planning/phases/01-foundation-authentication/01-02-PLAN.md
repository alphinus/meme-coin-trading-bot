---
phase: 01-foundation-authentication
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - server/src/auth/passkey.ts
  - server/src/auth/password.ts
  - server/src/auth/session.ts
  - server/src/routes/auth.ts
  - server/src/middleware/auth.ts
  - client/src/pages/Login.tsx
  - client/src/hooks/useAuth.ts
  - client/src/components/PasskeyPrompt.tsx
  - client/src/components/ProtectedRoute.tsx
  - server/data/users/
autonomous: true

must_haves:
  truths:
    - "User can register with a username and password"
    - "User can register a passkey for their account"
    - "User can log in with either passkey or password"
    - "User session persists across browser refresh (cookie-based)"
    - "Unauthenticated requests to protected API routes return 401"
    - "User credentials are stored as JSON files on the filesystem (no database)"
  artifacts:
    - path: "server/src/auth/passkey.ts"
      provides: "WebAuthn registration and authentication using SimpleWebAuthn"
      exports: ["createRegistrationOptions", "verifyRegistration", "createAuthenticationOptions", "verifyAuthentication"]
    - path: "server/src/auth/password.ts"
      provides: "Argon2 password hashing and verification"
      exports: ["hashPassword", "verifyPassword"]
    - path: "server/src/auth/session.ts"
      provides: "Express session configuration with file store"
      exports: ["sessionMiddleware"]
    - path: "server/src/middleware/auth.ts"
      provides: "Auth guard middleware for protected routes"
      exports: ["requireAuth"]
    - path: "server/src/routes/auth.ts"
      provides: "Auth API endpoints"
      contains: "router"
    - path: "client/src/hooks/useAuth.ts"
      provides: "Client-side auth state management"
      exports: ["useAuth"]
    - path: "client/src/pages/Login.tsx"
      provides: "Login page with passkey and password forms"
      min_lines: 50
  key_links:
    - from: "server/src/routes/auth.ts"
      to: "server/src/auth/passkey.ts"
      via: "imports passkey functions for registration/authentication"
      pattern: "import.*from.*auth/passkey"
    - from: "server/src/routes/auth.ts"
      to: "server/src/auth/password.ts"
      via: "imports password functions for hash/verify"
      pattern: "import.*from.*auth/password"
    - from: "server/src/routes/auth.ts"
      to: "server/src/events/store.ts"
      via: "emits user.created event on registration"
      pattern: "appendEvent.*user\\.created"
    - from: "client/src/pages/Login.tsx"
      to: "/api/auth/*"
      via: "fetch calls for login/register"
      pattern: "api/auth"
    - from: "client/src/hooks/useAuth.ts"
      to: "/api/auth/me"
      via: "checks session on mount"
      pattern: "api/auth/me"
    - from: "server/src/app.ts"
      to: "server/src/auth/session.ts"
      via: "mounts session middleware"
      pattern: "sessionMiddleware"
---

<objective>
Implement passkey/password authentication with filesystem-based credential storage and session management.

Purpose: Users need to sign in to access the platform. Per user decision: simple passkey/password auth (no Google OAuth), two users, locally managed credentials. Sessions must persist across browser refresh (AUTH-03).
Output: Working auth system with registration, login (passkey + password), session persistence, and auth middleware protecting API routes.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-CONTEXT.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server-side auth -- passkey, password, sessions, middleware, user storage</name>
  <files>
    server/src/auth/passkey.ts
    server/src/auth/password.ts
    server/src/auth/session.ts
    server/src/routes/auth.ts
    server/src/middleware/auth.ts
  </files>
  <action>
    Install auth dependencies: `npm install @simplewebauthn/server argon2` in the server package.

    server/src/auth/password.ts:
    - hashPassword(password: string): Promise<string> -- uses argon2.hash with argon2id variant
    - verifyPassword(hash: string, password: string): Promise<boolean> -- uses argon2.verify

    server/src/auth/session.ts:
    - Configure express-session with session-file-store (already installed in Plan 01)
    - Session store path: `{DATA_DIR}/sessions`
    - ttl: 604800 (7 days), reapInterval: 21600 (6 hours) per research recommendation
    - Cookie: httpOnly true, secure only in production, maxAge 7 days, sameSite 'lax'
    - Export sessionMiddleware for mounting in app.ts

    server/src/auth/passkey.ts:
    - RP_NAME = 'Eluma', RP_ID from env (default 'localhost'), ORIGIN from env (default 'http://localhost:3000')
    - createRegistrationOptions(user: User): generates WebAuthn registration options using generateRegistrationOptions from @simplewebauthn/server. attestationType 'none', residentKey 'preferred', userVerification 'preferred'. Excludes existing credentials.
    - verifyRegistration(user: User, response, expectedChallenge): verifies registration response, returns verified credential data
    - createAuthenticationOptions(user: User): generates authentication options with user's existing passkeys as allowCredentials
    - verifyAuthentication(user: User, response, expectedChallenge): verifies authentication response, updates passkey counter
    - Support multiple RP_IDs per research (localhost + tunnel). Store RP_ID per credential. Accept multiple expected origins.

    User storage (filesystem-based, per user decision):
    - Users stored as individual JSON files in `{DATA_DIR}/users/{userId}.json`
    - Helper functions in server/src/auth/passkey.ts or a new server/src/auth/users.ts:
      - saveUser(user: User): writes user JSON to file
      - loadUser(userId: string): reads user JSON from file
      - loadUserByUsername(username: string): scans user files to find by username (acceptable for 2 users)
      - listUsers(): returns all users
    - Password hash stored in User.passwordHash field
    - Passkey credentials stored in User.passkeys array

    server/src/middleware/auth.ts:
    - requireAuth: Express middleware that checks req.session.userId. If missing, returns 401 { success: false, error: "Authentication required" }. If present, loads user and attaches to req.user (extend Express Request type).

    server/src/routes/auth.ts:
    - POST /api/auth/register -- accepts { username, displayName, password }. Validates with zod (username 2-30 chars, password 8+ chars). Checks username uniqueness. Creates user with hashed password. Emits "user.created" event to event store. Returns user (without passwordHash). Sets session.userId.
    - POST /api/auth/login -- accepts { username, password }. Verifies password. Sets session.userId. Returns user info.
    - POST /api/auth/passkey/register/options -- (requires auth) generates WebAuthn registration options. Stores challenge in session.
    - POST /api/auth/passkey/register/verify -- (requires auth) verifies registration response against session challenge. Adds passkey to user. Emits "user.passkey_registered" event.
    - POST /api/auth/passkey/login/options -- accepts { username }. Generates authentication options. Stores challenge in session.
    - POST /api/auth/passkey/login/verify -- verifies authentication response. Sets session.userId. Updates passkey counter.
    - GET /api/auth/me -- (requires auth) returns current user info (without passwordHash/passkey private data)
    - POST /api/auth/logout -- destroys session, clears cookie

    Mount sessionMiddleware in app.ts BEFORE routes. Mount requireAuth on protected route groups (events, teams, projects, memory, github, system). Auth routes are NOT protected (except passkey registration which requires existing auth).

    IMPORTANT: WebAuthn challenge must be stored in session and cleared after use (replay attack prevention).
  </action>
  <verify>
    1. `npx tsc --noEmit` compiles without errors
    2. Start server, then test registration:
       `curl -X POST http://localhost:3000/api/auth/register -H "Content-Type: application/json" -d '{"username":"elvis","displayName":"Elvis","password":"test12345"}' -c cookies.txt`
       Should return 200 with user data
    3. Test session persistence:
       `curl http://localhost:3000/api/auth/me -b cookies.txt`
       Should return 200 with user data
    4. Test login:
       `curl -X POST http://localhost:3000/api/auth/login -H "Content-Type: application/json" -d '{"username":"elvis","password":"test12345"}' -c cookies2.txt`
       Should return 200
    5. Test auth guard:
       `curl http://localhost:3000/api/events` (no cookies)
       Should return 401
    6. Verify user file exists at `data/users/{userId}.json` with hashed password (not plaintext)
    7. Verify "user.created" event in `data/events/user.jsonl`
  </verify>
  <done>
    Registration creates user with hashed password stored as JSON file. Login verifies credentials and sets session cookie. Session persists across requests (cookie-based). Auth middleware blocks unauthenticated access to protected routes. User events are emitted to the event store.
  </done>
</task>

<task type="auto">
  <name>Task 2: Client-side auth -- Login page, passkey prompt, useAuth hook, protected routes</name>
  <files>
    client/src/pages/Login.tsx
    client/src/hooks/useAuth.ts
    client/src/components/PasskeyPrompt.tsx
    client/src/components/ProtectedRoute.tsx
    client/src/App.tsx
  </files>
  <action>
    Install client auth dependency: `npm install @simplewebauthn/browser` in the client package.

    client/src/hooks/useAuth.ts:
    - useAuth() hook managing auth state: { user: User | null, loading: boolean, error: string | null }
    - On mount, calls GET /api/auth/me to check existing session
    - Exposes: login(username, password), register(username, displayName, password), logout(), registerPasskey(), loginWithPasskey(username)
    - login: POST /api/auth/login, on success sets user state
    - register: POST /api/auth/register, on success sets user state
    - logout: POST /api/auth/logout, clears user state
    - registerPasskey: calls /api/auth/passkey/register/options, then startRegistration from @simplewebauthn/browser, then /api/auth/passkey/register/verify
    - loginWithPasskey: calls /api/auth/passkey/login/options, then startAuthentication from @simplewebauthn/browser, then /api/auth/passkey/login/verify
    - Use React context (AuthContext + AuthProvider) to share state across components

    client/src/pages/Login.tsx:
    - Two-tab layout: "Password" and "Passkey" tabs
    - Password tab: username + password form with submit button. Shows error messages on failure.
    - Passkey tab: username field + "Sign in with Passkey" button. Shows error if WebAuthn not supported (navigator.credentials check).
    - If no users exist yet (first launch), show a registration form instead: username, display name, password, confirm password. After registration, prompt to add a passkey (optional).
    - Detect first-launch by calling GET /api/auth/users/count (add this simple endpoint to server -- returns { count: number }).
    - Style with minimal inline CSS or CSS modules for now (no Tailwind yet -- keep it clean and functional). Use a centered card layout.

    client/src/components/PasskeyPrompt.tsx:
    - Component shown after password registration: "Secure your account with a passkey?" with "Add Passkey" and "Skip" buttons
    - "Add Passkey" triggers registerPasskey() from useAuth
    - Shows success/error feedback

    client/src/components/ProtectedRoute.tsx:
    - Wrapper component that checks useAuth() state
    - If loading, shows a loading indicator
    - If no user, redirects to /login
    - If authenticated, renders children

    Update client/src/App.tsx:
    - Wrap app in AuthProvider
    - Wrap Dashboard, Settings, and future routes in ProtectedRoute
    - Login and Setup routes remain public
    - Add a simple layout wrapper with a header showing current user displayName and a logout button (when authenticated)
  </action>
  <verify>
    1. `npx tsc --noEmit` compiles without errors
    2. Start the full stack with `npm run dev`
    3. Open http://localhost:3000 -- should redirect to /login
    4. Registration flow: fill in username/displayName/password, submit, should redirect to dashboard placeholder
    5. Refresh browser -- should remain logged in (session persists, AUTH-03)
    6. Logout -- should redirect to /login
    7. Login flow: enter username/password, should redirect to dashboard
    8. Passkey registration: after login, the passkey prompt should appear (if shown). Click "Add Passkey" -- browser should show WebAuthn prompt (on localhost, this works without HTTPS)
  </verify>
  <done>
    Users can register with username/password on first launch. Users can log in with password. Session persists across browser refresh (verified by F5 staying logged in). Passkey registration works on localhost. Unauthenticated users are redirected to login. Auth state is shared via React context.
  </done>
</task>

</tasks>

<verification>
- User can register an account (first launch shows registration form)
- User can log in with password
- User can register and use a passkey (on localhost)
- Session persists across browser refresh
- Protected routes redirect to login when unauthenticated
- User credentials stored as JSON files (no database)
- Auth events emitted to event store
</verification>

<success_criteria>
1. POST /api/auth/register creates user file and sets session cookie
2. POST /api/auth/login verifies credentials and sets session cookie
3. GET /api/auth/me returns user when authenticated, 401 when not
4. Browser refresh maintains login state (AUTH-03)
5. WebAuthn passkey registration succeeds on localhost
6. All user data stored as files in data/users/ (no database)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-02-SUMMARY.md`
</output>
