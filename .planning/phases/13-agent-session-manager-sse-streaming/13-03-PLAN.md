---
phase: 13-agent-session-manager-sse-streaming
plan: 03
type: execute
wave: 2
depends_on: ["13-01", "13-02"]
files_modified:
  - client/src/pages/ProjectDetail.tsx
  - client/src/i18n/locales/en.json
  - client/src/i18n/locales/de.json
autonomous: false

must_haves:
  truths:
    - "User sees a GSD action button on the project detail page"
    - "Clicking the button starts an agent session with the project ID and shows streaming output"
    - "User can abort a running session from the project detail page"
    - "All new UI strings are translated in both German and English"
    - "Agent output panel appears below the phase timeline with markdown-formatted streaming text"
  artifacts:
    - path: "client/src/pages/ProjectDetail.tsx"
      provides: "GSD action button wired to useAgentStream + AgentOutput component"
      contains: "useAgentStream"
    - path: "client/src/i18n/locales/en.json"
      provides: "English i18n keys for GSD button, reconnecting, abort confirmation"
      contains: "run_gsd"
    - path: "client/src/i18n/locales/de.json"
      provides: "German i18n keys for GSD button, reconnecting, abort confirmation"
      contains: "run_gsd"
  key_links:
    - from: "client/src/pages/ProjectDetail.tsx"
      to: "client/src/hooks/useAgentStream.ts"
      via: "useAgentStream hook invocation"
      pattern: "useAgentStream\\(\\)"
    - from: "client/src/pages/ProjectDetail.tsx"
      to: "client/src/components/AgentOutput.tsx"
      via: "AgentOutput component rendering"
      pattern: "<AgentOutput"
    - from: "client/src/pages/ProjectDetail.tsx"
      to: "/api/agent/start"
      via: "startSession with projectId"
      pattern: "startSession.*projectId"
---

<objective>
Wire GSD action button into the project detail page and add all missing i18n keys for the agent streaming UI.

Purpose: Satisfies AGENT-01 (user clicks GSD button, sees streaming output) and AGENT-03 (abort button visible during streaming). Also closes the i18n gap for reconnection status, GSD button labels, and abort confirmation.
Output: Updated ProjectDetail.tsx with GSD button + AgentOutput, and both en.json/de.json with new agent keys.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-agent-session-manager-sse-streaming/13-RESEARCH.md
@.planning/phases/13-agent-session-manager-sse-streaming/13-01-SUMMARY.md
@.planning/phases/13-agent-session-manager-sse-streaming/13-02-SUMMARY.md
@client/src/pages/ProjectDetail.tsx
@client/src/hooks/useAgentStream.ts
@client/src/components/AgentOutput.tsx
@client/src/i18n/locales/en.json
@client/src/i18n/locales/de.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add i18n keys for agent streaming UI</name>
  <files>client/src/i18n/locales/en.json, client/src/i18n/locales/de.json</files>
  <action>
  Add the following keys to the existing `"agent"` section in both locale files. Do NOT remove or change existing agent keys. Append these new keys after the existing ones.

  **en.json** -- add inside the `"agent": { ... }` object:
  ```json
  "reconnecting": "Reconnecting...",
  "connection_lost": "Connection lost",
  "run_gsd": "Run GSD Analysis",
  "run_gsd_description": "Analyze project and suggest next steps",
  "abort_confirm": "Stop the running analysis?",
  "session_active": "Analysis in progress...",
  "prompt_placeholder": "What should the AI analyze?"
  ```

  **de.json** -- add inside the `"agent": { ... }` object:
  ```json
  "reconnecting": "Verbindung wird wiederhergestellt...",
  "connection_lost": "Verbindung verloren",
  "run_gsd": "GSD-Analyse starten",
  "run_gsd_description": "Projekt analysieren und nächste Schritte vorschlagen",
  "abort_confirm": "Laufende Analyse abbrechen?",
  "session_active": "Analyse läuft...",
  "prompt_placeholder": "Was soll die KI analysieren?"
  ```

  Ensure proper Unicode for German: use real umlauts (ä, ö, ü), not ASCII approximations. Both files must have the exact same keys.
  </action>
  <verify>Verify both files are valid JSON: `node -e "JSON.parse(require('fs').readFileSync('client/src/i18n/locales/en.json','utf8'))"` and same for de.json. Both must parse without error. Count agent keys in both files -- they must match.</verify>
  <done>Both en.json and de.json have 16 agent keys (9 existing + 7 new). All German strings use proper Unicode umlauts.</done>
</task>

<task type="auto">
  <name>Task 2: Wire GSD action button and AgentOutput into ProjectDetail</name>
  <files>client/src/pages/ProjectDetail.tsx</files>
  <action>
  Add GSD action button and streaming output to the project detail page.

  **Step 1: Add imports.**
  At the top of ProjectDetail.tsx, add:
  ```typescript
  import { useAgentStream } from "../hooks/useAgentStream.js";
  import { AgentOutput } from "../components/AgentOutput.js";
  ```
  Keep using `useLanguage` for `t()` as that is the project convention established in this file.

  **Step 2: Add hook and state in the ProjectDetail component.**
  Inside the `ProjectDetail()` function, after the existing state declarations, add:
  ```typescript
  const {
    fullText,
    status: agentStatus,
    currentTool,
    result: agentResult,
    error: agentError,
    statusMessage,
    startSession,
    abortSession,
    reset: resetAgent,
  } = useAgentStream();

  const [showPromptInput, setShowPromptInput] = useState(false);
  const [agentPrompt, setAgentPrompt] = useState("");
  ```
  Note: rename `status` to `agentStatus` and `result` to `agentResult` and `error` to `agentError` to avoid shadowing the existing `error` variable from useProject.

  **Step 3: Add handler functions.**
  After the existing handlers, add:
  ```typescript
  async function handleRunGsd() {
    if (!project) return;
    const prompt = agentPrompt.trim() || "Analyze this project and suggest next steps";
    setShowPromptInput(false);
    setAgentPrompt("");
    await startSession({
      prompt,
      projectId: project.id,
    });
  }

  async function handleAbortAgent() {
    await abortSession();
  }
  ```

  **Step 4: Add the GSD section to the JSX.**
  Insert a new section AFTER the ProjectInfo component and BEFORE the phase timeline section. This places the GSD action at a prominent position:

  ```tsx
  {/* GSD Agent Action */}
  {!project.archived && (
    <div style={pageStyles.section}>
      <h2 style={pageStyles.sectionTitle}>{t("agent.run_gsd")}</h2>
      <div style={pageStyles.card}>
        {agentStatus === "idle" && (
          <div style={gsdStyles.actionArea}>
            <p style={gsdStyles.description}>{t("agent.run_gsd_description")}</p>
            {showPromptInput ? (
              <div style={gsdStyles.promptArea}>
                <input
                  type="text"
                  value={agentPrompt}
                  onChange={(e) => setAgentPrompt(e.target.value)}
                  onKeyDown={(e) => { if (e.key === "Enter") handleRunGsd(); }}
                  placeholder={t("agent.prompt_placeholder")}
                  style={gsdStyles.promptInput}
                  autoFocus
                />
                <div style={gsdStyles.promptActions}>
                  <button onClick={() => setShowPromptInput(false)} style={gsdStyles.secondaryButton}>
                    {t("common.cancel")}
                  </button>
                  <button onClick={handleRunGsd} style={gsdStyles.primaryButton}>
                    {t("agent.run_gsd")}
                  </button>
                </div>
              </div>
            ) : (
              <div style={gsdStyles.buttonArea}>
                <button onClick={handleRunGsd} style={gsdStyles.primaryButton}>
                  {t("agent.run_gsd")}
                </button>
                <button onClick={() => setShowPromptInput(true)} style={gsdStyles.secondaryButton}>
                  {t("agent.prompt_placeholder")}
                </button>
              </div>
            )}
          </div>
        )}
        {agentStatus !== "idle" && (
          <AgentOutput
            fullText={fullText}
            status={agentStatus}
            currentTool={currentTool}
            result={agentResult}
            error={agentError}
            statusMessage={statusMessage}
            onAbort={handleAbortAgent}
          />
        )}
        {(agentStatus === "done" || agentStatus === "error") && (
          <div style={gsdStyles.resetArea}>
            <button onClick={resetAgent} style={gsdStyles.secondaryButton}>
              {t("common.close")}
            </button>
          </div>
        )}
      </div>
    </div>
  )}
  ```

  **Step 5: Add GSD styles.**
  Add a new styles object at the end of the file (after the pageStyles object):
  ```typescript
  const gsdStyles: Record<string, React.CSSProperties> = {
    actionArea: {
      padding: "0.5rem 0",
    },
    description: {
      fontSize: "0.9rem",
      color: "#6b7280",
      margin: "0 0 0.75rem 0",
    },
    buttonArea: {
      display: "flex",
      gap: "0.5rem",
      alignItems: "center",
    },
    primaryButton: {
      padding: "0.5rem 1rem",
      fontSize: "0.9rem",
      fontWeight: 600,
      backgroundColor: "#2563eb",
      color: "#ffffff",
      border: "none",
      borderRadius: "6px",
      cursor: "pointer",
    },
    secondaryButton: {
      padding: "0.5rem 1rem",
      fontSize: "0.85rem",
      backgroundColor: "transparent",
      color: "#6b7280",
      border: "1px solid #d1d5db",
      borderRadius: "6px",
      cursor: "pointer",
    },
    promptArea: {
      display: "flex",
      flexDirection: "column" as const,
      gap: "0.5rem",
    },
    promptInput: {
      width: "100%",
      padding: "0.5rem 0.75rem",
      fontSize: "0.9rem",
      border: "1px solid #d1d5db",
      borderRadius: "6px",
      boxSizing: "border-box" as const,
    },
    promptActions: {
      display: "flex",
      gap: "0.5rem",
      justifyContent: "flex-end",
    },
    resetArea: {
      display: "flex",
      justifyContent: "flex-end",
      padding: "0.5rem 0 0 0",
    },
  };
  ```

  Follow the existing inline CSS style pattern (no Tailwind, no CSS modules). Match the visual style of existing cards (white bg, border, rounded corners -- already handled by pageStyles.card wrapper).

  Do NOT modify any existing sections (ProjectInfo, PhaseTimeline, WorkflowEngine, KPI sidebar). This is purely additive.
  </action>
  <verify>Run `npx tsc --noEmit -p client/tsconfig.json` from the eluma directory. Must compile without errors. Visually inspect ProjectDetail.tsx to confirm: (1) useAgentStream hook is called, (2) AgentOutput component is rendered when agentStatus !== "idle", (3) startSession passes project.id as projectId, (4) GSD section only shows for non-archived projects.</verify>
  <done>ProjectDetail page has a "Run GSD Analysis" button that starts an agent session with the project ID. AgentOutput displays streaming markdown with syntax highlighting. Abort button is functional. Reset/close button appears after completion or error. All strings use i18n.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete agent streaming integration</name>
  <action>Human verifies the full agent streaming flow works end-to-end in the browser.</action>
  <what-built>Complete agent streaming integration: GSD button on project detail page triggers Claude Agent SDK session with real-time SSE streaming, per-project session enforcement, syntax-highlighted markdown output, abort capability, and reconnection handling.</what-built>
  <how-to-verify>
    1. Open the app in browser (http://localhost:3000 or wherever Eluma runs)
    2. Navigate to any project's detail page
    3. Verify the "GSD Analysis" section appears with a blue "Run GSD Analysis" button
    4. Click the button -- you should see the AgentOutput component appear with streaming text
    5. While streaming, verify code blocks have syntax highlighting (colored tokens, not plain monospace)
    6. Click "Cancel" during streaming to verify abort works
    7. After completion, verify the cost/duration/turns summary appears
    8. Click "Close" to reset back to the button state
    9. Verify the button does NOT appear on archived projects
    10. Switch language (DE/EN) and verify all agent strings are translated
  </how-to-verify>
  <verify>Human confirms all 10 verification steps pass.</verify>
  <done>User has visually confirmed the agent streaming UI works correctly.</done>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- ProjectDetail.tsx imports and uses useAgentStream + AgentOutput
- GSD button triggers startSession with project.id
- AgentOutput renders during streaming/reconnecting/done/error states
- All new UI strings have keys in both en.json and de.json
- German strings use proper umlauts
- Abort and reset functions work
- Non-archived projects show button, archived projects do not
</verification>

<success_criteria>
User can click a GSD button on any active project, see real-time streaming markdown output with syntax-highlighted code blocks, abort the session mid-stream, and see translated UI in both languages.
</success_criteria>

<output>
After completion, create `.planning/phases/13-agent-session-manager-sse-streaming/13-03-SUMMARY.md`
</output>
