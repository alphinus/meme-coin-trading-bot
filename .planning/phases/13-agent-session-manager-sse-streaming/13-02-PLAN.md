---
phase: 13-agent-session-manager-sse-streaming
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/hooks/useAgentStream.ts
  - client/src/components/AgentOutput.tsx
autonomous: true

must_haves:
  truths:
    - "EventSource auto-reconnects on transient errors without showing Error status"
    - "UI shows Reconnecting status during transient disconnect"
    - "Only terminal events (result, server-sent error with data) close the EventSource"
    - "Code blocks in agent output have syntax highlighting with colored tokens"
    - "StreamStatus type includes reconnecting as a valid state"
  artifacts:
    - path: "client/src/hooks/useAgentStream.ts"
      provides: "Reconnection-aware EventSource handling with reconnecting status"
      contains: "reconnecting"
    - path: "client/src/components/AgentOutput.tsx"
      provides: "Syntax-highlighted code blocks via rehype-highlight"
      contains: "rehypeHighlight"
  key_links:
    - from: "client/src/hooks/useAgentStream.ts"
      to: "EventSource API"
      via: "onerror handler checking readyState"
      pattern: "EventSource\\.CONNECTING"
    - from: "client/src/components/AgentOutput.tsx"
      to: "rehype-highlight"
      via: "rehypePlugins prop on Markdown component"
      pattern: "rehypePlugins.*rehypeHighlight"
---

<objective>
Harden client-side streaming: fix EventSource reconnection handling to not break auto-reconnect, add "reconnecting" status, and add syntax highlighting to code blocks in agent output.

Purpose: Satisfies the client half of AGENT-04 (reconnection UX) and AGENT-05 (code block formatting with syntax highlighting). Currently, the onerror handler closes EventSource on transient errors, preventing auto-reconnect. Code blocks render as plain monospace text without coloring.
Output: Updated useAgentStream.ts with proper reconnection and AgentOutput.tsx with rehype-highlight.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-agent-session-manager-sse-streaming/13-RESEARCH.md
@client/src/hooks/useAgentStream.ts
@client/src/components/AgentOutput.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix EventSource reconnection and add reconnecting status</name>
  <files>client/src/hooks/useAgentStream.ts</files>
  <action>
  In `client/src/hooks/useAgentStream.ts`:

  1. **Update StreamStatus type** -- add "reconnecting":
     ```typescript
     export type StreamStatus = "idle" | "starting" | "streaming" | "reconnecting" | "done" | "error";
     ```

  2. **Fix the named "error" event listener** (line 117-127). Currently it closes EventSource on ALL error events including those without data. Change to:
     ```typescript
     es.addEventListener("error", (e: MessageEvent) => {
       if (e.data) {
         // Server-sent error event with data payload -- terminal
         const data = JSON.parse(e.data) as { message: string };
         setError(data.message);
         setStatus("error");
         setCurrentTool(null);
         es.close();
       }
       // No data means connection error -- let EventSource auto-reconnect
       // The onerror handler below handles the status update
     });
     ```
     Key change: remove `es.close()` and error-setting from the no-data branch. Only close on server-sent error events that include a data payload.

  3. **Fix the onerror handler** (line 130-135). Currently it only checks CLOSED. Update to handle CONNECTING state too:
     ```typescript
     es.onerror = () => {
       if (es.readyState === EventSource.CONNECTING) {
         // Transient disconnect -- EventSource will auto-reconnect
         setStatus("reconnecting");
       } else if (es.readyState === EventSource.CLOSED) {
         // Permanent failure -- only set error if not already done/completed
         setStatus((prev) => (prev === "done" ? prev : "error"));
         setError("Connection lost");
       }
     };
     ```

  4. **Add status reset on reconnect success.** After a reconnect, EventSource fires onopen. Add an onopen handler to restore streaming status:
     ```typescript
     es.onopen = () => {
       setStatus("streaming");
     };
     ```
     Place this after the `es.onerror` assignment.

  Do NOT change startSession, abortSession, reset, or the useEffect cleanup. Do NOT change the text, tool_start, tool_done, tool_progress, status, or result event listeners.
  </action>
  <verify>Run `npx tsc --noEmit -p client/tsconfig.json` from the eluma directory. Must compile without errors in useAgentStream.ts. Confirm that `es.close()` only appears in the "result" listener and the server-sent "error" listener (with data), NOT in the onerror handler or the no-data error branch.</verify>
  <done>StreamStatus includes "reconnecting". EventSource onerror distinguishes CONNECTING (set reconnecting) from CLOSED (set error). Named error listener only closes on events with data. onopen resets status to streaming after successful reconnect.</done>
</task>

<task type="auto">
  <name>Task 2: Add syntax highlighting to AgentOutput code blocks</name>
  <files>client/src/components/AgentOutput.tsx</files>
  <action>
  **Step 1: Install dependencies.**
  Run from the eluma project root:
  ```bash
  npm install rehype-highlight highlight.js -w client
  ```

  **Step 2: Update AgentOutput.tsx.**

  Add two imports at the top of the file (after the existing react-markdown imports):
  ```typescript
  import rehypeHighlight from "rehype-highlight";
  import "highlight.js/styles/github.css";
  ```

  Update the Markdown component (around line 119) to include rehypePlugins:
  ```typescript
  <Markdown remarkPlugins={[remarkGfm]} rehypePlugins={[rehypeHighlight]}>
    {fullText}
  </Markdown>
  ```

  **Step 3: Update AgentOutput to handle "reconnecting" status.**

  In the StatusIndicator component, add "reconnecting" to the color logic:
  ```typescript
  const color =
    status === "streaming" || status === "starting"
      ? "#3b82f6"
      : status === "reconnecting"
        ? "#f59e0b"  // amber for reconnecting
        : status === "done"
          ? "#22c55e"
          : status === "error"
            ? "#ef4444"
            : "#9ca3af";
  ```

  Also add "reconnecting" to the animation condition so it pulses:
  ```typescript
  animation:
    status === "streaming" || status === "starting" || status === "reconnecting"
      ? "pulse 1.5s ease-in-out infinite"
      : "none",
  ```

  In the header title section, add a case for "reconnecting" status display:
  ```typescript
  : status === "reconnecting"
    ? t("agent.reconnecting", "Reconnecting...")
  ```
  Insert this between the "streaming" and "done" cases in the ternary.

  In the cancel button conditional (line 94), also show cancel during "reconnecting":
  ```typescript
  {(status === "starting" || status === "streaming" || status === "reconnecting") && (
  ```

  Do NOT change the styles object, the result area, the error area, or the tool indicator. These are minimal, targeted additions.
  </action>
  <verify>Run `npx tsc --noEmit -p client/tsconfig.json` from the eluma directory. Must compile without errors. Visually confirm: (1) rehypeHighlight is in rehypePlugins array, (2) highlight.js CSS is imported, (3) StatusIndicator handles "reconnecting" with amber color and pulse animation.</verify>
  <done>Code blocks render with syntax highlighting via rehype-highlight. AgentOutput shows amber pulsing dot and "Reconnecting..." text during reconnection. Cancel button remains visible during reconnecting state.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit -p client/tsconfig.json` compiles without errors
- `rehype-highlight` and `highlight.js` are in client/package.json dependencies
- AgentOutput Markdown component has `rehypePlugins={[rehypeHighlight]}`
- `highlight.js/styles/github.css` is imported
- StreamStatus includes "reconnecting"
- EventSource.onerror distinguishes CONNECTING from CLOSED
- Named "error" listener only calls es.close() when e.data is present
- StatusIndicator renders amber dot for "reconnecting"
</verification>

<success_criteria>
Transient SSE disconnects show "Reconnecting..." with amber indicator instead of "Error". EventSource auto-reconnects without manual intervention. Code blocks display syntax-highlighted tokens.
</success_criteria>

<output>
After completion, create `.planning/phases/13-agent-session-manager-sse-streaming/13-02-SUMMARY.md`
</output>
