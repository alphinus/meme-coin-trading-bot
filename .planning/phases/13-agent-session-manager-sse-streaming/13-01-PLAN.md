---
phase: 13-agent-session-manager-sse-streaming
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/agent/types.ts
  - server/src/agent/session-manager.ts
  - server/src/routes/agent.ts
autonomous: true

must_haves:
  truths:
    - "Server enforces one active session per project, not per user"
    - "Every SSE event includes a sequential integer id field"
    - "Reconnecting clients receive only events after their Last-Event-ID"
    - "Buffer holds up to 2000 events instead of 500"
    - "SSE stream sends retry: 3000 on initial connection"
  artifacts:
    - path: "server/src/agent/types.ts"
      provides: "projectId required in StartSessionOptions"
      contains: "projectId: string"
    - path: "server/src/agent/session-manager.ts"
      provides: "Per-project session enforcement and enlarged buffer"
      contains: "session.projectId === projectId"
    - path: "server/src/routes/agent.ts"
      provides: "SSE event IDs, Last-Event-ID replay, retry field, projectId required"
      contains: "last-event-id"
  key_links:
    - from: "server/src/routes/agent.ts"
      to: "server/src/agent/session-manager.ts"
      via: "agentSessions.start() with required projectId"
      pattern: "agentSessions\\.start"
    - from: "server/src/routes/agent.ts"
      to: "SSE protocol"
      via: "id: field in every SSE event write"
      pattern: "id: \\$\\{eventId\\}"
---

<objective>
Harden server-side session management: enforce one session per project (not per user), add SSE event IDs for reconnection replay, increase buffer from 500 to 2000, and send retry field.

Purpose: Satisfies AGENT-02 (per-project enforcement) and the server half of AGENT-04 (event IDs + replay from Last-Event-ID). Without event IDs, client reconnection replays the entire buffer causing duplicate text.
Output: Updated session-manager.ts, types.ts, and routes/agent.ts with per-project enforcement, event IDs, and replay logic.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-agent-session-manager-sse-streaming/13-RESEARCH.md
@server/src/agent/types.ts
@server/src/agent/session-manager.ts
@server/src/routes/agent.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Per-project session enforcement and buffer increase</name>
  <files>server/src/agent/types.ts, server/src/agent/session-manager.ts</files>
  <action>
  In `server/src/agent/types.ts`:
  - Change `projectId?: string` to `projectId: string` in `StartSessionOptions` (make it required)
  - No other type changes needed. Do NOT add an id field to SSEEvent (event IDs are transport-level, not domain-level)

  In `server/src/agent/session-manager.ts`:
  - Change `MAX_BUFFER_SIZE` from 500 to 2000
  - Change the session enforcement check in `start()` from per-user to per-project:
    - Remove the old check (`session.userId === userId && session.state === "running"`)
    - Replace with: iterate sessions, if any session has `session.projectId === projectId && session.state === "running"`, throw `"Agent session already running for this project"`
  - Change the session constructor line from `projectId: projectId ?? null` to `projectId: projectId` (it is now always provided)
  - Update the JSDoc on `start()` from "Enforces one active session per user" to "Enforces one active session per project"
  - Update the module-level comment from "One active session per user" to "One active session per project"

  Do NOT refactor any other part of session-manager.ts. Do NOT change abort(), cleanup(), consumeStream(), or pushEvent().
  </action>
  <verify>Run `npx tsc --noEmit -p server/tsconfig.json` from the eluma directory. Must pass with zero errors in types.ts and session-manager.ts. Any pre-existing errors in unrelated files (calendar.ts, gmail.ts, telegram) are acceptable.</verify>
  <done>StartSessionOptions.projectId is required (not optional). Session enforcement checks projectId instead of userId. MAX_BUFFER_SIZE is 2000.</done>
</task>

<task type="auto">
  <name>Task 2: SSE event IDs, Last-Event-ID replay, and retry field</name>
  <files>server/src/routes/agent.ts</files>
  <action>
  In `server/src/routes/agent.ts`:

  **POST /start route:**
  - Change the Zod schema: `projectId` from `z.string().optional()` to `z.string().min(1, "Project ID is required")` (required, since StartSessionOptions now requires it)

  **GET /stream/:sessionId route:**
  1. After flushHeaders(), immediately send the retry field:
     ```
     res.write("retry: 3000\n\n");
     ```
     Then flush.

  2. Read the `Last-Event-ID` header from the request:
     ```
     const lastEventId = parseInt(req.headers["last-event-id"] as string, 10) || 0;
     ```

  3. Replace the existing sendEvent function to include event IDs:
     ```
     let nextEventId = 0;
     const sendEvent = (event: SSEEvent, eventId: number): void => {
       res.write(`id: ${eventId}\nevent: ${event.type}\ndata: ${JSON.stringify(event.data)}\n\n`);
       // flush for compression middleware
       if (typeof (res as unknown as { flush: () => void }).flush === "function") {
         (res as unknown as { flush: () => void }).flush();
       }
     };
     ```

  4. Replace the buffer replay loop. Event IDs are 1-based (buffer index 0 = event ID 1):
     ```
     for (let i = 0; i < session.buffer.length; i++) {
       const eventId = i + 1;
       if (eventId > lastEventId) {
         sendEvent(session.buffer[i], eventId);
       }
     }
     nextEventId = session.buffer.length + 1;
     ```

  5. Update the live event `onData` handler to use and increment nextEventId:
     ```
     const onData = (event: SSEEvent): void => {
       sendEvent(event, nextEventId++);
     };
     ```

  6. Update the heartbeat to also flush (already does, just ensure consistency):
     ```
     res.write(`: heartbeat\n\n`);
     ```
     Heartbeat comments do NOT get an id (they are SSE comments, not events).

  Do NOT change the DELETE or GET /status routes. Do NOT change auth checks. Keep all existing error handling patterns.
  </action>
  <verify>Run `npx tsc --noEmit -p server/tsconfig.json` from the eluma directory. Must compile. Then visually inspect `routes/agent.ts` to confirm: (a) `retry: 3000` is sent first, (b) every event has `id:` field, (c) `Last-Event-ID` header is read and used for replay skip, (d) projectId is required in the start schema.</verify>
  <done>SSE stream sends `retry: 3000` on connect, every event includes `id: N`, reconnecting clients skip already-received events via Last-Event-ID header, and projectId is required in POST /start.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit -p server/tsconfig.json` compiles without errors in agent/* and routes/agent.ts
- `StartSessionOptions.projectId` is `string` (not `string | undefined`)
- Session enforcement loop checks `session.projectId === projectId` (not userId)
- `MAX_BUFFER_SIZE` is 2000
- SSE stream endpoint writes `retry: 3000\n\n` immediately after headers
- Every SSE event write includes `id: ${eventId}\n` prefix
- Buffer replay skips events where `eventId <= lastEventId`
- POST /start schema requires projectId
</verification>

<success_criteria>
Server enforces one session per project. SSE events carry sequential IDs. Reconnecting clients replay from Last-Event-ID forward without duplicates. Buffer holds 2000 events.
</success_criteria>

<output>
After completion, create `.planning/phases/13-agent-session-manager-sse-streaming/13-01-SUMMARY.md`
</output>
