---
phase: 04-ai-foundation-orchestration
plan: 04
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - server/src/routes/ai.ts
autonomous: true

must_haves:
  truths:
    - "User can view AI cost summary aggregated by project, model, and month"
    - "User can manually override the model for an AI task type"
    - "User can override an AI decision with a documented reason"
    - "All overrides are recorded as auditable events"
    - "User can request conflict mediation through an API endpoint"
  artifacts:
    - path: "server/src/routes/ai.ts"
      provides: "Cost dashboard, model override, decision override, and mediation request endpoints"
      contains: "override-model"
  key_links:
    - from: "server/src/routes/ai.ts"
      to: "server/src/ai/cost/dashboard.ts"
      via: "getCostSummary for GET /cost"
      pattern: "getCostSummary"
    - from: "server/src/routes/ai.ts"
      to: "server/src/events/store.ts"
      via: "appendEvent for override events"
      pattern: "ai\\.model_overridden|ai\\.decision_overridden"
    - from: "server/src/routes/ai.ts"
      to: "server/src/ai/actions/mediation.ts"
      via: "mediateConflict for POST /mediate"
      pattern: "mediateConflict"
---

<objective>
Add cost dashboard, model override, decision override, and mediation request endpoints to the AI API routes.

Purpose: Users need cost transparency (AI-09), the ability to override model selection (AI-08), the ability to override AI decisions with full audit trail (AI-10), and the ability to trigger conflict mediation (AI-11). These are the user control mechanisms for the AI team member.

Output: 5 new API endpoints added to existing ai.ts router
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ai-foundation-orchestration/04-RESEARCH.md

# Plan 01 and 02 outputs needed
@eluma/server/src/routes/ai.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cost dashboard and model override endpoints</name>
  <files>
    server/src/routes/ai.ts
  </files>
  <action>
Extend the existing `server/src/routes/ai.ts` router (created in Plan 02) with these new endpoints:

1. **GET /cost** -- AI cost dashboard summary (AI-09)
   - Import getCostSummary from "../ai/cost/dashboard.js"
   - Call getCostSummary() and return { success: true, data: summary }
   - Summary contains: totalCost, byProject, byModel, byMonth

2. **GET /cost/:projectId** -- AI cost for specific project (AI-09)
   - Import getCostSummaryForProject from "../ai/cost/dashboard.js"
   - Call getCostSummaryForProject(projectId)
   - Return { success: true, data: summary }

3. **POST /override-model** -- Manual model override per AI task type (AI-08)
   - Validate body with Zod: { nodeId: string (1-100 chars), modelId: string (1-100 chars), reason?: string (optional, max 500 chars) }
   - nodeId represents the task type or specific AI node being overridden
   - Append "ai.model_overridden" event with aggregateType "ai_member", aggregateId = nodeId, userId from session
   - Data: { nodeId, modelId, overriddenBy: userId, overriddenAt: ISO timestamp, reason }
   - Return { success: true, data: { eventId: event.id } }

4. **POST /override-decision** -- Override AI decision (AI-10, hidden slide-on menu)
   - Validate body with Zod: { aiEventId: string, overrideReason: string (min 1 char, max 1000 chars), newDecision: string (min 1 char, max 2000 chars) }
   - overrideReason is REQUIRED -- every override must be documented
   - Append "ai.decision_overridden" event with aggregateType "ai_member", aggregateId = aiEventId, userId from session
   - Data: { aiEventId, overrideReason, newDecision, overriddenBy: userId, overriddenAt: ISO timestamp }
   - Return { success: true, data: { eventId: event.id } }

5. **POST /mediate** -- Request conflict mediation (AI-11)
   - Validate body with Zod: { projectId: string, teamId: string, position1: { userId: string, summary: string (min 10, max 2000 chars) }, position2: { userId: string, summary: string (min 10, max 2000 chars) }, projectContext?: string (max 2000 chars) }
   - Import mediateConflict from "../ai/actions/mediation.js"
   - Call mediateConflict with input data + language from AI member config (default "en")
   - Return { success: true, data: { text: result.text, eventId: result.eventId } }
   - Wrap in try/catch: if AI call fails, return { success: false, error: "Mediation failed: " + error message } with status 500

All endpoints follow existing patterns:
- userId extracted from `(req.session as any).userId`
- Zod validation on POST bodies with 400 error on invalid input
- Consistent { success: true/false, data/error } response shape
  </action>
  <verify>
    Run `cd /Users/developer/eluma && npx tsc --build --noEmit` -- TypeScript compiles. Verify ai.ts has all 5 new endpoints (GET /cost, GET /cost/:projectId, POST /override-model, POST /override-decision, POST /mediate). Verify Zod schemas have proper constraints. Verify all overrides record events with userId and timestamp.
  </verify>
  <done>
    Cost dashboard endpoints return aggregated AI costs by project/model/month. Model override and decision override endpoints create auditable events. Mediation endpoint triggers AI conflict analysis. All 5 endpoints validated with Zod and follow existing API patterns.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --build --noEmit` passes from project root
- ai.ts router has 9 total endpoints (4 from Plan 02 + 5 new)
- GET /cost returns CostSummary shape
- POST /override-model and /override-decision both create auditable events
- POST /mediate calls mediateConflict and handles errors
- All POST endpoints validate input with Zod
</verification>

<success_criteria>
- Cost dashboard API returns aggregated costs (total, by project, by model, by month)
- Model override creates ai.model_overridden event with userId and reason
- Decision override creates ai.decision_overridden event with mandatory reason
- Mediation endpoint calls AI with both positions and returns compromise text
- All endpoints follow existing Express route patterns with auth and validation
</success_criteria>

<output>
After completion, create `.planning/phases/04-ai-foundation-orchestration/04-04-SUMMARY.md`
</output>
