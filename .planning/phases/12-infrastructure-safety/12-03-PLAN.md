---
phase: 12-infrastructure-safety
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: ["server/src/agent/session-manager.ts"]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "A final SSE event notifies clients their session was interrupted before server closes connection"
  artifacts:
    - path: "server/src/agent/session-manager.ts"
      provides: "cleanup() method with SSE 'status' event emission"
      contains: "Server shutting down"
  key_links:
    - from: "server/src/agent/session-manager.ts"
      to: "session.emitter"
      via: "pushEvent() call before 'end' event"
      pattern: "pushEvent.*Server shutting down"
---

<objective>
Fix gap in graceful shutdown: emit SSE 'status' event notifying clients of server shutdown before closing connections.

Purpose: Complete INFRA-05 requirement â€” graceful shutdown must notify SSE clients before aborting their sessions.
Output: cleanup() method emits 'interrupted' notification to SSE clients, matching abort() method pattern.
</objective>

<execution_context>
@/Users/developer/.claude/agents/gsd-executor.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/developer/.planning/PROJECT.md
@/Users/developer/.planning/ROADMAP.md
@/Users/developer/.planning/STATE.md

@/Users/developer/.planning/phases/12-infrastructure-safety/12-01-SUMMARY.md
@/Users/developer/.planning/phases/12-infrastructure-safety/12-VERIFICATION.md

@/Users/developer/eluma/server/src/agent/session-manager.ts
@/Users/developer/eluma/server/src/agent/types.ts
</context>

<tasks>

<task type="auto">
  <name>Add SSE 'status' event emission in cleanup() method</name>
  <files>server/src/agent/session-manager.ts</files>
  <action>
Update the cleanup() method (lines 146-161) to emit an SSE 'status' event before emitting 'end', matching the pattern used in abort() method (lines 130-137).

Implementation:
1. In cleanup() loop, after clearing timeout (line 153), add SSE event emission:
   - Create SSEEvent object with type: "status", data: { message: "Server shutting down" }
   - Call this.pushEvent(session, event) to send to SSE clients via emitter
   - Then emit "end" event as before

Pattern to follow (from abort() method lines 131-137):
```typescript
const event: SSEEvent = {
  type: "status",
  data: { message: "Server shutting down" },
  timestamp: new Date().toISOString(),
};
this.pushEvent(session, event);
session.emitter.emit("end");
```

Why: SSE clients currently receive abrupt connection close during graceful shutdown. With this fix, they receive a proper notification message before the connection closes, improving UX and meeting INFRA-05 requirement.

Updated cleanup() structure:
```typescript
cleanup(): void {
  let aborted = 0;
  for (const session of this.sessions.values()) {
    if (session.state === "running") {
      session.state = "aborted";
      session.abortController.abort();
      session.query.close();
      this.clearTimeout(session);

      // NEW: Emit shutdown notification
      const event: SSEEvent = {
        type: "status",
        data: { message: "Server shutting down" },
        timestamp: new Date().toISOString(),
      };
      this.pushEvent(session, event);

      session.emitter.emit("end");
      aborted++;
    }
  }
  if (aborted > 0) {
    console.log(`[agent] Cleaned up ${aborted} active session(s)`);
  }
}
```
  </action>
  <verify>
1. Run TypeScript compiler: `cd /Users/developer/eluma && npm run type-check` (must pass)
2. Verify SSEEvent type import is present at top of file
3. Confirm pushEvent() method is called before emitter.emit("end")
4. Pattern match: `grep -A 5 "Server shutting down" server/src/agent/session-manager.ts` should show the event creation and pushEvent call
  </verify>
  <done>
cleanup() method emits SSE 'status' event with "Server shutting down" message before emitting 'end' event, matching abort() method pattern. SSE clients receive notification before connection closes during graceful shutdown.
  </done>
</task>

</tasks>

<verification>
1. SSEEvent object created with type "status" and message "Server shutting down"
2. pushEvent() called to send event to SSE clients via session.emitter
3. Event emission occurs before session.emitter.emit("end")
4. TypeScript compilation passes without errors
5. Pattern matches abort() method's SSE event emission approach
</verification>

<success_criteria>
- [ ] cleanup() method contains SSE event creation with "Server shutting down" message
- [ ] pushEvent() is called with the event object
- [ ] Event emission occurs after clearTimeout() and before emitter.emit("end")
- [ ] TypeScript types are correct (SSEEvent imported and used properly)
- [ ] Code structure mirrors abort() method pattern (lines 131-137)
- [ ] All 5 INFRA requirements satisfied (INFRA-05 gap closed)
</success_criteria>

<output>
After completion, create `/Users/developer/.planning/phases/12-infrastructure-safety/12-03-SUMMARY.md`
</output>
