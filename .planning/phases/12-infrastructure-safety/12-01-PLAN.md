---
phase: 12-infrastructure-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/package.json
  - server/src/agent/types.ts
  - server/src/agent/tool-permissions.ts
  - ecosystem.config.cjs
autonomous: true

must_haves:
  truths:
    - "Server starts with @anthropic-ai/claude-agent-sdk installed and importable"
    - "PM2 does not restart the server during an agent session due to memory limits"
    - "Agent sessions only have access to explicitly allowlisted tools (canUseTool handler rejects unlisted tools)"
  artifacts:
    - path: "server/src/agent/types.ts"
      provides: "TypeScript types for agent sessions, SSE events, session state"
      exports: ["AgentSession", "AgentSessionState", "SSEEvent", "SSEEventType"]
    - path: "server/src/agent/tool-permissions.ts"
      provides: "canUseTool handler with global allowlist and dangerous Bash command blocking"
      exports: ["canUseTool", "ALLOWED_TOOLS", "DANGEROUS_BASH_PATTERNS"]
    - path: "ecosystem.config.cjs"
      provides: "PM2 config with raised memory limit, kill_timeout, and V8 heap args"
      contains: "max_memory_restart"
  key_links:
    - from: "server/src/agent/tool-permissions.ts"
      to: "@anthropic-ai/claude-agent-sdk"
      via: "CanUseTool type import"
      pattern: "import.*CanUseTool.*claude-agent-sdk"
---

<objective>
Install the Claude Agent SDK, create the type definitions and tool permission handler, and tune PM2 for agent session memory requirements.

Purpose: Establishes the foundation layer that all subsequent agent infrastructure depends on. Without the SDK installed, no agent sessions can run. Without PM2 tuning, agent sessions will trigger crash-restart loops. Without the tool permission handler, agents run with unrestricted access.
Output: SDK installed, agent types defined, canUseTool handler ready, PM2 configured for 1.5GB memory with graceful shutdown timeout.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-infrastructure-safety/12-RESEARCH.md
@.planning/phases/12-infrastructure-safety/12-CONTEXT.md
@server/src/app.ts
@server/package.json
@ecosystem.config.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Agent SDK and create types + tool permission handler</name>
  <files>
    server/package.json
    server/src/agent/types.ts
    server/src/agent/tool-permissions.ts
  </files>
  <action>
    1. Install dependencies from the project root:
       ```
       npm install @anthropic-ai/claude-agent-sdk@^0.2.37 -w server
       npm install strip-ansi@^7.1.0 -w server
       ```

    2. Create `server/src/agent/types.ts` with these type definitions:
       - `AgentSessionState`: union type `'starting' | 'running' | 'completed' | 'errored' | 'aborted' | 'interrupted'`
       - `SSEEventType`: union type `'token' | 'tool_use' | 'tool_result' | 'status' | 'error' | 'completed' | 'interrupted' | 'heartbeat'`
       - `SSEEvent`: interface with `{ type: SSEEventType; data: unknown; timestamp: string }`
       - `AgentSession`: interface with `{ id: string; projectId: string; state: AgentSessionState; abortController: AbortController; createdAt: Date; sseClients: Set<string> }`
       - Export all types.

    3. Create `server/src/agent/tool-permissions.ts`:
       - Import `CanUseTool`, `PermissionResult`, `ToolInput` from `@anthropic-ai/claude-agent-sdk`.
       - Define `ALLOWED_TOOLS` as a `ReadonlySet<string>` containing: `Read`, `Glob`, `Grep`, `Edit`, `Write`, `Bash`, `WebSearch`, `WebFetch`, `Task`, `TodoWrite` (per user decision: full Bash, WebSearch, WebFetch allowed).
       - Define `DANGEROUS_BASH_PATTERNS` as a `RegExp[]` with patterns for: `rm -rf /` or `~/`, `sudo`, `curl | sh`, `chmod 777`, writes to `/etc/`, `kill -9`, `mkfs`, `dd if=` (per research recommendations).
       - Export the `canUseTool` function matching the `CanUseTool` type signature. Logic:
         a. If `toolName` is NOT in `ALLOWED_TOOLS`, log rejection with `console.warn('[agent] Tool rejected: ${toolName}')` and return `{ behavior: 'deny', message: 'Tool "${toolName}" is not in the allowed tools list.' }` (per user decision: only rejected calls are logged).
         b. If `toolName` is `'Bash'` and `input` has a `command` property, test against each `DANGEROUS_BASH_PATTERNS`. If any match, log with `console.warn('[agent] Dangerous Bash command blocked: ${cmd}')` and return deny with message `'Command blocked by security policy: ${cmd.slice(0, 80)}'`.
         c. Otherwise return `{ behavior: 'allow', updatedInput: input }`.
       - Use `permissionMode: 'default'` in all documentation comments (NOT `bypassPermissions` -- per research: bypassPermissions silently disables canUseTool).
       - Export `ALLOWED_TOOLS` and `DANGEROUS_BASH_PATTERNS` for testing visibility.

    Note: The Agent SDK types may use slightly different names than researched. If `CanUseTool` is not a named export, check the SDK's actual TypeScript declarations and adapt the import. The core pattern (function receiving toolName + input, returning allow/deny) is stable.
  </action>
  <verify>
    1. Run `cd /Users/developer/eluma && npx tsc --noEmit` -- no type errors in new files
    2. Verify the SDK is importable: `cd /Users/developer/eluma && node -e "import('@anthropic-ai/claude-agent-sdk').then(m => console.log('SDK loaded, exports:', Object.keys(m).slice(0, 5))).catch(e => console.error('FAIL:', e.message))"`
    3. Verify types.ts exports: `cd /Users/developer/eluma && node --import tsx/esm -e "import { AgentSessionState } from './server/src/agent/types.ts'; console.log('types OK')"`
    4. Verify tool-permissions.ts exports: `cd /Users/developer/eluma && node --import tsx/esm -e "import { canUseTool, ALLOWED_TOOLS } from './server/src/agent/tool-permissions.ts'; console.log('tools OK, allowed:', [...ALLOWED_TOOLS])"`
  </verify>
  <done>
    - @anthropic-ai/claude-agent-sdk and strip-ansi are in server/package.json dependencies
    - server/src/agent/types.ts exports AgentSession, AgentSessionState, SSEEvent, SSEEventType
    - server/src/agent/tool-permissions.ts exports canUseTool matching CanUseTool type, ALLOWED_TOOLS contains exactly [Read, Glob, Grep, Edit, Write, Bash, WebSearch, WebFetch, Task, TodoWrite], DANGEROUS_BASH_PATTERNS blocks rm -rf /, sudo, curl|sh, chmod 777, /etc/ writes, kill -9, mkfs, dd
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure PM2 for Agent SDK memory requirements</name>
  <files>
    ecosystem.config.cjs
  </files>
  <action>
    Update `ecosystem.config.cjs` in the project root. The current file has `max_memory_restart: "500M"` and no kill_timeout or node_args.

    Changes to make:
    1. Change `max_memory_restart` from `"500M"` to `"1536M"` (1.5GB -- per research: Agent SDK child processes can add 200MB-1GB to RSS, parent server uses ~150-300MB baseline).
    2. Add `kill_timeout: 15000` (15 seconds -- gives graceful shutdown handler time to abort agent sessions before PM2 sends SIGKILL. Per research: PM2 default is only 1600ms which is too short).
    3. Add `node_args: "--max-old-space-size=2048"` (2GB V8 heap limit -- prevents V8 OOM before PM2 RSS check catches it. Per research: must be configured alongside PM2 memory limit).

    Keep all existing fields unchanged (name, script, instances, exec_mode, watch, env, env_development, error_file, out_file, merge_logs, log_date_format).
  </action>
  <verify>
    1. Read ecosystem.config.cjs and confirm: max_memory_restart is "1536M", kill_timeout is 15000, node_args includes "--max-old-space-size=2048"
    2. Validate syntax: `cd /Users/developer/eluma && node -e "const c = require('./ecosystem.config.cjs'); console.log(JSON.stringify(c.apps[0], null, 2))"`
  </verify>
  <done>
    - ecosystem.config.cjs has max_memory_restart: "1536M" (was "500M")
    - ecosystem.config.cjs has kill_timeout: 15000
    - ecosystem.config.cjs has node_args: "--max-old-space-size=2048"
    - All existing config fields preserved unchanged
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors in server/src/agent/ files
- Agent SDK is importable in Node.js
- tool-permissions.ts canUseTool function has correct type signature
- ecosystem.config.cjs parses without errors and has correct memory/timeout values
- No changes to existing routes, middleware, or app.ts (those are Plan 02)
</verification>

<success_criteria>
1. @anthropic-ai/claude-agent-sdk is installed and importable (INFRA-01 partial)
2. PM2 configured with 1.5GB memory, 15s kill_timeout, 2GB V8 heap (INFRA-02 complete)
3. canUseTool handler with allowlist and Bash command filtering ready for use (INFRA-04 complete)
4. All TypeScript types for agent sessions defined and exported
</success_criteria>

<output>
After completion, create `.planning/phases/12-infrastructure-safety/12-01-SUMMARY.md`
</output>
