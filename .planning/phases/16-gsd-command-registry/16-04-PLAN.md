---
phase: 16-gsd-command-registry
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/components/GsdCommandPalette.tsx
  - client/src/pages/ProjectDetail.tsx
  - client/src/i18n/locales/en.json
  - client/src/i18n/locales/de.json
  - client/package.json
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "In Expert mode, pressing Cmd+K (Mac) or Ctrl+K (Windows) opens a command palette dialog"
    - "User can type in the palette search input and commands are filtered with fuzzy matching"
    - "Selecting a command from the palette injects its prompt into the AgentPanel (same behavior as clicking a GsdCommandMenu button)"
    - "The palette does not appear in Simple mode"
    - "Pressing Escape or clicking outside the palette closes it"
  artifacts:
    - path: "client/src/components/GsdCommandPalette.tsx"
      provides: "Cmd+K command palette using cmdk library"
      min_lines: 60
    - path: "client/package.json"
      provides: "cmdk dependency"
      contains: "cmdk"
    - path: "client/src/i18n/locales/en.json"
      provides: "Palette i18n keys"
      contains: "command_palette"
    - path: "client/src/i18n/locales/de.json"
      provides: "Palette i18n keys (German)"
      contains: "command_palette"
  key_links:
    - from: "client/src/components/GsdCommandPalette.tsx"
      to: "cmdk"
      via: "import { Command } from 'cmdk'"
      pattern: "from ['\"]cmdk['\"]"
    - from: "client/src/pages/ProjectDetail.tsx"
      to: "client/src/components/GsdCommandPalette.tsx"
      via: "import and conditional render with isExpert"
      pattern: "isExpert.*GsdCommandPalette"
    - from: "client/src/components/GsdCommandPalette.tsx"
      to: "onSelectCommand callback"
      via: "calls parent handler on Command.Item select"
      pattern: "onSelectCommand"
---

<objective>
Close the critical gap from Phase 16 verification: implement the Cmd+K command palette for Expert mode.

Purpose: Expert mode users expect keyboard-driven command access (Cmd+K is an industry-standard pattern used by Linear, Raycast, VS Code). This is success criteria #4 from the ROADMAP and the only gap preventing Phase 16 completion.

Output: Working GsdCommandPalette.tsx component using the cmdk library, wired into ProjectDetail for Expert mode only.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-gsd-command-registry/16-VERIFICATION.md
@.planning/phases/16-gsd-command-registry/16-02-SUMMARY.md

# Existing source files to integrate with
@eluma/client/src/components/GsdCommandMenu.tsx
@eluma/client/src/pages/ProjectDetail.tsx
@eluma/client/src/hooks/useGsdCommands.ts
@eluma/shared/types/gsd.ts
@eluma/client/src/hooks/useMode.ts
@eluma/client/src/i18n/locales/en.json
@eluma/client/src/i18n/locales/de.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install cmdk and create GsdCommandPalette component</name>
  <files>
    client/package.json
    client/src/components/GsdCommandPalette.tsx
  </files>
  <action>
    **Step 1: Install cmdk**
    ```bash
    npm install cmdk -w client
    ```
    Verify it appears in client/package.json dependencies.

    **Step 2: Create `client/src/components/GsdCommandPalette.tsx`**

    The component must follow the same patterns as GsdCommandMenu.tsx (inline styles, i18n via useTranslation, GsdCommand type from shared).

    Props interface (match GsdCommandMenu pattern exactly):
    ```typescript
    interface GsdCommandPaletteProps {
      commands: GsdCommand[];
      onSelectCommand: (prompt: string, options?: { maxTurns?: number; maxBudgetUsd?: number }) => void;
      projectName: string;
      currentPhase: string;
      buildPrompt: (command: GsdCommand, projectName: string, currentPhase: string) => string;
      disabled?: boolean;
    }
    ```

    Implementation requirements:
    1. Import `{ Command }` from `"cmdk"` and `{ useTranslation }` from `"react-i18next"`.
    2. Import `GsdCommand` type from `"shared/types/gsd.js"`.
    3. State: `const [open, setOpen] = useState(false)`.
    4. Keyboard listener via useEffect:
       ```typescript
       useEffect(() => {
         function handleKeyDown(e: KeyboardEvent) {
           if (e.key === "k" && (e.metaKey || e.ctrlKey)) {
             e.preventDefault();
             setOpen((prev) => !prev);
           }
         }
         document.addEventListener("keydown", handleKeyDown);
         return () => document.removeEventListener("keydown", handleKeyDown);
       }, []);
       ```
    5. Render `Command.Dialog` with `open` and `onOpenChange={setOpen}` props.
    6. Inside the dialog:
       - `Command.Input` with `placeholder={t("gsd.search_commands")}`.
       - `Command.List` containing `Command.Empty` with text `{t("gsd.no_commands")}` and a map over `commands` rendering `Command.Item` for each.
       - Each `Command.Item` must have:
         - `key={cmd.id}`
         - `value={cmd.label}` (cmdk uses this for built-in fuzzy matching)
         - `onSelect` handler that calls `buildPrompt(cmd, projectName, currentPhase)` and passes the result to `onSelectCommand(prompt, cmd.agentOptions)`, then calls `setOpen(false)`.
         - Display: i18n-resolved label (bold) and description (lighter text below).
    7. Do NOT close the palette when `disabled` is true and a command is selected. Instead, early-return from onSelect if disabled.

    **Step 3: Inline styles for the palette**

    cmdk's Command.Dialog renders as a portal. It needs minimal styling. Use a `<style>` tag injected in the component (this is the accepted exception to inline-only styles for cmdk's data-attribute selectors):

    ```typescript
    // Render a <style> tag for cmdk data-attribute selectors that cannot be done inline
    ```

    Style the dialog overlay and content:
    - Overlay: fixed position, semi-transparent black background (`rgba(0, 0, 0, 0.5)`), z-index 9999.
    - Content: centered, max-width 500px, white background, rounded corners (12px), shadow.
    - Input: full width, padding 12px 16px, no border, border-bottom 1px solid #e5e7eb, font-size 15px.
    - List: max-height 300px, overflow-y auto, padding 8px.
    - Items: padding 10px 16px, border-radius 8px, cursor pointer, font-size 14px.
    - Selected item (`[data-selected="true"]`): background #f3f4f6.
    - Item label: font-weight 500, color #1a1a1a.
    - Item description: font-size 12px, color #6b7280, margin-top 2px.

    The `<style>` tag approach:
    ```tsx
    <style>{`
      [cmdk-overlay] { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; }
      [cmdk-dialog] { position: fixed; top: 20%; left: 50%; transform: translateX(-50%); ... }
      [cmdk-input] { ... }
      [cmdk-list] { ... }
      [cmdk-item] { ... }
      [cmdk-item][data-selected="true"] { background: #f3f4f6; }
      [cmdk-empty] { ... }
    `}</style>
    ```

    Place the `<style>` tag inside the component return, only when `open` is true.

    **Step 4: Add i18n keys**

    In `client/src/i18n/locales/en.json`, add inside the `"gsd"` object (after `"no_commands"`):
    ```json
    "command_palette": "Command Palette",
    "search_commands": "Search commands..."
    ```

    In `client/src/i18n/locales/de.json`, add inside the `"gsd"` object (after `"no_commands"`):
    ```json
    "command_palette": "Befehlspalette",
    "search_commands": "Befehle suchen..."
    ```

    IMPORTANT: Do NOT reorder or modify any existing keys. Insert the new keys after `"no_commands"` and before `"cmd"`.
  </action>
  <verify>
    1. Run `cd /Users/developer/eluma && node -e "require.resolve('cmdk'); console.log('OK')"` -- must print OK.
    2. Run `npx tsc --noEmit -p client/tsconfig.json 2>&1 | head -20` -- must show no errors related to GsdCommandPalette.
    3. Grep for `command_palette` in en.json and de.json -- must find matches in both.
    4. Grep for `search_commands` in en.json and de.json -- must find matches in both.
    5. Verify GsdCommandPalette.tsx exists and exports a named function.
  </verify>
  <done>
    cmdk installed, GsdCommandPalette.tsx exists with Command.Dialog, keyboard listener, fuzzy search, i18n, and inline/data-attribute styles. Both locale files have command_palette and search_commands keys.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire GsdCommandPalette into ProjectDetail for Expert mode</name>
  <files>
    client/src/pages/ProjectDetail.tsx
  </files>
  <action>
    Modify `client/src/pages/ProjectDetail.tsx` to import and render GsdCommandPalette when in Expert mode.

    **Step 1: Add import**

    Add after the GsdCommandMenu import (line 28):
    ```typescript
    import { GsdCommandPalette } from "../components/GsdCommandPalette.js";
    ```

    **Step 2: Render the palette component**

    Inside the `!project.archived` agent section (around line 467-489), add `GsdCommandPalette` AFTER the closing of the card div that contains GsdCommandMenu and AgentPanel. The palette renders as a portal (dialog overlay), so placement in the DOM tree does not matter visually, but logically it belongs in the agent section.

    Specifically, inside the `{!project.archived && (...)}` block, after the closing `</div>` of `pageStyles.card` (around line 487) but before the closing `</div>` of `pageStyles.section`, add:

    ```tsx
    {isExpert && (
      <GsdCommandPalette
        commands={commands}
        onSelectCommand={handleCommandSelect}
        projectName={project.name}
        currentPhase={project.currentPhase}
        buildPrompt={buildPrompt}
        disabled={agentActive}
      />
    )}
    ```

    The component uses the same props that GsdCommandMenu already receives. The existing variables are:
    - `commands` -- from `useGsdCommands(id)` destructured at line 300
    - `handleCommandSelect` -- defined at line 349
    - `project.name`, `project.currentPhase` -- from `useProject(id)`
    - `buildPrompt` -- from `useGsdCommands(id)` destructured at line 300
    - `agentActive` -- state at line 307
    - `isExpert` -- from `useMode()` at line 299

    All variables already exist. No new state or hooks needed.
  </action>
  <verify>
    1. Run `npx tsc --noEmit -p client/tsconfig.json 2>&1 | head -20` -- must show no errors.
    2. Grep ProjectDetail.tsx for "GsdCommandPalette" -- must find import and JSX usage.
    3. Grep ProjectDetail.tsx for "isExpert.*GsdCommandPalette" or verify the isExpert conditional wrapping the palette render.
  </verify>
  <done>
    ProjectDetail imports GsdCommandPalette and renders it conditionally when isExpert is true. Expert mode users can press Cmd+K to open the palette, search commands with fuzzy matching, and select a command to inject its prompt into AgentPanel. Simple mode users see no palette.
  </done>
</task>

</tasks>

<verification>
Phase 16 gap closure verification:

1. **cmdk installed:** `node -e "require.resolve('cmdk')"` succeeds in eluma directory.
2. **Component exists:** `client/src/components/GsdCommandPalette.tsx` exists with 60+ lines.
3. **Keyboard listener:** GsdCommandPalette.tsx contains `metaKey` and `ctrlKey` checks for 'k' key.
4. **Fuzzy matching:** Uses cmdk's built-in fuzzy matching via `Command.Input` + `Command.List` + `Command.Item` with `value` prop.
5. **Expert-only:** ProjectDetail.tsx wraps `<GsdCommandPalette>` in `{isExpert && ...}`.
6. **Prompt injection:** onSelectCommand callback passes built prompt to parent's handleCommandSelect (same path as GsdCommandMenu).
7. **i18n:** Both en.json and de.json have `gsd.command_palette` and `gsd.search_commands` keys.
8. **TypeScript:** `npx tsc --noEmit -p client/tsconfig.json` passes without palette-related errors.
9. **Build:** `npm run build -w client` succeeds.

Re-run the original VERIFICATION.md truth #4 check:
- "In Expert mode, Cmd+K opens a command palette where user can search and execute any GSD command with fuzzy matching" -- should now be VERIFIED.
</verification>

<success_criteria>
- GsdCommandPalette.tsx exists as a complete, functional component using cmdk
- cmdk is in client/package.json dependencies
- Pressing Cmd+K in Expert mode opens the palette dialog
- Typing in the palette filters commands with fuzzy matching
- Selecting a command calls the same onSelectCommand handler as button clicks
- Palette does not render or respond to Cmd+K in Simple mode
- i18n keys exist in both en.json and de.json
- TypeScript compilation passes
- Phase 16 success criteria #4 from ROADMAP is satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/16-gsd-command-registry/16-04-SUMMARY.md`
</output>
