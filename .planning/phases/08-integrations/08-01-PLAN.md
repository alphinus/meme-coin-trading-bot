---
phase: 08-integrations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/types/integration.ts
  - shared/types/events.ts
  - shared/types/ai.ts
  - server/src/integrations/google/auth.ts
  - server/src/integrations/github/client.ts
  - server/src/events/reducers/integration.ts
  - server/src/ai/providers.ts
autonomous: true
user_setup:
  - service: google-oauth
    why: "Gmail and Calendar API access"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client ID"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client Secret"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID (Web application type)"
        location: "Google Cloud Console -> APIs & Services -> Credentials"
      - task: "Enable Gmail API and Google Calendar API"
        location: "Google Cloud Console -> APIs & Services -> Library"
      - task: "Add authorized redirect URI: http://localhost:3000/api/integrations/google/callback"
        location: "Google Cloud Console -> OAuth Client -> Authorized redirect URIs"
  - service: github-token
    why: "GitHub API access for commits, PRs, fork"
    env_vars:
      - name: GITHUB_TOKEN
        source: "GitHub -> Settings -> Developer settings -> Personal access tokens -> Fine-grained tokens"
      - name: GITHUB_WEBHOOK_SECRET
        source: "Generate a random secret (e.g., openssl rand -hex 32) and configure in GitHub webhook settings"

must_haves:
  truths:
    - "All 16+ integration event types and search event type are defined in the shared types"
    - "Google OAuth2 client can generate auth URL and exchange authorization codes for tokens"
    - "Octokit client initializes with GITHUB_TOKEN and provides typed API access"
    - "Integration reducer derives connection state from integration events"
    - "New AI task types (email_routing, email_drafting, code_analysis, search) are registered in the provider map"
    - "AI SDK (ai package) is confirmed present for Plan 08-05 tool-calling"
  artifacts:
    - path: "shared/types/integration.ts"
      provides: "Integration domain types (GoogleAuth state, GitHubLink, EmailDraft, CalendarEvent, SearchQuery, SearchResult)"
      min_lines: 80
    - path: "server/src/integrations/google/auth.ts"
      provides: "Google OAuth2 client setup, auth URL generation, code exchange, token persistence"
      exports: ["getOAuth2Client", "getAuthUrl", "exchangeCode"]
    - path: "server/src/integrations/github/client.ts"
      provides: "Octokit client singleton, typed GitHub API helpers"
      exports: ["getOctokit"]
    - path: "server/src/events/reducers/integration.ts"
      provides: "Integration state reducer for Google/GitHub connection status"
      exports: ["getIntegrationState"]
  key_links:
    - from: "shared/types/events.ts"
      to: "shared/types/integration.ts"
      via: "Event types reference integration domain"
      pattern: "integration\\."
    - from: "server/src/ai/providers.ts"
      to: "TASK_MODEL_MAP"
      via: "New AI task types added to model map"
      pattern: "email_routing|email_drafting|code_analysis|search"
---

<objective>
Install integration dependencies, define all shared types for integrations and search, create the Google OAuth2 auth module, Octokit client module, integration state reducer, and register new AI task types.

Purpose: This is the foundation layer that every subsequent integration plan depends on. Shared types, auth modules, and AI task types must exist before any integration logic can be built.
Output: npm packages installed, shared types defined, Google OAuth + GitHub client modules, integration reducer, updated AI task map.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-integrations/08-RESEARCH.md
@server/src/events/store.ts
@server/src/ai/providers.ts
@shared/types/events.ts
@shared/types/ai.ts
@server/src/events/reducers/project.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, verify AI SDK, and define shared integration types</name>
  <files>
    shared/types/integration.ts
    shared/types/events.ts
    shared/types/ai.ts
    server/package.json
  </files>
  <action>
0. **Verify AI SDK is installed** (critical for Plan 08-05 tool-calling):
   - Check `server/package.json` for the `ai` package (AI SDK). Run: `grep '"ai"' server/package.json`
   - If the `ai` package is NOT present, add it to the npm install command below: `npm install ai`
   - Also verify `zod` is present (needed for AI SDK tool schemas): `grep '"zod"' server/package.json`
   - If `zod` is NOT present, add it to the install command
   - Log the installed AI SDK version for reference: `node -e "console.log(require('ai/package.json').version)"` (run from server/)

1. Install npm packages in server/:
   ```
   cd server && npm install googleapis google-auth-library @octokit/rest @octokit/webhooks mailparser && npm install -D @types/mailparser
   ```
   (Add `ai zod` to the install command if step 0 found them missing)

2. Create `shared/types/integration.ts` with these types:
   - `IntegrationProvider`: union type "google" | "github"
   - `GoogleConnectionState`: { connected: boolean, email?: string, connectedAt?: string, scopes?: string[] }
   - `GitHubConnectionState`: { connected: boolean, username?: string, connectedAt?: string }
   - `IntegrationState`: { google: GoogleConnectionState, github: GitHubConnectionState }
   - `EmailMessage`: { messageId: string, threadId: string, from: string, to: string[], subject: string, snippet: string, body?: string, receivedAt: string }
   - `EmailRoutingSuggestion`: { type: "existing_project" | "unmatched", projectId?: string, projectName?: string, confidence: number, reasoning: string } (mirrors RoutingSuggestion from voice but for email)
   - `EmailDraft`: { id: string, projectId: string, to: string[], subject: string, body: string, status: "pending" | "approved" | "sent" | "rejected", createdAt: string, updatedAt: string, triggerEventId?: string }
   - `CalendarMeeting`: { eventId: string, title: string, description?: string, start: string, end: string, attendees: string[], linkedProjectId?: string, linkedAt?: string }
   - `GitHubRepoLink`: { owner: string, repo: string, projectId: string, linkedAt: string }
   - `GitHubCommitInfo`: { sha: string, message: string, author: string, date: string, repoOwner: string, repoName: string }
   - `GitHubPRInfo`: { number: number, title: string, state: string, url: string, repoOwner: string, repoName: string }
   - `ForkRequest`: { sourceUrl: string, owner: string, repo: string }
   - `ForkResult`: { forkUrl: string, fullName: string, analysisStatus: "pending" | "analyzing" | "complete" | "failed" }
   - `SearchQuery`: { query: string, teamId: string, language: "de" | "en" }
   - `SearchResult`: { answer: string, sources: string[], executedAt: string }

3. Update `shared/types/events.ts`:
   - Add all 17 new event types to the EventType union:
     integration.google_connected, integration.google_disconnected,
     integration.gmail_synced, integration.email_received, integration.email_routed,
     integration.email_draft_created, integration.email_draft_updated, integration.email_sent,
     integration.calendar_synced, integration.calendar_event_linked,
     integration.github_connected, integration.github_disconnected,
     integration.github_webhook_received, integration.github_commit_linked,
     integration.github_pr_linked, integration.github_fork_created,
     integration.github_code_analyzed, search.query_executed
   - Add all 18 strings to the EVENT_TYPES const array

4. Update `shared/types/ai.ts`:
   - Add to AiTaskType union: "email_routing" | "email_drafting" | "code_analysis" | "search"
  </action>
  <verify>
    Run `cd /Users/developer/eluma && npx tsc --noEmit` to confirm types compile without errors.
    Verify `node -e "require('@octokit/rest')"` works in server/ (dependency installed).
    Verify `node -e "require('googleapis')"` works in server/ (dependency installed).
    Verify `node -e "console.log(require('ai/package.json').version)"` works in server/ (AI SDK present).
    Verify `node -e "require('zod')"` works in server/ (Zod present).
  </verify>
  <done>
    All npm packages installed (including AI SDK and Zod confirmed present). shared/types/integration.ts exports 15+ type definitions. events.ts has 18 new event type strings. ai.ts has 4 new task types. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Google OAuth module, Octokit client, integration reducer, and update AI provider map</name>
  <files>
    server/src/integrations/google/auth.ts
    server/src/integrations/github/client.ts
    server/src/events/reducers/integration.ts
    server/src/ai/providers.ts
  </files>
  <action>
1. Create `server/src/integrations/google/auth.ts`:
   - Import `google` from "googleapis", readFileSync/writeFileSync/existsSync/mkdirSync from "fs", path from "path"
   - Constants: DATA_DIR from process.env.DATA_DIR || "./data", CREDENTIALS_DIR = path.join(DATA_DIR, "credentials"), TOKENS_FILE = path.join(CREDENTIALS_DIR, "google-tokens.json")
   - SCOPES array: ["https://www.googleapis.com/auth/gmail.readonly", "https://www.googleapis.com/auth/gmail.send", "https://www.googleapis.com/auth/calendar.readonly"]
   - `getOAuth2Client()`: Returns OAuth2 client with stored tokens, or null if no tokens or no client ID/secret. Attach "tokens" event listener to persist refreshed tokens automatically. Log warning if GOOGLE_CLIENT_ID or GOOGLE_CLIENT_SECRET not set.
   - `getAuthUrl()`: Generate authorization URL with access_type: "offline", prompt: "consent" (forces refresh token)
   - `exchangeCode(code: string)`: Exchange auth code for tokens, mkdirSync CREDENTIALS_DIR, writeFileSync tokens
   - `isGoogleConnected()`: Returns boolean -- checks if TOKENS_FILE exists and has valid content
   - Follow the research pattern from 08-RESEARCH.md exactly (store tokens in DATA_DIR/credentials/, NOT in event store)

2. Create `server/src/integrations/github/client.ts`:
   - Import { Octokit } from "@octokit/rest"
   - Lazy singleton: let _octokit: Octokit | null = null
   - `getOctokit()`: Create Octokit with process.env.GITHUB_TOKEN (warn if not set, still create unauthenticated)
   - `isGitHubConnected()`: Returns boolean -- checks if GITHUB_TOKEN env var is set
   - Export only getOctokit and isGitHubConnected (all specific API calls will be in subsequent plan files)

3. Create `server/src/events/reducers/integration.ts`:
   - Import readEvents from "../store.js", import IntegrationState from shared types
   - `getIntegrationState()`: Read events from "integration" aggregate type, reduce to IntegrationState
   - Handle event types: integration.google_connected (set google.connected=true, capture email), integration.google_disconnected (set google.connected=false), integration.github_connected (set github.connected=true, capture username), integration.github_disconnected (set github.connected=false)
   - Default state: { google: { connected: false }, github: { connected: false } }
   - Follow the same reducer pattern as project.ts (replay events, build state)

4. Update `server/src/ai/providers.ts`:
   - Add 4 new entries to TASK_MODEL_MAP:
     email_routing: "anthropic:fast" (quick classification, same tier as voice_routing)
     email_drafting: "anthropic:balanced" (draft generation needs quality)
     code_analysis: "anthropic:balanced" (code understanding needs quality)
     search: "anthropic:balanced" (natural-language search synthesis)
  </action>
  <verify>
    Run `cd /Users/developer/eluma && npx tsc --noEmit` to confirm all modules compile.
    Grep for "email_routing" in providers.ts to confirm task types added.
    Verify auth.ts exports getOAuth2Client, getAuthUrl, exchangeCode, isGoogleConnected.
    Verify client.ts exports getOctokit, isGitHubConnected.
    Verify integration.ts exports getIntegrationState.
  </verify>
  <done>
    Google OAuth module handles auth URL generation, code exchange, token persistence in DATA_DIR/credentials/ (not event store). Octokit client provides lazy singleton. Integration reducer derives connection state from events. AI provider map has 4 new task types. All TypeScript compiles.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `shared/types/integration.ts` exists with 15+ exported types
- `shared/types/events.ts` contains all 18 new event type strings
- `shared/types/ai.ts` has email_routing, email_drafting, code_analysis, search
- `server/src/integrations/google/auth.ts` exports 4 functions
- `server/src/integrations/github/client.ts` exports 2 functions
- `server/src/events/reducers/integration.ts` exports getIntegrationState
- `server/src/ai/providers.ts` TASK_MODEL_MAP has 4 new entries
- googleapis, google-auth-library, @octokit/rest, @octokit/webhooks, mailparser in server/package.json
- AI SDK (`ai` package) and `zod` confirmed present in server/package.json
</verification>

<success_criteria>
All integration dependencies installed. AI SDK and Zod confirmed present for Plan 08-05. Shared types define the complete domain model for integrations and search. Google OAuth and GitHub client modules ready for use by subsequent plans. Integration reducer functional. AI task types registered. TypeScript compiles cleanly.
</success_criteria>

<output>
After completion, create `.planning/phases/08-integrations/08-01-SUMMARY.md`
</output>
