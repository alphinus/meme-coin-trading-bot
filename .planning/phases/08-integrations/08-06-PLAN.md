---
phase: 08-integrations
plan: 06
type: execute
wave: 3
depends_on: ["08-02", "08-03", "08-04", "08-05"]
files_modified:
  - client/src/hooks/useIntegrations.ts
  - client/src/hooks/useSearch.ts
  - client/src/components/SearchBar.tsx
  - client/src/components/EmailDraftReview.tsx
  - client/src/components/GitHubFork.tsx
  - client/src/components/CalendarWidget.tsx
  - client/src/pages/Integrations.tsx
  - server/src/app.ts
  - client/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User can see integration connection status and connect/disconnect Google and GitHub"
    - "User can view received emails, see AI routing suggestions, and review/approve/send email drafts"
    - "User can input a GitHub URL to fork and see the analysis result as an idea"
    - "User can see calendar meetings linked to projects in the project detail view"
    - "User can type natural-language search queries and see AI-powered results"
    - "All integration and search routes are registered in app.ts"
  artifacts:
    - path: "client/src/hooks/useIntegrations.ts"
      provides: "React hook for integration status, Gmail/Calendar management, GitHub operations"
      exports: ["useIntegrations"]
    - path: "client/src/hooks/useSearch.ts"
      provides: "React hook for AI search with debounced query"
      exports: ["useSearch"]
    - path: "client/src/components/SearchBar.tsx"
      provides: "Global search bar component with AI-powered results"
    - path: "client/src/pages/Integrations.tsx"
      provides: "Integration settings page with connection status, email management, draft review"
    - path: "server/src/app.ts"
      provides: "Updated Express app with integration, calendar, search, and GitHub integration routes"
  key_links:
    - from: "client/src/hooks/useIntegrations.ts"
      to: "/api/integrations"
      via: "fetch calls to integration REST API"
      pattern: "fetch.*api/integrations"
    - from: "client/src/hooks/useSearch.ts"
      to: "/api/search/query"
      via: "fetch POST to search API"
      pattern: "fetch.*api/search"
    - from: "server/src/app.ts"
      to: "server/src/routes/integrations.ts"
      via: "app.use('/api/integrations', ...)"
      pattern: "app\\.use.*api/integrations"
---

<objective>
Wire all integration and search backends to the client UI: create React hooks, components, pages, register all new routes in app.ts, and add navigation -- completing the full Phase 8 feature set.

Purpose: This is the integration layer that makes all Phase 8 functionality accessible to users through the web UI.
Output: Client hooks, UI components (SearchBar, EmailDraftReview, GitHubFork, CalendarWidget), Integrations page, updated app.ts and App.tsx routing.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-integrations/08-01-SUMMARY.md
@.planning/phases/08-integrations/08-02-SUMMARY.md
@.planning/phases/08-integrations/08-03-SUMMARY.md
@.planning/phases/08-integrations/08-04-SUMMARY.md
@.planning/phases/08-integrations/08-05-SUMMARY.md
@server/src/app.ts
@client/src/App.tsx
@client/src/hooks/useProjects.ts
@client/src/hooks/useIdeaPool.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Client hooks and components for integrations and search</name>
  <files>
    client/src/hooks/useIntegrations.ts
    client/src/hooks/useSearch.ts
    client/src/components/SearchBar.tsx
    client/src/components/EmailDraftReview.tsx
    client/src/components/GitHubFork.tsx
    client/src/components/CalendarWidget.tsx
  </files>
  <action>
1. Create `client/src/hooks/useIntegrations.ts`:
   - Follow the pattern of existing hooks (useProjects.ts, useIdeaPool.ts)
   - State: integrationStatus, emails, drafts, linkedRepos, calendarMeetings, loading, error
   - `fetchStatus()`: GET /api/integrations/status
   - `connectGoogle()`: GET /api/integrations/google/auth-url, then window.location.href = authUrl (redirect to Google OAuth)
   - `disconnectGoogle()`: POST /api/integrations/google/disconnect
   - `startGmailPolling()`: POST /api/integrations/gmail/start-polling
   - `stopGmailPolling()`: POST /api/integrations/gmail/stop-polling
   - `fetchEmails()`: GET /api/integrations/emails/recent
   - `routeEmail(messageId)`: GET /api/integrations/emails/:messageId/route -> returns suggestions
   - `confirmRoute(messageId, projectId)`: POST /api/integrations/emails/:messageId/route { projectId }
   - `fetchDrafts()`: GET /api/integrations/emails/drafts
   - `generateDraft(messageId, projectId)`: POST /api/integrations/emails/drafts/generate { messageId, projectId }
   - `sendDraft(draftId)`: POST /api/integrations/emails/drafts/:draftId/send
   - `rejectDraft(draftId)`: POST /api/integrations/emails/drafts/:draftId/reject
   - `linkRepo(owner, repo, projectId)`: POST /api/github-integration/repos/link { owner, repo, projectId }
   - `fetchLinkedRepos(projectId?)`: GET /api/github-integration/repos/linked?projectId=...
   - `fetchCommits(owner, repo)`: GET /api/github-integration/repos/:owner/:repo/commits
   - `fetchPullRequests(owner, repo)`: GET /api/github-integration/repos/:owner/:repo/pulls
   - `forkRepo(sourceUrl)`: POST /api/github-integration/fork { sourceUrl }
   - `fetchMeetings(projectId?)`: GET /api/calendar/meetings?projectId=...
   - `startCalendarPolling()`: POST /api/calendar/start-polling
   - `stopCalendarPolling()`: POST /api/calendar/stop-polling
   - Use apiGet/apiPost helpers from existing api utility if available, or use fetch with credentials: "include"

2. Create `client/src/hooks/useSearch.ts`:
   - State: query, results (SearchResult | null), loading, error, history
   - `search(query: string)`: POST /api/search/query { query, language } -> returns SearchResult
   - `fetchHistory()`: GET /api/search/history -> returns recent queries
   - Debounce: do NOT auto-search on typing. Only search on explicit submit (button or Enter key).
   - Export useSearch

3. Create `client/src/components/SearchBar.tsx`:
   - Text input with search icon, submit button
   - On submit, calls search(query) from useSearch hook
   - Displays results: answer text in a card, sources as collapsible list below
   - Loading spinner while searching
   - Position: designed to be placed in the navigation bar or as a standalone component
   - Tailwind styling: w-full max-w-2xl, rounded input, shadow on focus

4. Create `client/src/components/EmailDraftReview.tsx`:
   - Props: draft (EmailDraft)
   - Display: To, Subject, Body (in a styled email preview card)
   - Actions: "Approve & Send" button (green), "Reject" button (red)
   - On approve: calls sendDraft(draft.id) from useIntegrations
   - On reject: calls rejectDraft(draft.id)
   - Status badge: pending (yellow), sent (green), rejected (gray)

5. Create `client/src/components/GitHubFork.tsx`:
   - Text input for GitHub URL (placeholder: "https://github.com/owner/repo")
   - "Fork & Analyze" button
   - On submit: validate URL format (must contain github.com), call forkRepo(url)
   - Show status: "Forking...", "Analyzing code...", "Complete - idea created" or "Failed"
   - When complete, show link to the created idea in the Idea Pool

6. Create `client/src/components/CalendarWidget.tsx`:
   - Props: projectId (optional)
   - Fetches meetings for the given projectId (or all meetings if none)
   - Displays meetings as a vertical list: title, date/time, attendees count, linked project badge
   - Upcoming meetings highlighted
   - "Link to project" button for unlinked meetings (opens project selector)
   - Compact design suitable for embedding in ProjectDetail page sidebar
  </action>
  <verify>
    Run `cd /Users/developer/eluma && npx tsc --noEmit` -- zero errors.
    Verify useIntegrations.ts exports useIntegrations hook.
    Verify useSearch.ts exports useSearch hook.
    Verify all 4 components exist and are importable.
  </verify>
  <done>
    useIntegrations hook provides complete API for all integration operations. useSearch hook handles AI search. SearchBar shows search input + AI results. EmailDraftReview displays draft with approve/reject actions. GitHubFork handles URL input and fork workflow. CalendarWidget shows meetings linked to projects. All TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrations page, route registration, and app wiring</name>
  <files>
    client/src/pages/Integrations.tsx
    server/src/app.ts
    client/src/App.tsx
  </files>
  <action>
1. Create `client/src/pages/Integrations.tsx`:
   - Full-page integration management dashboard with sections:

   **Connection Status** (top section):
   - Google card: Show connected/disconnected status, email if connected. "Connect Google" button (calls connectGoogle) or "Disconnect" button. When connected, show "Start Gmail Polling" / "Stop Gmail Polling" buttons, and "Start Calendar Sync" / "Stop Calendar Sync" buttons.
   - GitHub card: Show connected/disconnected status with username. Note: GitHub uses env var token (no OAuth flow needed in UI). Show "Connected" badge if GITHUB_TOKEN is set.

   **Email Inbox** (section, visible when Google connected):
   - List of recent emails from fetchEmails()
   - Each email row: from, subject, snippet, received date
   - Click email -> shows AI routing suggestions (call routeEmail)
   - "Route to Project" button with project dropdown
   - "Generate Reply Draft" button

   **Email Drafts** (section):
   - List of pending drafts from fetchDrafts()
   - Each draft rendered with EmailDraftReview component
   - Tabs: Pending | Sent | Rejected

   **GitHub Fork** (section):
   - GitHubFork component embedded
   - Below: list of recently analyzed repos (from integration events)

   **Calendar Meetings** (section, visible when Google connected):
   - CalendarWidget component (no projectId filter -- shows all)
   - Upcoming meetings highlighted

   **AI Search** (section):
   - SearchBar component embedded
   - Search history below (from useSearch.fetchHistory)

   Use Tailwind: grid layout, cards with shadows, responsive (1 col mobile, 2 col lg)

2. Update `server/src/app.ts`:
   - Add imports for new routers:
     ```
     import integrationsRouter from "./routes/integrations.js";
     import calendarRouter from "./routes/calendar.js";
     import searchRouter from "./routes/search.js";
     import githubIntegrationRouter from "./routes/github-integration.js";
     ```
   - Register routes (after existing protected routes):
     ```
     app.use("/api/integrations", requireAuth, integrationsRouter);
     app.use("/api/calendar", requireAuth, calendarRouter);
     app.use("/api/search", requireAuth, searchRouter);
     app.use("/api/github-integration", requireAuth, githubIntegrationRouter);
     ```
   - Note: GitHub webhooks route (/api/github-integration/webhooks) needs to bypass auth. Either handle this inside the router (check path and skip auth), or mount webhooks route separately BEFORE requireAuth like the Telegram webhook pattern:
     ```
     // GitHub webhooks BEFORE auth (like Telegram pattern)
     app.use("/api/github-webhooks", githubWebhookRouter);
     ```
     Or just handle it in the github-integration router by making the webhook handler not depend on req.session.
   - Import and start polling in the async IIFE at the bottom (alongside Telegram bot setup):
     ```
     // Start integration polling if configured
     import { startGmailPolling } from "./integrations/google/gmail.js";
     import { startCalendarPolling } from "./integrations/google/calendar.js";
     ```
     In the async IIFE, after bot setup, check if Google is connected and start polling.
     Actually, better: do NOT auto-start polling at server startup. Let users start polling via the UI (POST /gmail/start-polling, POST /calendar/start-polling). This avoids errors when tokens aren't configured yet.

3. Update `client/src/App.tsx`:
   - Import Integrations page
   - Add route: <Route path="/integrations" element={<Integrations />} />
   - Add navigation link for "Integrations" in the nav bar (follow existing nav pattern -- check App.tsx for NavLink or sidebar structure)
   - Add SearchBar component in the navigation header area (if there's a top bar) for global access. If no top bar exists, add it as a prominent feature on the Dashboard or Integrations page only.
  </action>
  <verify>
    Run `cd /Users/developer/eluma && npx tsc --noEmit` -- zero errors.
    Run `cd /Users/developer/eluma && npm run build` (or equivalent) to verify client builds.
    Grep for "/api/integrations" in app.ts to confirm route registered.
    Grep for "/api/calendar" in app.ts.
    Grep for "/api/search" in app.ts.
    Grep for "/api/github-integration" in app.ts.
    Grep for "/integrations" in App.tsx to confirm client route.
    Grep for "SearchBar" in App.tsx or Integrations.tsx.
  </verify>
  <done>
    Integrations page shows connection status, email inbox with AI routing, email draft review, GitHub fork, calendar meetings, and AI search. All 4 new route groups registered in app.ts. Client route /integrations added with nav link. SearchBar accessible. Full Phase 8 UI wired.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 8: External Integrations and AI Search. Gmail polling with AI email routing and draft generation. Google Calendar sync with project linking and post-meeting prompts. GitHub commits/PRs linked to projects, fork + AI code analysis feeding into idea pool. AI-powered natural-language search using tool-calling over the event store. Full Integrations page UI with all features accessible.
  </what-built>
  <how-to-verify>
    1. Navigate to /integrations page -- verify all sections render (Connection Status, Email, GitHub Fork, Calendar, AI Search)
    2. If Google OAuth credentials configured: click "Connect Google" and verify OAuth redirect flow
    3. In the AI Search section, type "show me all projects" and verify it returns a meaningful AI-generated answer using tool-calling
    4. In the GitHub Fork section, enter a small public repo URL (e.g., https://github.com/sindresorhus/is) and click "Fork & Analyze" -- verify the fork initiates and analysis creates an idea
    5. Check that /api/integrations/status returns proper JSON with google/github connection states
    6. Check that /api/search/query with POST { query: "list all ideas" } returns AI-generated results
    7. Verify TypeScript compiles: `npx tsc --noEmit` passes
    8. Verify the app starts: `npm run dev` runs without crash
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- All 4 new route groups registered in app.ts
- Integrations page accessible at /integrations
- SearchBar component functional
- Email draft review flow works (list, approve, send/reject)
- GitHub fork + analysis creates idea pool entry
- Calendar meetings show with project links
</verification>

<success_criteria>
Full Phase 8 UI complete. All 6 requirements verifiable through the web interface:
- INTG-01: Emails in inbox with AI routing suggestions
- INTG-02: Calendar meetings linked to projects, post-meeting prompts
- INTG-03: GitHub commits/PRs visible for linked repos
- INTG-04: GitHub fork + AI analysis -> idea pool
- INTG-05: Email drafts reviewable, approvable, sendable
- SRCH-01: Natural-language search with AI-powered results
</success_criteria>

<output>
After completion, create `.planning/phases/08-integrations/08-06-SUMMARY.md`
</output>
