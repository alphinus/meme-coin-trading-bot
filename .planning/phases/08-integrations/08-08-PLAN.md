---
phase: 08-integrations
plan: 08
type: execute
wave: 4
depends_on: ["08-06", "08-07"]
files_modified:
  - client/src/pages/Integrations.tsx
  - server/src/app.ts
  - client/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User can see the Integrations page with all sections: connection status, email inbox, drafts, GitHub fork, calendar, search"
    - "All integration and search routes are registered in app.ts"
    - "GitHub webhooks are mounted BEFORE requireAuth in app.ts (like Telegram webhook pattern)"
    - "User can navigate to /integrations from the app navigation"
  artifacts:
    - path: "client/src/pages/Integrations.tsx"
      provides: "Integration settings page with connection status, email management, draft review, GitHub fork, calendar, search"
    - path: "server/src/app.ts"
      provides: "Updated Express app with integration, calendar, search, and GitHub integration routes"
    - path: "client/src/App.tsx"
      provides: "Updated React app with /integrations route and nav link"
  key_links:
    - from: "server/src/app.ts"
      to: "server/src/routes/integrations.ts"
      via: "app.use('/api/integrations', requireAuth, integrationsRouter)"
      pattern: "app\\.use.*api/integrations"
    - from: "server/src/app.ts"
      to: "server/src/routes/github-integration.ts"
      via: "GitHub webhook route mounted BEFORE requireAuth, protected routes after"
      pattern: "github.*webhook|api/github"
    - from: "client/src/App.tsx"
      to: "client/src/pages/Integrations.tsx"
      via: "Route path /integrations"
      pattern: "/integrations"
---

<objective>
Assemble the Integrations page, register all server routes in app.ts, wire client routing, and verify the full Phase 8 feature set.

Purpose: This is the final wiring that makes all Phase 8 functionality accessible to users. Brings together all hooks, components, and routes.
Output: Integrations page, updated app.ts with all integration routes, updated App.tsx with routing and navigation.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-integrations/08-06-SUMMARY.md
@.planning/phases/08-integrations/08-07-SUMMARY.md
@server/src/app.ts
@client/src/App.tsx
@client/src/hooks/useIntegrations.ts
@client/src/hooks/useSearch.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrations page and server/client route wiring</name>
  <files>
    client/src/pages/Integrations.tsx
    server/src/app.ts
    client/src/App.tsx
  </files>
  <action>
1. Create `client/src/pages/Integrations.tsx`:
   - Full-page integration management dashboard with sections:

   **Connection Status** (top section):
   - Google card: Show connected/disconnected status, email if connected. "Connect Google" button (calls connectGoogle) or "Disconnect" button. When connected, show "Start Gmail Polling" / "Stop Gmail Polling" buttons, and "Start Calendar Sync" / "Stop Calendar Sync" buttons.
   - GitHub card: Show connected/disconnected status with username. Note: GitHub uses env var token (no OAuth flow needed in UI). Show "Connected" badge if GITHUB_TOKEN is set.

   **Email Inbox** (section, visible when Google connected):
   - List of recent emails from fetchEmails()
   - Each email row: from, subject, snippet, received date
   - Click email -> shows AI routing suggestions (call routeEmail)
   - "Route to Project" button with project dropdown
   - "Generate Reply Draft" button

   **Email Drafts** (section):
   - List of pending drafts from fetchDrafts()
   - Each draft rendered with EmailDraftReview component
   - Tabs: Pending | Sent | Rejected

   **GitHub Fork** (section):
   - GitHubFork component embedded
   - Below: list of recently analyzed repos (from integration events)

   **Calendar Meetings** (section, visible when Google connected):
   - CalendarWidget component (no projectId filter -- shows all)
   - Upcoming meetings highlighted

   **AI Search** (section):
   - SearchBar component embedded
   - Search history below (from useSearch.fetchHistory)

   Use Tailwind: grid layout, cards with shadows, responsive (1 col mobile, 2 col lg)

2. Update `server/src/app.ts`:
   - Add imports for new routers:
     ```
     import integrationsRouter from "./routes/integrations.js";
     import calendarRouter from "./routes/calendar.js";
     import searchRouter from "./routes/search.js";
     import githubIntegrationRouter from "./routes/github-integration.js";
     ```
   - **GitHub webhooks BEFORE auth** (following the established Telegram webhook pattern):
     Mount the GitHub webhook endpoint BEFORE the requireAuth middleware, just like Telegram webhooks:
     ```
     // GitHub webhooks - raw body needed, no auth (comes from GitHub)
     // Mount BEFORE requireAuth, same pattern as Telegram webhook
     app.post("/api/github-webhooks", express.raw({ type: "application/json" }), (req, res) => {
       // delegate to handleGitHubWebhook
       import("./integrations/github/webhooks.js").then(m => m.handleGitHubWebhook(req, res));
     });
     ```
     This ensures GitHub webhook requests bypass auth and get the raw body they need for signature verification.

   - Register protected routes (after existing protected routes):
     ```
     app.use("/api/integrations", requireAuth, integrationsRouter);
     app.use("/api/calendar", requireAuth, calendarRouter);
     app.use("/api/search", requireAuth, searchRouter);
     app.use("/api/github-integration", requireAuth, githubIntegrationRouter);
     ```

   - Do NOT auto-start polling at server startup. Let users start polling via the UI.

3. Update `client/src/App.tsx`:
   - Import Integrations page
   - Add route: <Route path="/integrations" element={<Integrations />} />
   - Add navigation link for "Integrations" in the nav bar (follow existing nav pattern)
   - Add SearchBar component in the navigation header area if a top bar exists. If no top bar, add it prominently on the Integrations page only.
  </action>
  <verify>
    Run `cd /Users/developer/eluma && npx tsc --noEmit` -- zero errors.
    Run `cd /Users/developer/eluma && npm run build` (or equivalent) to verify client builds.
    Grep for "/api/integrations" in app.ts to confirm route registered.
    Grep for "/api/calendar" in app.ts.
    Grep for "/api/search" in app.ts.
    Grep for "/api/github-integration" in app.ts.
    Grep for "github-webhooks" in app.ts to confirm webhook route is before auth.
    Grep for "/integrations" in App.tsx to confirm client route.
    Grep for "SearchBar" in App.tsx or Integrations.tsx.
  </verify>
  <done>
    Integrations page shows all sections. All 4 new route groups registered in app.ts. GitHub webhooks mounted before requireAuth (Telegram pattern). Client route /integrations added with nav link. Full Phase 8 UI wired.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 8: External Integrations and AI Search. Gmail polling with AI email routing and draft generation. Google Calendar sync with project linking and post-meeting prompts. GitHub commits/PRs linked to projects, fork + AI code analysis feeding into idea pool. AI-powered natural-language search using tool-calling over the event store. Full Integrations page UI with all features accessible.
  </what-built>
  <how-to-verify>
    1. Navigate to /integrations page -- verify all sections render (Connection Status, Email, GitHub Fork, Calendar, AI Search)
    2. If Google OAuth credentials configured: click "Connect Google" and verify OAuth redirect flow
    3. In the AI Search section, type "show me all projects" and verify it returns a meaningful AI-generated answer using tool-calling
    4. In the GitHub Fork section, enter a small public repo URL (e.g., https://github.com/sindresorhus/is) and click "Fork & Analyze" -- verify the fork initiates and analysis creates an idea
    5. Check that /api/integrations/status returns proper JSON with google/github connection states
    6. Check that /api/search/query with POST { query: "list all ideas" } returns AI-generated results
    7. Verify TypeScript compiles: `npx tsc --noEmit` passes
    8. Verify the app starts: `npm run dev` runs without crash
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- All 4 new route groups registered in app.ts
- GitHub webhooks mounted BEFORE requireAuth
- Integrations page accessible at /integrations
- SearchBar component functional
- Email draft review flow works (list, approve, send/reject)
- GitHub fork + analysis creates idea pool entry
- Calendar meetings show with project links
</verification>

<success_criteria>
Full Phase 8 UI complete. All 6 requirements verifiable through the web interface:
- INTG-01: Emails in inbox with AI routing suggestions
- INTG-02: Calendar meetings linked to projects, post-meeting prompts
- INTG-03: GitHub commits/PRs visible for linked repos
- INTG-04: GitHub fork + AI analysis -> idea pool
- INTG-05: Email drafts reviewable, approvable, sendable
- SRCH-01: Natural-language search with AI-powered results
</success_criteria>

<output>
After completion, create `.planning/phases/08-integrations/08-08-SUMMARY.md`
</output>
