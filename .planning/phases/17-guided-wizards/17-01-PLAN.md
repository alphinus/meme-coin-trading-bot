---
phase: 17-guided-wizards
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/components/wizards/WizardShell.tsx
  - client/src/components/wizards/WizardStepIndicator.tsx
  - shared/types/wizard.ts
  - server/src/workflow/gsd-questions.ts
  - server/src/middleware/quality-gate.ts
  - server/src/routes/projects.ts
  - server/src/routes/ideas.ts
  - client/src/i18n/locales/en.json
  - client/src/i18n/locales/de.json
autonomous: true

must_haves:
  truths:
    - "WizardShell renders a step indicator, back/next navigation, and step content using the same visual pattern as Setup.tsx"
    - "MANDATORY_GSD_QUESTIONS constant defines the curated subset of questions required before project creation"
    - "POST /api/projects returns 400 with missing-question details when quality gate is not satisfied"
    - "Idea graduation route rejects graduation when mandatory GSD questions are unanswered"
  artifacts:
    - path: "client/src/components/wizards/WizardShell.tsx"
      provides: "Reusable wizard container with step state, data accumulation, back/next/cancel"
      min_lines: 50
    - path: "client/src/components/wizards/WizardStepIndicator.tsx"
      provides: "Step circles with completed/active/future states extracted from Setup.tsx"
      min_lines: 30
    - path: "shared/types/wizard.ts"
      provides: "WizardStep, WizardStepProps, GsdQuestion, QualityGateResult types"
    - path: "server/src/workflow/gsd-questions.ts"
      provides: "MANDATORY_GSD_QUESTIONS array and getMandatoryGsdQuestions() function"
    - path: "server/src/middleware/quality-gate.ts"
      provides: "checkQualityGate() function returning QualityGateResult"
  key_links:
    - from: "client/src/components/wizards/WizardShell.tsx"
      to: "client/src/components/wizards/WizardStepIndicator.tsx"
      via: "import and render"
      pattern: "WizardStepIndicator"
    - from: "server/src/middleware/quality-gate.ts"
      to: "server/src/workflow/gsd-questions.ts"
      via: "import MANDATORY_GSD_QUESTIONS"
      pattern: "getMandatoryGsdQuestions"
    - from: "server/src/routes/projects.ts"
      to: "server/src/middleware/quality-gate.ts"
      via: "quality gate check in POST handler"
      pattern: "checkQualityGate"
---

<objective>
Build the foundation for all Phase 17 wizard flows: a reusable WizardShell component extracted from Setup.tsx's pattern, shared wizard types, the GSD mandatory questions definition, and server-side quality gate middleware that enforces question completion on project creation and idea graduation.

Purpose: All three wizard flows (onboarding, idea creation, idea-to-project) depend on the WizardShell container. The quality gate middleware must exist before the idea-to-project wizard can enforce GATE-01/GATE-02. Building both foundations in one plan removes blockers for Plans 02 and 03.

Output: WizardShell.tsx, WizardStepIndicator.tsx, shared/types/wizard.ts, gsd-questions.ts, quality-gate.ts, updated project and idea routes with gate enforcement, i18n foundation keys.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-guided-wizards/17-RESEARCH.md

# Source patterns
@client/src/pages/Setup.tsx
@server/src/workflow/definitions.ts
@server/src/routes/projects.ts
@server/src/routes/ideas.ts
@server/src/idea-pool/graduation.ts
@shared/types/workflow.ts
@server/src/middleware/validate.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WizardShell, WizardStepIndicator, and shared wizard types</name>
  <files>
    client/src/components/wizards/WizardShell.tsx
    client/src/components/wizards/WizardStepIndicator.tsx
    shared/types/wizard.ts
    client/src/i18n/locales/en.json
    client/src/i18n/locales/de.json
  </files>
  <action>
    **1. Create shared/types/wizard.ts** with these types:

    ```typescript
    export interface WizardStep {
      id: string;
      labelKey: string; // i18n key for step label in indicator
      component: React.ComponentType<WizardStepProps>;
    }

    export interface WizardStepProps {
      onComplete: (data?: Record<string, unknown>) => void;
      onBack?: () => void;
      wizardData: Record<string, unknown>;
    }

    // GSD question definition for quality gate
    export interface GsdMandatoryQuestion {
      id: string;           // matches step ID from workflow definitions
      titleKey: string;     // i18n key
      descriptionKey: string;
      type: "text" | "choice";
      required: boolean;
      options?: { value: string; labelKey: string }[];
      validation?: { minLength?: number; maxLength?: number };
    }

    // Quality gate check result
    export interface QualityGateResult {
      passed: boolean;
      questions: Array<{
        questionId: string;
        questionKey: string;
        answered: boolean;
      }>;
      answeredCount: number;
      totalRequired: number;
    }
    ```

    Note: WizardStep and WizardStepProps use React types. Since shared/ types are used by both client and server, define them with `React.ComponentType` only if React types are available, otherwise use `any` for the component type and let the client-side code narrow it. Check how existing shared types handle React -- if they don't import React, use a generic approach:
    ```typescript
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    component: any; // React.ComponentType<WizardStepProps> -- typed at usage site
    ```

    **2. Create client/src/components/wizards/WizardStepIndicator.tsx** -- Extract directly from Setup.tsx lines 47-81:

    ```typescript
    interface WizardStepIndicatorProps {
      steps: Array<{ id: string; labelKey: string }>;
      currentIndex: number; // 0-based
    }
    ```

    - Render step circles with completed (green, checkmark), active (blue, number), future (gray, number) states
    - Step labels use `t(step.labelKey)` via `useTranslation()` from react-i18next (per CLAUDE.md: `useTranslation` not `useLanguage` -- actually check the project convention: Setup.tsx uses `useLanguage` which wraps useTranslation. Follow existing convention with `useLanguage` for consistency.)
    - Use `useLanguage` hook for `t()` (matches Setup.tsx, IdeaPool, Dashboard pattern)
    - Step lines between circles
    - All styles as inline `React.CSSProperties` (project convention)

    **3. Create client/src/components/wizards/WizardShell.tsx** -- Generic wizard container:

    ```typescript
    interface WizardShellProps {
      steps: WizardStep[];
      onComplete: (allData: Record<string, unknown>) => void;
      onCancel?: () => void;
      titleKey?: string; // i18n key for wizard title
    }
    ```

    Implementation:
    - `useState(0)` for currentStep (0-based index)
    - `useState<Record<string, unknown>>({})` for accumulated wizardData
    - `goNext(stepData?)` merges stepData into wizardData, increments step or calls onComplete on last step
    - `goBack()` decrements step (min 0)
    - Renders: optional title via `t(titleKey)`, WizardStepIndicator, step content with `key={steps[currentStep].id}` for remount, cancel button
    - Inline `React.CSSProperties` matching Setup.tsx card styling (white bg, rounded, shadow, centered, max-width 600px)

    **4. Add i18n foundation keys** to both en.json and de.json:
    - `wizard.cancel`: "Cancel" / "Abbrechen"
    - `wizard.back`: "Back" / "Zurück"
    - `wizard.next`: "Next" / "Weiter"
    - `wizard.finish`: "Finish" / "Fertig"
    - `wizard.step_of`: "Step {{current}} of {{total}}" / "Schritt {{current}} von {{total}}"

    Add these under a new `"wizard"` top-level key in both locale files.
  </action>
  <verify>
    - `npx tsc --noEmit` passes (no type errors)
    - `ls client/src/components/wizards/WizardShell.tsx client/src/components/wizards/WizardStepIndicator.tsx shared/types/wizard.ts` all exist
    - Both en.json and de.json contain `"wizard"` key with sub-keys
  </verify>
  <done>
    WizardShell renders step indicator, navigates between steps, accumulates data, and calls onComplete. WizardStepIndicator shows completed/active/future step circles with i18n labels. Shared types exported for use by all wizard implementations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Define GSD mandatory questions and create quality gate middleware</name>
  <files>
    server/src/workflow/gsd-questions.ts
    server/src/middleware/quality-gate.ts
    server/src/routes/projects.ts
    server/src/routes/ideas.ts
    client/src/i18n/locales/en.json
    client/src/i18n/locales/de.json
  </files>
  <action>
    **1. Create server/src/workflow/gsd-questions.ts:**

    Define `MANDATORY_GSD_QUESTIONS` -- a curated subset of questions from the pre-decision-point workflow phases (idea, feasibility, effort_estimate) that must be answered before a project can be created. Reference the existing step definitions in `server/src/workflow/definitions.ts` for IDs and structure.

    Select these mandatory questions (all `required: true` steps from phases 1-3):
    - `idea_describe` (text_input: describe the idea)
    - `idea_problem` (text_input: problem statement)
    - `idea_target` (text_input: target audience)
    - `feas_technical` (button_choice: technical feasibility)
    - `feas_resources` (button_choice: resource availability)
    - `effort_scope` (button_choice: project scope/size)

    Skip non-required steps (feas_constraints), auto_advance steps (idea_confirm), and AI-generated steps (feas_assessment) since those are system-driven, not user-answered.

    ```typescript
    export interface MandatoryQuestion {
      id: string;
      titleKey: string;
      descriptionKey: string;
      type: "text" | "choice";
      options?: Array<{ value: string; labelKey: string }>;
      validation?: { minLength?: number; maxLength?: number };
    }

    export const MANDATORY_GSD_QUESTIONS: MandatoryQuestion[] = [ ... ];

    export function getMandatoryGsdQuestions(): MandatoryQuestion[] {
      return MANDATORY_GSD_QUESTIONS;
    }
    ```

    **2. Create server/src/middleware/quality-gate.ts:**

    ```typescript
    import { getMandatoryGsdQuestions } from "../workflow/gsd-questions.js";
    import { readEvents } from "../events/store.js";
    import type { QualityGateResult } from "shared/types/wizard.js";

    /**
     * Check if all mandatory GSD questions have been answered for an idea or project.
     * Looks at workflow.step_completed events where the step ID matches a mandatory question.
     *
     * For idea-to-project: check events on the idea's aggregateId (idea events store GSD answers)
     * For direct project creation: check gsdAnswers passed in request body
     */
    export async function checkQualityGate(
      source: "idea" | "direct",
      sourceId: string,
      inlineAnswers?: Record<string, unknown>
    ): Promise<QualityGateResult> { ... }
    ```

    Implementation approach:
    - For `source === "idea"`: Read idea events to find `idea.refinement_answered` events. Also check if the idea has `readinessScore >= 75` (already has the AI-assessed readiness). The quality gate checks that for each mandatory question, there is either (a) a matching answer in the idea's refinement data, or (b) the answer was provided inline.
    - For `source === "direct"`: Check that `inlineAnswers` contains an entry for each mandatory question ID.
    - Return `QualityGateResult` with `passed`, per-question status, counts.

    **Alternative simpler approach (recommended):** Since this is a new gate, and the existing graduation flow does not collect per-question structured answers, take a pragmatic approach:
    - Add a new optional field `gsdAnswers: Record<string, string>` to the project creation schema and graduation execution.
    - The quality gate checks that `gsdAnswers` contains a non-empty value for each mandatory question ID.
    - The IdeaToProjectWizard (Plan 03) will collect these answers and pass them in the request.

    **3. Update server/src/routes/projects.ts:**
    - Extend `createProjectSchema` to accept optional `gsdAnswers: z.record(z.string(), z.string()).optional()`
    - In the POST handler, after Zod validation, call `checkQualityGate("direct", "", body.gsdAnswers)`. If `!result.passed`, return `400` with `{ error: "Quality gate not passed", gate: result }`.
    - Existing project creation without gsdAnswers still works but now returns 400 unless gsdAnswers is provided (GATE-02 enforcement).

    **4. Update server/src/routes/ideas.ts:**
    - In the graduation execution route (POST `/:id/graduate`), before calling `executeGraduation()`, call `checkQualityGate("idea", ideaId, body.gsdAnswers)`. If not passed, return 400 with gate details (GATE-01 enforcement).
    - Add `gsdAnswers` to the graduation request body schema.

    **5. Add i18n keys** for quality gate messages:
    - `wizard.gate.blocked`: "All questions must be answered before creating a project" / "Alle Fragen müssen beantwortet werden, bevor ein Projekt erstellt werden kann"
    - `wizard.gate.progress`: "{{answered}} of {{total}} questions answered" / "{{answered}} von {{total}} Fragen beantwortet"
    - `wizard.gate.missing`: "Missing answers" / "Fehlende Antworten"
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `ls server/src/workflow/gsd-questions.ts server/src/middleware/quality-gate.ts` both exist
    - `MANDATORY_GSD_QUESTIONS` array has 6 entries
    - Project creation without gsdAnswers would return 400 (quality gate blocks)
  </verify>
  <done>
    MANDATORY_GSD_QUESTIONS defines 6 curated pre-decision-point questions. Quality gate middleware validates answers. Project creation and idea graduation routes enforce the gate -- returning 400 with detailed missing-question info when gate is not satisfied. Quality gate applies identically regardless of mode (GATE-03).
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- TypeScript compiles clean
2. WizardShell.tsx and WizardStepIndicator.tsx exist in `client/src/components/wizards/`
3. `shared/types/wizard.ts` exports WizardStep, WizardStepProps, GsdMandatoryQuestion, QualityGateResult
4. `server/src/workflow/gsd-questions.ts` exports MANDATORY_GSD_QUESTIONS with 6 entries
5. `server/src/middleware/quality-gate.ts` exports checkQualityGate
6. POST /api/projects now requires gsdAnswers to pass quality gate
7. POST /api/ideas/:id/graduate now requires gsdAnswers to pass quality gate
8. Both en.json and de.json have wizard.* keys
</verification>

<success_criteria>
- WizardShell can be instantiated with an array of steps and renders step indicator + step content + navigation
- Quality gate blocks project creation and idea graduation when mandatory questions are unanswered
- All new strings use i18n keys in both DE and EN
- No new npm dependencies added
</success_criteria>

<output>
After completion, create `.planning/phases/17-guided-wizards/17-01-SUMMARY.md`
</output>
