---
phase: 05-gsd-workflow-engine
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - server/src/app.ts
  - client/src/pages/ProjectDetail.tsx
  - client/src/i18n/locales/en.json
  - client/src/i18n/locales/de.json
autonomous: false

must_haves:
  truths:
    - "Workflow API is accessible at /api/workflow/:projectId (route registered in app.ts)"
    - "ProjectDetail renders WorkflowEngine for the current active phase instead of PhaseContent form"
    - "PhaseContent still renders for completed phases in read-only mode when clicking timeline"
    - "PhaseManagement advance button is hidden when workflow engine is active for current phase"
    - "All workflow UI strings have English and German translations"
    - "Legacy projects (no workflow events) show WorkflowEngine starting at their current phase's first step"
    - "Decision point Go leads to pipeline entry, No-Go archives, Defer keeps project at decision_point"
  artifacts:
    - path: "server/src/app.ts"
      provides: "Workflow route registration under /api/workflow"
      contains: "workflowRouter"
    - path: "client/src/pages/ProjectDetail.tsx"
      provides: "WorkflowEngine integration replacing PhaseContent for active phase"
      contains: "WorkflowEngine"
    - path: "client/src/i18n/locales/en.json"
      provides: "English translations for all workflow step titles, descriptions, button labels"
      contains: "workflow"
    - path: "client/src/i18n/locales/de.json"
      provides: "German translations for all workflow step titles, descriptions, button labels"
      contains: "workflow"
  key_links:
    - from: "server/src/app.ts"
      to: "server/src/routes/workflow.ts"
      via: "app.use('/api/workflow', requireAuth, workflowRouter)"
      pattern: "workflowRouter"
    - from: "client/src/pages/ProjectDetail.tsx"
      to: "client/src/components/workflow/WorkflowEngine.tsx"
      via: "Conditional render: WorkflowEngine for current phase, PhaseContent for history"
      pattern: "WorkflowEngine|PhaseContent"
    - from: "client/src/pages/ProjectDetail.tsx"
      to: "client/src/hooks/useProject.ts"
      via: "refresh() called after WorkflowEngine signals phase advance"
      pattern: "refresh|onPhaseAdvanced"
---

<objective>
Wire the workflow engine into the application: register the API route in app.ts, integrate WorkflowEngine into ProjectDetail (replacing PhaseContent for the active phase while preserving read-only history), add all i18n translations for workflow strings, and verify the end-to-end flow.

Purpose: This is the integration plan that connects Plans 01 and 02 into a working feature. After this plan, users see a guided, button-driven workflow instead of the old freeform phase forms for the current phase.

Output: Fully integrated GSD workflow engine accessible from the ProjectDetail page with complete DE/EN translations.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-gsd-workflow-engine/05-RESEARCH.md
@.planning/phases/05-gsd-workflow-engine/05-01-SUMMARY.md
@.planning/phases/05-gsd-workflow-engine/05-02-SUMMARY.md

# Source files for integration
@server/src/app.ts
@client/src/pages/ProjectDetail.tsx
@client/src/components/PhaseContent.tsx
@client/src/components/PhaseManagement.tsx
@client/src/i18n/locales/en.json
@client/src/i18n/locales/de.json
@client/src/hooks/useProject.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register workflow route, integrate WorkflowEngine into ProjectDetail, add i18n</name>
  <files>
    server/src/app.ts
    client/src/pages/ProjectDetail.tsx
    client/src/i18n/locales/en.json
    client/src/i18n/locales/de.json
  </files>
  <action>
    **A. Register workflow route in `server/src/app.ts`:**
    - Add import: `import workflowRouter from "./routes/workflow.js";`
    - Add route registration after the ai router line: `app.use("/api/workflow", requireAuth, workflowRouter);`
    - Place it before the error handling middleware, alongside other protected routes.

    **B. Integrate WorkflowEngine into `client/src/pages/ProjectDetail.tsx`:**

    Key changes to ProjectDetail:
    1. Import WorkflowEngine: `import { WorkflowEngine } from "../components/workflow/WorkflowEngine.js";`
    2. The rendering logic changes for the left column (main content area):
       - **When viewing a completed phase (viewingPhase is set):** Continue to render PhaseContent in read-only mode (existing behavior, unchanged)
       - **When viewing the current active phase (viewingPhase is null):** Render WorkflowEngine instead of PhaseContent
       - **When project is archived:** Continue to render PhaseContent in read-only mode (existing behavior)
    3. The PhaseManagement panel: **Hide** when WorkflowEngine is active (i.e., when viewingPhase is null and project is not archived). The workflow engine handles progression internally. PhaseManagement is only shown when viewing completed phase history.
    4. Add an `onPhaseAdvanced` callback that:
       - Calls `refresh()` from the useProject hook to reload project state
       - Resets `viewingPhase` to null
       - This ensures the project header badge, timeline, and KPI sidebar update after a phase advance

    Specific code pattern for the left column render:
    ```tsx
    {/* Left column: Workflow or Phase content */}
    <div style={pageStyles.mainColumn}>
      <div style={pageStyles.section}>
        <h2 style={pageStyles.sectionTitle}>
          {viewingPhase
            ? t(PHASE_CONFIG[viewingPhase].labelKey)
            : t(currentPhaseConfig.labelKey)}
        </h2>
        <div style={pageStyles.card}>
          {viewingPhase || project.archived ? (
            // Read-only: show PhaseContent for completed/archived phases
            <PhaseContent
              project={project}
              onAdvance={handleAdvancePhase}
              isAdvancing={advancing}
              viewingPhase={viewingPhase}
            />
          ) : (
            // Active phase: show WorkflowEngine
            <WorkflowEngine
              projectId={project.id}
              project={project}
              onPhaseAdvanced={handlePhaseAdvanced}
            />
          )}
        </div>
      </div>

      {/* Phase Management: only show when viewing past phases */}
      {viewingPhase && !project.archived && (
        <div style={pageStyles.section}>
          <h2 style={pageStyles.sectionTitle}>{t("phase_mgmt.title")}</h2>
          <PhaseManagement
            project={project}
            onAdvancePhase={handleAdvancePhase}
            advancing={advancing}
          />
        </div>
      )}
    </div>
    ```

    5. Add `handlePhaseAdvanced` function:
    ```tsx
    async function handlePhaseAdvanced() {
      await refresh();  // refresh from useProject -- destructure it
      setViewingPhase(null);
    }
    ```
    Note: Destructure `refresh` from useProject hook (it's already exported but not destructured in the current code -- add it to the destructuring).

    **C. Add i18n translations to `client/src/i18n/locales/en.json`:**

    Add a `"workflow"` top-level key with all step title and description keys. All keys follow the pattern `workflow.{phase}.{step_suffix}`. Also add button labels and UI strings.

    Translations needed (English):
    ```json
    "workflow": {
      "step_progress": "Step {{current}} of {{total}}",
      "all_steps_complete": "All steps for this phase are complete.",
      "continue": "Continue",
      "submit": "Submit",
      "get_ai_guidance": "Get AI Guidance",

      "idea": {
        "describe_title": "Describe Your Idea",
        "describe_desc": "What is the core idea? Explain it in a few sentences.",
        "describe_placeholder": "Describe the core idea...",
        "problem_title": "Problem Statement",
        "problem_desc": "What problem does this idea solve?",
        "problem_placeholder": "What problem does this solve...",
        "confirm_title": "Ready to Proceed?",
        "confirm_desc": "Review your idea description and problem statement. When ready, proceed to the feasibility assessment.",
        "ready": "Ready to proceed",
        "need_time": "Need more time"
      },
      "feasibility": {
        "technical_title": "Technical Feasibility",
        "technical_desc": "Assess the technical feasibility of this project.",
        "technical_placeholder": "Describe technical feasibility...",
        "resources_title": "Resource Availability",
        "resources_desc": "What resources are needed and are they available?",
        "resources_placeholder": "Describe resource availability...",
        "verdict_title": "Feasibility Verdict",
        "verdict_desc": "Based on your assessment, is this project feasible?",
        "feasible": "Feasible",
        "concerns": "Concerns exist"
      },
      "effort": {
        "hours_title": "Estimated Hours",
        "hours_desc": "How many hours will this project require?",
        "hours_placeholder": "Enter estimated hours...",
        "cost_title": "Estimated Cost",
        "cost_desc": "What is the estimated cost for this project?",
        "cost_placeholder": "Enter estimated cost...",
        "confirm_title": "Estimates Complete",
        "confirm_desc": "Review your effort estimates before proceeding.",
        "complete": "Estimates complete"
      },
      "roi": {
        "impact_title": "Expected Impact",
        "impact_desc": "What revenue or cost savings impact do you expect?",
        "impact_placeholder": "Describe expected impact...",
        "metrics_title": "Success Metrics",
        "metrics_desc": "How will you measure success?",
        "metrics_placeholder": "Define success metrics...",
        "confirm_title": "KPIs Defined",
        "confirm_desc": "Confirm your KPIs are defined before proceeding.",
        "defined": "KPIs defined"
      },
      "risks": {
        "identify_title": "Identify Risks",
        "identify_desc": "What risks could affect this project?",
        "identify_placeholder": "List identified risks...",
        "deps_title": "Dependencies",
        "deps_desc": "What does this project depend on?",
        "deps_placeholder": "List dependencies...",
        "mitigation_title": "Mitigation Strategies",
        "mitigation_desc": "How will you address the identified risks?",
        "mitigation_placeholder": "Describe mitigation strategies..."
      },
      "dp": {
        "summary_title": "Decision Summary",
        "summary_desc": "Review all information gathered in previous phases before making your decision.",
        "go_nogo_title": "Go / No-Go Decision",
        "go_nogo_desc": "Based on all the information gathered, should this project proceed to implementation?",
        "go": "Go",
        "nogo": "No-Go",
        "defer": "Defer",
        "go_confirm_title": "Confirm Go Decision",
        "go_confirm_desc": "Confirming will move this project into the implementation pipeline. This action cannot be undone.",
        "confirm_go": "Confirm Go",
        "go_back": "Go back",
        "nogo_rationale_title": "No-Go Rationale",
        "nogo_rationale_desc": "Please document why this project will not proceed.",
        "nogo_rationale_placeholder": "Explain the rationale for the No-Go decision...",
        "defer_reason_title": "Defer Reason",
        "defer_reason_desc": "Why is this decision being deferred? The project will remain at the Decision Point.",
        "defer_reason_placeholder": "Explain why the decision is being deferred..."
      },
      "impl": {
        "start_title": "Implementation Started",
        "start_desc": "This project has entered the GSD execution pipeline. Track your progress and blockers below.",
        "progress_title": "Progress Notes",
        "progress_desc": "What progress has been made?",
        "progress_placeholder": "Describe progress...",
        "blockers_title": "Blockers",
        "blockers_desc": "Are there any blockers preventing progress?",
        "blockers_placeholder": "Describe any blockers...",
        "complete_title": "Implementation Complete",
        "complete_desc": "Confirm that implementation is complete and ready for review.",
        "complete_btn": "Implementation complete"
      },
      "review": {
        "learnings_title": "Key Learnings",
        "learnings_desc": "What were the key learnings from this project?",
        "learnings_placeholder": "Describe key learnings...",
        "replicate_title": "Patterns to Replicate",
        "replicate_desc": "What went well that should be repeated?",
        "replicate_placeholder": "Describe patterns to replicate...",
        "avoid_title": "Patterns to Avoid",
        "avoid_desc": "What should be done differently next time?",
        "avoid_placeholder": "Describe patterns to avoid...",
        "complete_title": "Complete Review & Archive",
        "complete_desc": "Completing the review will archive this project. All data is preserved.",
        "complete_btn": "Complete review & archive"
      }
    }
    ```

    **D. Add i18n translations to `client/src/i18n/locales/de.json`:**

    Add the same `"workflow"` key structure with German translations:
    ```json
    "workflow": {
      "step_progress": "Schritt {{current}} von {{total}}",
      "all_steps_complete": "Alle Schritte dieser Phase sind abgeschlossen.",
      "continue": "Weiter",
      "submit": "Absenden",
      "get_ai_guidance": "KI-Empfehlung einholen",

      "idea": {
        "describe_title": "Idee beschreiben",
        "describe_desc": "Was ist die Kernidee? Erklaeren Sie sie in wenigen Saetzen.",
        "describe_placeholder": "Kernidee beschreiben...",
        "problem_title": "Problemstellung",
        "problem_desc": "Welches Problem loest diese Idee?",
        "problem_placeholder": "Welches Problem wird geloest...",
        "confirm_title": "Bereit fortzufahren?",
        "confirm_desc": "Ueberpruefen Sie Ihre Ideenbeschreibung und Problemstellung. Wenn Sie bereit sind, fahren Sie mit der Machbarkeitsanalyse fort.",
        "ready": "Bereit fortzufahren",
        "need_time": "Brauche mehr Zeit"
      },
      "feasibility": {
        "technical_title": "Technische Machbarkeit",
        "technical_desc": "Bewerten Sie die technische Machbarkeit dieses Projekts.",
        "technical_placeholder": "Technische Machbarkeit beschreiben...",
        "resources_title": "Verfuegbare Ressourcen",
        "resources_desc": "Welche Ressourcen werden benoetigt und sind sie verfuegbar?",
        "resources_placeholder": "Ressourcenverfuegbarkeit beschreiben...",
        "verdict_title": "Machbarkeitsurteil",
        "verdict_desc": "Ist dieses Projekt auf Basis Ihrer Bewertung machbar?",
        "feasible": "Machbar",
        "concerns": "Bedenken bestehen"
      },
      "effort": {
        "hours_title": "Geschaetzte Stunden",
        "hours_desc": "Wie viele Stunden wird dieses Projekt benoetigen?",
        "hours_placeholder": "Geschaetzte Stunden eingeben...",
        "cost_title": "Geschaetzte Kosten",
        "cost_desc": "Was sind die geschaetzten Kosten fuer dieses Projekt?",
        "cost_placeholder": "Geschaetzte Kosten eingeben...",
        "confirm_title": "Schaetzungen abgeschlossen",
        "confirm_desc": "Ueberpruefen Sie Ihre Aufwandsschaetzungen bevor Sie fortfahren.",
        "complete": "Schaetzungen abgeschlossen"
      },
      "roi": {
        "impact_title": "Erwartete Auswirkung",
        "impact_desc": "Welche Umsatz- oder Kosteneinsparungen erwarten Sie?",
        "impact_placeholder": "Erwartete Auswirkung beschreiben...",
        "metrics_title": "Erfolgskennzahlen",
        "metrics_desc": "Wie werden Sie den Erfolg messen?",
        "metrics_placeholder": "Erfolgskennzahlen definieren...",
        "confirm_title": "KPIs definiert",
        "confirm_desc": "Bestaetigen Sie, dass Ihre KPIs definiert sind, bevor Sie fortfahren.",
        "defined": "KPIs definiert"
      },
      "risks": {
        "identify_title": "Risiken identifizieren",
        "identify_desc": "Welche Risiken koennten dieses Projekt beeintraechtigen?",
        "identify_placeholder": "Identifizierte Risiken auflisten...",
        "deps_title": "Abhaengigkeiten",
        "deps_desc": "Wovon haengt dieses Projekt ab?",
        "deps_placeholder": "Abhaengigkeiten auflisten...",
        "mitigation_title": "Risikominderung",
        "mitigation_desc": "Wie werden Sie die identifizierten Risiken adressieren?",
        "mitigation_placeholder": "Risikominderungsstrategien beschreiben..."
      },
      "dp": {
        "summary_title": "Entscheidungszusammenfassung",
        "summary_desc": "Ueberpruefen Sie alle in den vorherigen Phasen gesammelten Informationen, bevor Sie Ihre Entscheidung treffen.",
        "go_nogo_title": "Go / No-Go Entscheidung",
        "go_nogo_desc": "Soll dieses Projekt auf Basis aller gesammelten Informationen in die Umsetzung gehen?",
        "go": "Go",
        "nogo": "No-Go",
        "defer": "Zurueckstellen",
        "go_confirm_title": "Go-Entscheidung bestaetigen",
        "go_confirm_desc": "Die Bestaetigung verschiebt dieses Projekt in die Umsetzungspipeline. Diese Aktion kann nicht rueckgaengig gemacht werden.",
        "confirm_go": "Go bestaetigen",
        "go_back": "Zurueck",
        "nogo_rationale_title": "No-Go Begruendung",
        "nogo_rationale_desc": "Bitte dokumentieren Sie, warum dieses Projekt nicht fortgesetzt wird.",
        "nogo_rationale_placeholder": "Begruendung fuer die No-Go-Entscheidung erklaeren...",
        "defer_reason_title": "Grund fuer Zurueckstellung",
        "defer_reason_desc": "Warum wird diese Entscheidung zurueckgestellt? Das Projekt bleibt am Entscheidungspunkt.",
        "defer_reason_placeholder": "Erklaeren Sie, warum die Entscheidung zurueckgestellt wird..."
      },
      "impl": {
        "start_title": "Umsetzung gestartet",
        "start_desc": "Dieses Projekt ist in die GSD-Ausfuehrungspipeline eingetreten. Verfolgen Sie Ihren Fortschritt und Hindernisse unten.",
        "progress_title": "Fortschrittsnotizen",
        "progress_desc": "Welcher Fortschritt wurde erzielt?",
        "progress_placeholder": "Fortschritt beschreiben...",
        "blockers_title": "Hindernisse",
        "blockers_desc": "Gibt es Hindernisse, die den Fortschritt behindern?",
        "blockers_placeholder": "Hindernisse beschreiben...",
        "complete_title": "Umsetzung abgeschlossen",
        "complete_desc": "Bestaetigen Sie, dass die Umsetzung abgeschlossen und bereit fuer die Ueberpruefung ist.",
        "complete_btn": "Umsetzung abgeschlossen"
      },
      "review": {
        "learnings_title": "Wichtige Erkenntnisse",
        "learnings_desc": "Was waren die wichtigsten Erkenntnisse aus diesem Projekt?",
        "learnings_placeholder": "Wichtige Erkenntnisse beschreiben...",
        "replicate_title": "Muster zum Wiederholen",
        "replicate_desc": "Was lief gut und sollte wiederholt werden?",
        "replicate_placeholder": "Muster zum Wiederholen beschreiben...",
        "avoid_title": "Muster zum Vermeiden",
        "avoid_desc": "Was sollte beim naechsten Mal anders gemacht werden?",
        "avoid_placeholder": "Muster zum Vermeiden beschreiben...",
        "complete_title": "Ueberpruefung abschliessen & archivieren",
        "complete_desc": "Der Abschluss der Ueberpruefung archiviert dieses Projekt. Alle Daten bleiben erhalten.",
        "complete_btn": "Ueberpruefung abschliessen & archivieren"
      }
    }
    ```

    **Important integration notes:**
    - The step definition titleKey values in definitions.ts (Plan 01) must exactly match the i18n key paths above. For example, the step `idea_describe` with titleKey `"workflow.idea.describe_title"` maps to `en.json -> workflow.idea.describe_title`.
    - The step definition option labelKey values must also match. For example, the "Go" button in decision_point has labelKey `"workflow.dp.go"`.
    - The step textConfig placeholderKey values must match the placeholder keys above.

    **E. Verify PhaseContent preserved for completed-phase viewing:**
    After making the ProjectDetail changes, explicitly verify that `viewingPhase` still controls the conditional rendering:
    - When user clicks a completed phase in the timeline, `setViewingPhase(phase)` fires (existing behavior, unchanged).
    - When `viewingPhase` is non-null, the ternary renders `<PhaseContent>` (NOT `<WorkflowEngine>`).
    - When user clicks the current active phase in the timeline (or resets via "Back to current"), `setViewingPhase(null)` fires, which causes `<WorkflowEngine>` to render.
    - Confirm that `viewingPhase` state variable and its `setViewingPhase` setter remain in ProjectDetail and are not removed or overwritten by the integration.
    - The timeline component's `onClick` handler for phase items must continue to call `setViewingPhase`.
  </action>
  <verify>
    Run `npx tsc --noEmit` from project root. Then run the following automated checks BEFORE the manual checkpoint:
    1. Verify app.ts imports workflowRouter: `grep "workflowRouter" server/src/app.ts`
    2. Verify ProjectDetail imports WorkflowEngine: `grep "WorkflowEngine" client/src/pages/ProjectDetail.tsx`
    3. Verify ProjectDetail still references PhaseContent (preserved for history): `grep "PhaseContent" client/src/pages/ProjectDetail.tsx`
    4. Verify ProjectDetail still uses viewingPhase for conditional rendering: `grep "viewingPhase" client/src/pages/ProjectDetail.tsx`
    5. Verify en.json and de.json both contain "workflow" key: `grep '"workflow"' client/src/i18n/locales/en.json client/src/i18n/locales/de.json`
    6. Validate i18n key coverage -- verify all 8 phase sub-keys exist: `node -e "const en=require('./client/src/i18n/locales/en.json'); const phases=['idea','feasibility','effort','roi','risks','dp','impl','review']; phases.forEach(p => { if(!en.workflow[p]) throw new Error('Missing workflow.'+p) }); console.log('All i18n phase keys present')"`
    7. Build check: `npm run build` (or `npx tsc --noEmit`) confirms zero errors
    8. Workflow API smoke test: Start dev server, then `curl -s http://localhost:3001/api/workflow/test-id -H "Authorization: Bearer $TOKEN" | head -c 200` -- should return JSON (even if 404 for missing project, the route must be registered)
  </verify>
  <done>
    Workflow route registered at /api/workflow. ProjectDetail renders WorkflowEngine for active phase and PhaseContent for history/archived. viewingPhase state variable controls the conditional branch and is preserved. PhaseManagement hidden during active workflow. EN and DE translations complete for all workflow steps. TypeScript compiles cleanly and all automated checks pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify end-to-end GSD workflow experience</name>
  <what-built>
    Complete GSD Workflow Engine integrated into the project detail page. The workflow replaces the old freeform phase forms with a guided, step-by-step experience using buttons and text inputs.
  </what-built>
  <how-to-verify>
    1. Start the dev server: `npm run dev` from project root
    2. Navigate to http://localhost:3000, sign in, open any existing project
    3. **Verify workflow renders**: Instead of the old textarea form, you should see the WorkflowEngine with a step progress indicator and the current step rendered as either buttons or a text input field
    4. **Test button step**: If the current step is a button_choice type, click one of the buttons. Verify:
       - Button disables briefly (double-click prevention)
       - Next step appears without page reload
       - Step progress indicator updates
    5. **Test text input step**: When a text_input step appears, verify:
       - Textarea appears with placeholder text
       - Submit button is disabled until minimum text is entered (if minLength is set)
       - After submitting, next step appears
    6. **Test phase history**: Click a completed phase in the timeline. Verify PhaseContent renders in read-only mode (not WorkflowEngine)
    7. **Test language**: Switch to German. Verify all workflow text (titles, descriptions, buttons) appears in German
    8. **Create a new project**: Verify it starts in the "idea" phase with the workflow step "Describe Your Idea"
    9. **(If possible) Advance a project to decision_point**: Verify the Go/No-Go/Defer buttons appear
  </how-to-verify>
  <resume-signal>Type "approved" if the workflow experience is correct, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Dev server starts and serves the app
3. Workflow API responds at GET /api/workflow/{projectId} with state and steps
4. ProjectDetail shows WorkflowEngine for current phase
5. PhaseContent shows for completed phases (read-only)
6. PhaseManagement is hidden during active workflow
7. EN and DE translations load correctly
8. New projects start with workflow at idea phase step 1
9. Legacy projects initialize workflow at their current phase
</verification>

<success_criteria>
- GSD-01: Projects reaching decision_point with "Go" enter the implementation pipeline automatically
- GSD-02: All prompts are clickable buttons (button_choice steps) or explicitly requested text fields (text_input steps)
- GSD-03: Text input fields appear ONLY when the workflow step type is text_input
- GSD-04: Context management (step aggregation into phaseData, phase advancement events) happens invisibly
- GSD-05: Non-techies can navigate the workflow via buttons without any terminal knowledge
</success_criteria>

<output>
After completion, create `.planning/phases/05-gsd-workflow-engine/05-03-SUMMARY.md`
</output>
