---
phase: 11-telegram-bot-i18n
plan: 03
type: execute
wave: 3
depends_on: ["11-02"]
files_modified:
  - server/src/telegram/menus/project-menu.ts
  - server/src/telegram/menus/idea-menu.ts
  - server/src/telegram/menus/settings-menu.ts
  - server/src/telegram/menus/workflow-menu.ts
autonomous: true

must_haves:
  truths:
    - "Project menu button labels and callback answers use ctx.t() for all user-facing text"
    - "Idea menu button labels, action buttons, and callback answers use ctx.t()"
    - "Settings menu labels use ctx.t()"
    - "Workflow menu messages, button labels, and status messages use ctx.t()"
  artifacts:
    - path: "server/src/telegram/menus/project-menu.ts"
      provides: "i18n-enabled project navigation menu"
      contains: "ctx.t("
    - path: "server/src/telegram/menus/idea-menu.ts"
      provides: "i18n-enabled idea navigation menu"
      contains: "ctx.t("
    - path: "server/src/telegram/menus/settings-menu.ts"
      provides: "i18n-enabled settings menu"
      contains: "ctx.t("
    - path: "server/src/telegram/menus/workflow-menu.ts"
      provides: "i18n-enabled workflow step rendering"
      contains: "ctx.t("
  key_links:
    - from: "server/src/telegram/menus/project-menu.ts"
      to: "server/src/telegram/formatters.ts"
      via: "passes ctx.t to formatProjectDetail"
      pattern: "formatProjectDetail.*ctx\\.t"
    - from: "server/src/telegram/menus/idea-menu.ts"
      to: "server/src/telegram/formatters.ts"
      via: "passes ctx.t to formatIdeaDetail"
      pattern: "formatIdeaDetail.*ctx\\.t"
---

<objective>
Replace all hardcoded English strings in the four menu files with ctx.t() translation calls. Update formatter invocations to pass the translation function.

Purpose: Menus are the interactive Telegram UI elements -- button labels, callback answers, and status messages must all respect user language preference.

Output: All 4 menu files fully i18n-enabled.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-telegram-bot-i18n/11-RESEARCH.md
@.planning/phases/11-telegram-bot-i18n/11-02-SUMMARY.md

@server/src/telegram/menus/project-menu.ts
@server/src/telegram/menus/idea-menu.ts
@server/src/telegram/menus/settings-menu.ts
@server/src/telegram/menus/workflow-menu.ts
@server/src/telegram/formatters.ts
@server/src/telegram/locales/de.ftl
@server/src/telegram/locales/en.ftl
</context>

<tasks>

<task type="auto">
  <name>Task 1: i18n for project-menu.ts and idea-menu.ts</name>
  <files>
    server/src/telegram/menus/project-menu.ts
    server/src/telegram/menus/idea-menu.ts
  </files>
  <action>
**Update project-menu.ts:**

In `projectDetailMenu.dynamic()`:
- Replace `"No project selected"` button text and callback with `ctx.t("menu-no-project")`
- Replace `"Project not found"` / `"Not found"` with `ctx.t("menu-project-not-found")`
- Replace `"Workflow >"` button text with `ctx.t("menu-workflow")`
- Replace `"< Back to projects"` with `ctx.t("menu-back-projects")`
- Update `formatProjectDetail(project)` call to `formatProjectDetail(project, ctx.t)` (pass translation function per plan 02 changes)

In `projectMenu.dynamic()`:
- Replace `"No projects"` button text and callback `"No projects found"` with `ctx.t("menu-no-projects")`
- Replace `...and ${projects.length - 10} more` text and callback `"View all projects in the web app"` with translated equivalents using `ctx.t("fmt-and-more", { count: ... })` and `ctx.t("menu-view-all-projects")`
- Update `formatProjectDetail(project)` call in submenu to pass `ctx.t`

**Update idea-menu.ts:**

In `ideaDetailMenu.dynamic()`:
- Replace `"No idea selected"` with `ctx.t("menu-no-idea")`
- Replace `"Idea not found"` / `"Not found"` with `ctx.t("menu-idea-not-found")`
- Replace `"Account not linked"` callback answers with `ctx.t("menu-account-not-linked")`
- Replace `"Refine"` button text with `ctx.t("menu-refine")`
- Replace `"*Refinement Question*"` and `"Reply with your answer in the chat."` with `ctx.t("menu-refinement-title")` and `ctx.t("menu-refinement-reply")`
- Replace `"Error generating question"` with a translated callback answer
- Replace `"Propose Graduation"` with `ctx.t("menu-propose-graduation")`
- Replace graduation proposed message with `ctx.t("menu-graduation-proposed", { title: escapeMd(updated.title) })`
- Replace `"Vote Yes"` / `"Vote No"` labels with `ctx.t("menu-vote-yes")` / `ctx.t("menu-vote-no")` (keep the emoji prefixes)
- Replace `"Voted: Approve"` / `"Voted: Reject"` with `ctx.t("menu-voted-approve")` / `ctx.t("menu-voted-reject")`
- Replace `"< Back to ideas"` with `ctx.t("menu-back-ideas")`
- Update `formatIdeaDetail(idea)` calls to `formatIdeaDetail(idea, ctx.t)`

In `ideaMenu.dynamic()`:
- Replace `"No ideas"` / `"No ideas in pool"` with `ctx.t("menu-no-ideas")`
- Replace `...and ${ideas.length - 10} more` and callback with translated equivalents
- Update `formatIdeaDetail(idea)` call in submenu to pass `ctx.t`

NOTE: For menu `.text()` and `.back()` button labels, these are evaluated dynamically so `ctx.t()` works inside the dynamic callback. For `.submenu()` labels, use `label` computed inside the dynamic callback where `ctx` is available.
  </action>
  <verify>
- `grep -c "ctx.t(" server/src/telegram/menus/project-menu.ts` shows multiple translation calls
- `grep -c "ctx.t(" server/src/telegram/menus/idea-menu.ts` shows multiple translation calls
- No hardcoded English string literals remain in either file (except technical strings)
- `npx tsc --noEmit` passes
  </verify>
  <done>All button labels, callback answers, and status messages in project-menu.ts and idea-menu.ts use ctx.t(); formatter calls pass ctx.t; TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 2: i18n for settings-menu.ts and workflow-menu.ts</name>
  <files>
    server/src/telegram/menus/settings-menu.ts
    server/src/telegram/menus/workflow-menu.ts
  </files>
  <action>
**Update settings-menu.ts:**

- Replace `CHANNEL_LABELS` static map with a function that uses `ctx.t()`:
  - `"Web"` -> `ctx.t("settings-web")` (keep the emoji prefix in code)
  - `"Telegram"` -> `ctx.t("settings-telegram")`
  - `"Email"` -> `ctx.t("settings-email")`
- Replace callback answer strings like `"${channel} preferences"` and `"${channel} ${priority}: ${newVal ? "on" : "off"}"` with translated equivalents using `ctx.t("settings-prefs-label", { channel, priority, state: newVal ? "on" : "off" })` or simpler inline translation
- Since priority names (low, medium, high, critical) appear in button labels, translate them too: add keys like `settings-priority-low`, `settings-priority-medium`, `settings-priority-high`, `settings-priority-critical` to the .ftl files if not already present, and use them in the button label

NOTE: Add any new translation keys needed to both de.ftl and en.ftl files.

**Update workflow-menu.ts:**

In `buildStepMessage()`:
- This function currently uses `stepDef.titleKey` and `stepDef.descriptionKey` as display text (stripping prefixes). These are already i18n-like keys. For now, keep the existing behavior of extracting readable text from the key names -- the workflow step definitions themselves are a separate concern. The hardcoded strings that need i18n are:
  - `"Type your answer below."` -> use `ctx.t("wf-type-your-answer")` -- but buildStepMessage doesn't have ctx. Solution: accept `t: TranslateFunc` parameter imported from formatters.ts.
  - `"Type your response below."` -> `t("wf-type-your-response")`
  - `"Processing..."` -> `t("wf-processing")`
  - `"Continue"` button text -> `t("wf-continue")`

Update `buildStepMessage(stepDef, t)` to accept a TranslateFunc parameter. Update all callers (`sendWorkflowStep`) to pass the translation function.

In `sendWorkflowStep()`:
- It has `ctx` available, so pass `ctx.t` to `buildStepMessage(stepDef, ctx.t)`

In `handleAdvanceResult()`:
- Replace `"Phase complete! Moving to *nextPhase*."` with `ctx.t("wf-phase-complete", { phase: result.nextPhase.replace(/_/g, " ") })`
- Replace `"Project lifecycle complete!..."` with `ctx.t("wf-lifecycle-complete")`
- Replace `"Project archived: ${result.reason}"` with `ctx.t("wf-project-archived", { reason: result.reason })`
- Replace `"Project deferred..."` with `ctx.t("wf-project-deferred")`

In `renderCurrentWorkflowStep()`:
- Replace `"Project not found."` with `ctx.t("wf-project-not-found")`
- Replace `"This project has been archived."` with `ctx.t("wf-project-is-archived")`
- Replace `"Workflow complete for this project."` with `ctx.t("wf-workflow-complete")`
- Replace `"Workflow step not found..."` with `ctx.t("wf-step-not-found")`
- Replace `"Please link your account first with /link."` with `ctx.t("wf-link-first")`

Import `TranslateFunc` from `../formatters.js` for the buildStepMessage parameter type.

NOTE: Add any new translation keys to both de.ftl and en.ftl files.
  </action>
  <verify>
- `grep -c "ctx.t(" server/src/telegram/menus/settings-menu.ts` shows translation calls
- `grep -c "ctx.t\|t(" server/src/telegram/menus/workflow-menu.ts` shows translation calls throughout
- No hardcoded English UI strings remain in either file
- `npx tsc --noEmit` passes
  </verify>
  <done>Settings menu labels, priority names, and callback answers translated; workflow menu messages, button labels, and status strings translated; buildStepMessage accepts TranslateFunc; TypeScript compiles</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` compiles without errors
- No hardcoded English string literals in any of the 4 menu files
- All formatter calls pass ctx.t as translation function
- All button labels, callback answers, and messages use ctx.t()
- Translation keys in .ftl files match what's used in code
</verification>

<success_criteria>
- Project navigation menus display translated labels and messages
- Idea pool menus display translated action buttons and status messages
- Settings menu shows translated channel names and priority labels
- Workflow step rendering uses translated instructions and status messages
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-telegram-bot-i18n/11-03-SUMMARY.md`
</output>
