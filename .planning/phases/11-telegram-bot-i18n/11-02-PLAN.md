---
phase: 11-telegram-bot-i18n
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - server/src/telegram/commands.ts
  - server/src/telegram/formatters.ts
autonomous: true

must_haves:
  truths:
    - "All command handler reply strings use ctx.t() instead of hardcoded English"
    - "Formatter functions accept a translation function parameter and use it for all labels"
    - "resolveUser helper uses ctx.t() for error messages"
  artifacts:
    - path: "server/src/telegram/commands.ts"
      provides: "i18n-enabled command handlers"
      contains: "ctx.t("
    - path: "server/src/telegram/formatters.ts"
      provides: "i18n-enabled formatting functions with translation parameter"
      contains: "t("
  key_links:
    - from: "server/src/telegram/commands.ts"
      to: "server/src/telegram/formatters.ts"
      via: "passes ctx.t to formatter functions"
      pattern: "formatProjectList.*ctx\\.t"
    - from: "server/src/telegram/formatters.ts"
      to: "server/src/telegram/locales/en.ftl"
      via: "translation key references"
      pattern: "t\\(\"fmt-"
---

<objective>
Replace all hardcoded English strings in commands.ts and formatters.ts with ctx.t() translation calls. Update formatter function signatures to accept a translation function, enabling language-aware formatting.

Purpose: Commands and formatters are the most visible user-facing strings in the bot. This plan covers the two core files that produce most bot output.

Output: commands.ts and formatters.ts fully i18n-enabled.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-telegram-bot-i18n/11-RESEARCH.md
@.planning/phases/11-telegram-bot-i18n/11-01-SUMMARY.md

@server/src/telegram/commands.ts
@server/src/telegram/formatters.ts
@server/src/telegram/locales/de.ftl
@server/src/telegram/locales/en.ftl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update formatters.ts to accept translation function parameter</name>
  <files>server/src/telegram/formatters.ts</files>
  <action>
Update `server/src/telegram/formatters.ts` to accept a translation function for all label strings. Keep `escapeMd`, `phaseEmoji`, and `statusEmoji` unchanged (they don't contain user-facing labels).

1. Define a translation function type at the top of the file:
```typescript
/** Translation function type -- matches ctx.t() and i18n.t(locale, key) signatures */
export type TranslateFunc = (key: string, params?: Record<string, unknown>) => string;
```

2. Update `formatProjectDetail(project, t)`:
   - Add `t: TranslateFunc` as second parameter
   - Replace `"Phase: "` with `t("fmt-phase-label")` + ": "
   - Replace `"No description"` with `t("fmt-no-description")`
   - Replace `"Members: "` with `t("fmt-members-label")` + ": "
   - Replace `"Created: "` with `t("fmt-created-label")` + ": "
   - Replace `"_Archived_"` with `t("fmt-archived")`

3. Update `formatProjectList(projects, t)`:
   - Add `t: TranslateFunc` as second parameter
   - Replace `"No projects found. Create one in the web app!"` with `t("fmt-projects-empty")`
   - Replace `"*Projects*"` with `*${t("fmt-projects-title")}*`
   - Replace `...and ${projects.length - 10} more` with `t("fmt-and-more", { count: projects.length - 10 })`

4. Update `formatIdeaDetail(idea, t)`:
   - Add `t: TranslateFunc` as second parameter
   - Replace `"Status: "` with `t("fmt-status-label")` (add this key to ftl files if missing) or keep "Status" as it works in both languages
   - Replace `"No input"` with `t("fmt-no-input")`
   - Replace `"Readiness: "` with `t("fmt-readiness-label")` + ": "
   - Replace `"Rounds: "` with `t("fmt-rounds-label")` + ": "

5. Update `formatIdeaList(ideas, t)`:
   - Add `t: TranslateFunc` as second parameter
   - Replace `"No ideas in the pool. Capture one via voice or web!"` with `t("fmt-ideas-empty")`
   - Replace `"*Ideas*"` with `*${t("fmt-ideas-title")}*`
   - Replace `...and ${ideas.length - 10} more` with `t("fmt-and-more", { count: ideas.length - 10 })`

6. Update `formatStatus(projects, ideas, t)`:
   - Add `t: TranslateFunc` as third parameter
   - Replace `"*Status Overview*"` with `*${t("fmt-status-overview")}*`
   - Replace `"*Projects*"` with `*${t("fmt-projects-title")}*`
   - Replace `"Active: "` with `${t("fmt-active-label")}: `
   - Replace `"Archived: "` with `${t("fmt-archived-label")}: `
   - Replace `"*Ideas*"` with `*${t("fmt-ideas-title")}*`
   - Replace `"None yet"` with `t("fmt-none-yet")`
   - Replace `"Last activity: "` with `${t("fmt-last-activity")}: `

Also add any new keys (fmt-no-description, fmt-no-input, fmt-status-label) to both de.ftl and en.ftl if they weren't included in plan 01.

IMPORTANT: Apply escapeMd() to all translated text that appears in MarkdownV2 messages. The pattern is: `escapeMd(t("key"))` for plain text, and for titles that use *bold*: embed the t() call inside the markdown.
  </action>
  <verify>
- `grep "hardcoded" server/src/telegram/formatters.ts` returns nothing (no hardcoded English strings remain)
- `grep "t(" server/src/telegram/formatters.ts` shows translation calls in every format function
- All format functions have `t: TranslateFunc` parameter
- `npx tsc --noEmit` passes
  </verify>
  <done>All formatter functions accept a TranslateFunc parameter; all English label strings replaced with t() calls; escapeMd applied correctly to translated text; TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 2: Replace hardcoded strings in commands.ts with ctx.t()</name>
  <files>server/src/telegram/commands.ts</files>
  <action>
Update `server/src/telegram/commands.ts` to use `ctx.t()` for all user-facing strings.

1. Remove the `setMyCommands` call at the bottom of `registerCommands()` (already moved to bot.ts in plan 01).

2. Update `/start` command handler:
   - Replace "Invalid or expired linking code..." with `escapeMd(ctx.t("cmd-start-invalid-code"))`
   - Replace "Could not determine your Telegram user..." with `escapeMd(ctx.t("error-no-user"))`
   - Replace "Successfully linked! Welcome, *displayName*..." with `ctx.t("cmd-start-link-success", { displayName })` -- note: the translation includes `*{ $displayName }*` so apply escapeMd to the displayName variable BEFORE passing it, but let the Fluent template handle the markdown formatting. Then apply escapeMd to the ENTIRE result. Actually, since Fluent produces plain text with intended markdown, the approach is: pass displayName already escaped, wrap the final result in escapeMd for the non-markdown parts but preserve * for bold. The simplest approach: use `parse_mode: "Markdown"` (not V2) for messages that embed bold via Fluent, OR keep the current V2 approach and escapeMd the full result then un-escape the intentional `*`. Simplest: switch these replies to `parse_mode: "Markdown"` which is more lenient and doesn't require escaping. Match the existing codebase pattern -- if current code uses MarkdownV2, maintain it. If you use MarkdownV2, build the string manually: `escapeMd(ctx.t("cmd-start-link-success-prefix")) + ` *` + escapeMd(displayName) + `* ` + escapeMd(ctx.t("cmd-start-link-success-suffix"))`. OR better: use the Fluent template as plain text and format markdown in code, just like the existing code does.
   - Replace "Already linked as *displayName*..." similarly
   - Replace "Welcome to *Eluma Bot*!..." similarly

3. Update `/projects`, `/ideas`, `/status` handlers:
   - Replace `"You are not part of any team yet."` with `escapeMd(ctx.t("error-no-team"))`
   - Pass `ctx.t` as the translation function to `formatProjectList(nonArchived, ctx.t)`, `formatIdeaList(nonArchived, ctx.t)`, `formatStatus(projects, ideas, ctx.t)`

4. Update `/settings` handler:
   - Replace `"*Notification Settings*\n\nChoose a channel to configure:"` with `ctx.t("menu-settings-title") + "\n\n" + ctx.t("menu-settings-subtitle")` wrapped in escapeMd and bold as appropriate

5. Update `/help` handler:
   - Replace all hardcoded help lines with `ctx.t("cmd-help-title")`, `ctx.t("cmd-help-start")`, etc.
   - Apply escapeMd to each line

6. Update `resolveUser()` helper:
   - Replace `"Could not determine your Telegram user."` with `escapeMd(ctx.t("error-no-user"))`
   - Replace `"Your Telegram is not linked to an Eluma account..."` with `escapeMd(ctx.t("error-not-linked"))`

IMPORTANT: Ensure the parse_mode remains consistent with the existing code (MarkdownV2 where currently used). For strings that include intentional bold formatting from Fluent, you have two approaches:
- Option A: Keep the translated string plain, add markdown formatting in code (like current code does)
- Option B: Use Markdown (not V2) parse mode for simpler escaping

Recommendation: Use Option A (keep current V2 approach) for consistency. Have the Fluent strings be plain text, add `*bold*` wrapping in code, and escapeMd the non-bold parts.
  </action>
  <verify>
- No English string literals in command handlers (except variable names, comments, and parse_mode values)
- `grep "ctx.t(" server/src/telegram/commands.ts` shows translation calls throughout
- `grep "setMyCommands" server/src/telegram/commands.ts` returns no results (moved to bot.ts)
- `npx tsc --noEmit` passes
  </verify>
  <done>All command handler strings use ctx.t(); setMyCommands removed (now in bot.ts); formatters called with ctx.t parameter; resolveUser helper uses ctx.t for error messages; TypeScript compiles</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` compiles without errors
- No hardcoded English string literals in commands.ts or formatters.ts (beyond technical strings like parse_mode values)
- All formatter functions have TranslateFunc parameter
- Commands pass ctx.t to formatters
- escapeMd applied correctly to translated text in MarkdownV2 messages
</verification>

<success_criteria>
- /start, /projects, /ideas, /status, /settings, /help all produce translated output
- Formatter functions produce translated labels (Projects, Ideas, Phase, Members, etc.)
- resolveUser errors are translated
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-telegram-bot-i18n/11-02-SUMMARY.md`
</output>
