---
phase: 11-telegram-bot-i18n
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/telegram/i18n.ts
  - server/src/telegram/locales/de.ftl
  - server/src/telegram/locales/en.ftl
  - server/src/telegram/bot.ts
autonomous: true

must_haves:
  truths:
    - "I18n instance exists with custom localeNegotiator reading Eluma user.language"
    - "German Fluent translation file contains all ~100 translation keys"
    - "English Fluent translation file contains all ~100 translation keys with 1:1 key parity to German"
    - "Bot middleware pipeline includes i18n middleware after session and before menus/commands"
  artifacts:
    - path: "server/src/telegram/i18n.ts"
      provides: "I18n instance with locale negotiator and loaded Fluent files"
      exports: ["i18n"]
    - path: "server/src/telegram/locales/de.ftl"
      provides: "German Fluent translations for all bot strings"
    - path: "server/src/telegram/locales/en.ftl"
      provides: "English Fluent translations for all bot strings"
    - path: "server/src/telegram/bot.ts"
      provides: "Bot with i18n middleware installed"
  key_links:
    - from: "server/src/telegram/i18n.ts"
      to: "server/src/telegram/auth.ts"
      via: "resolveElumaUser for locale negotiation"
      pattern: "resolveElumaUser"
    - from: "server/src/telegram/bot.ts"
      to: "server/src/telegram/i18n.ts"
      via: "i18n.middleware() registration"
      pattern: "i18n\\.middleware"
---

<objective>
Set up the @grammyjs/i18n plugin infrastructure: create the I18n instance with a custom locale negotiator that reads user.language from the Eluma user profile, create German and English Fluent (.ftl) translation files with all ~100 keys, and wire the i18n middleware into the bot pipeline.

Purpose: Provides the foundation that all subsequent plans depend on -- ctx.t() becomes available in every handler, and i18n.t(locale, key) is available for standalone translation outside bot context.

Output: i18n.ts, de.ftl, en.ftl files created; bot.ts updated with i18n middleware.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-telegram-bot-i18n/11-RESEARCH.md

@server/src/telegram/bot.ts
@server/src/telegram/types.ts
@server/src/telegram/auth.ts
@server/src/telegram/commands.ts
@server/src/telegram/formatters.ts
@server/src/telegram/menus/project-menu.ts
@server/src/telegram/menus/idea-menu.ts
@server/src/telegram/menus/settings-menu.ts
@server/src/telegram/menus/workflow-menu.ts
@server/src/telegram/handlers/text.ts
@server/src/telegram/handlers/voice.ts
@server/src/telegram/handlers/callback.ts
@server/src/notifications/emitter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create i18n instance and Fluent translation files</name>
  <files>
    server/src/telegram/i18n.ts
    server/src/telegram/locales/de.ftl
    server/src/telegram/locales/en.ftl
  </files>
  <action>
Create three new files:

**server/src/telegram/i18n.ts:**
- Import `I18n` from `@grammyjs/i18n` and `BotContext` from `./types.js`
- Import `resolveElumaUser` from `./auth.js` and `resolve` from `path`
- Create and export `const i18n = new I18n<BotContext>({...})` with:
  - `defaultLocale: "de"` (matches client-side fallback)
  - `localeNegotiator: async (ctx) => { ... }` that reads `ctx.from?.id`, calls `resolveElumaUser(telegramUserId)`, returns `user?.language ?? "de"`
- Load locale files synchronously using `i18n.loadLocaleSync("de", { filePath: resolve(import.meta.dirname, "locales/de.ftl") })` and same for "en"

**server/src/telegram/locales/de.ftl:**
Create the complete German Fluent translation file with ALL keys needed across the entire bot. Use the key inventory from 11-RESEARCH.md as the baseline. Organize by section with comments. Use proper German Unicode (umlauts, eszett per CLAUDE.md rules). Use Fluent variable syntax `{ $varName }` for interpolation. Include these sections:
- Commands: cmd-start-welcome, cmd-start-linked, cmd-start-link-success, cmd-start-invalid-code, cmd-help-title, cmd-help-start, cmd-help-projects, cmd-help-ideas, cmd-help-status, cmd-help-settings, cmd-help-help
- Errors: error-not-linked, error-no-team, error-no-user
- Formatters: fmt-projects-title, fmt-ideas-title, fmt-status-title, fmt-projects-empty, fmt-ideas-empty, fmt-phase-label, fmt-members-label, fmt-created-label, fmt-no-description, fmt-archived, fmt-readiness-label, fmt-rounds-label, fmt-status-overview, fmt-active-label, fmt-archived-label, fmt-none-yet, fmt-last-activity, fmt-and-more
- Menus: menu-no-project, menu-project-not-found, menu-workflow, menu-back-projects, menu-no-projects, menu-no-idea, menu-idea-not-found, menu-refine, menu-propose-graduation, menu-vote-yes, menu-vote-no, menu-back-ideas, menu-no-ideas, menu-settings-title, menu-settings-subtitle, menu-refinement-title, menu-refinement-reply, menu-graduation-proposed, menu-graduation-vote-text, menu-voted-approve, menu-voted-reject, menu-account-not-linked, menu-view-all-projects, menu-view-all-ideas
- Workflow: wf-phase-complete, wf-lifecycle-complete, wf-project-archived, wf-project-deferred, wf-type-your-answer, wf-type-your-response, wf-processing, wf-continue, wf-project-not-found, wf-project-is-archived, wf-workflow-complete, wf-step-not-found, wf-link-first
- Handlers: handler-not-linked, handler-send-text, handler-got-it, handler-step-error, handler-help-hint, handler-transcribing, handler-transcribe-error, handler-no-voice, handler-download-failed, handler-transcription-label, handler-no-routing, handler-where-should-go, handler-route-project, handler-route-idea-pool, handler-voice-idea-title, handler-voice-idea-raw, handler-idea-created, handler-idea-web-refine, handler-unknown-route, handler-no-team-route
- Callbacks: cb-invalid-action, cb-invalid-data, cb-link-first, cb-step-not-found, cb-no-project, cb-done
- Notifications: notif-new-project, notif-new-project-body, notif-phase-advanced, notif-phase-advanced-body, notif-project-archived, notif-project-archived-body, notif-new-idea, notif-new-idea-body, notif-idea-graduated, notif-idea-graduated-body, notif-graduation-proposed, notif-graduation-proposed-body, notif-graduation-voted, notif-graduation-voted-body, notif-workflow-step-completed, notif-workflow-step-body, notif-ai-alert, notif-ai-alert-body, notif-ai-mediation, notif-ai-mediation-body, notif-github-connected, notif-github-connected-body, notif-github-activity, notif-github-activity-body, notif-commit-linked, notif-commit-linked-body, notif-pr-linked, notif-pr-linked-body, notif-repo-forked, notif-repo-forked-body, notif-google-connected, notif-google-connected-body, notif-email-draft, notif-email-draft-body, notif-email-sent, notif-email-sent-body, notif-calendar-post-meeting, notif-calendar-linked, notif-calendar-body, notif-new-email, notif-new-email-body
- Settings: settings-web, settings-telegram, settings-email, settings-prefs-label

**server/src/telegram/locales/en.ftl:**
Create the complete English Fluent translation file with exactly the same keys as de.ftl. Every key in de.ftl must have a corresponding key in en.ftl (1:1 parity). Use natural English text. Same section organization and comments.

IMPORTANT: Keep all .ftl text as plain text -- no MarkdownV2 escaping inside translation strings. Markdown formatting (*bold*, _italic_) can be embedded intentionally but MarkdownV2 escaping (backslashes) must NOT appear in .ftl files. Escaping is applied at render time via escapeMd().

IMPORTANT: Use Fluent's `{ $variableName }` syntax (with $ prefix and spaces around braces) for all variable interpolation.
  </action>
  <verify>
- `ls server/src/telegram/i18n.ts server/src/telegram/locales/de.ftl server/src/telegram/locales/en.ftl` confirms all 3 files exist
- `grep -c "=" server/src/telegram/locales/de.ftl` shows ~100 keys (count lines with = sign)
- `grep -c "=" server/src/telegram/locales/en.ftl` shows same count as de.ftl (key parity)
- `npx tsc --noEmit` passes (TypeScript compiles)
  </verify>
  <done>i18n.ts exports the I18n instance with localeNegotiator reading user.language; de.ftl and en.ftl contain all ~100 translation keys with 1:1 parity; proper Unicode umlauts in German translations; Fluent variable syntax used correctly</done>
</task>

<task type="auto">
  <name>Task 2: Wire i18n middleware into bot pipeline and register per-language commands</name>
  <files>server/src/telegram/bot.ts</files>
  <action>
Update `server/src/telegram/bot.ts`:

1. Add import: `import { i18n } from "./i18n.js";`

2. In `createBot()`, install i18n middleware AFTER session and BEFORE menus. Insert `b.use(i18n.middleware());` between the session middleware block and the menu middleware block. The order must be:
   - Session middleware (existing)
   - **i18n middleware (NEW)**
   - Menu middleware (existing)
   - Command handlers (existing)
   - Callback/voice/text handlers (existing)

3. In `setupBot()`, after the bot is created (`bot = createBot(token)`), add per-language `setMyCommands` registration. Replace or augment the existing `setMyCommands` call in `registerCommands` (commands.ts) -- but since bot.ts has access to the bot instance directly, add it here:

```typescript
// Register per-language command descriptions
bot.api.setMyCommands([
  { command: "start", description: "Telegram-Konto mit Eluma verkn端pfen" },
  { command: "projects", description: "Projekte deines Teams auflisten" },
  { command: "ideas", description: "Den Ideen-Pool durchsuchen" },
  { command: "status", description: "Schnell端bersicht 端ber Projekte und Ideen" },
  { command: "settings", description: "Benachrichtigungseinstellungen" },
  { command: "help", description: "Verf端gbare Befehle anzeigen" },
], { language_code: "de" }).catch(err => console.warn("Failed to set DE commands:", err instanceof Error ? err.message : String(err)));

bot.api.setMyCommands([
  { command: "start", description: "Link your Telegram account to Eluma" },
  { command: "projects", description: "List your team's projects" },
  { command: "ideas", description: "Browse the idea pool" },
  { command: "status", description: "Quick overview of projects and ideas" },
  { command: "settings", description: "Notification preferences" },
  { command: "help", description: "Show available commands" },
], { language_code: "en" }).catch(err => console.warn("Failed to set EN commands:", err instanceof Error ? err.message : String(err)));
```

Also remove the single `setMyCommands` call from `commands.ts` (registerCommands function) since bot.ts now handles this per-language. The old call at the bottom of registerCommands that does `bot.api.setMyCommands([...]).catch(...)` should be deleted.
  </action>
  <verify>
- `grep "i18n.middleware" server/src/telegram/bot.ts` confirms middleware is wired
- `grep "language_code" server/src/telegram/bot.ts` confirms per-language setMyCommands
- `grep "setMyCommands" server/src/telegram/commands.ts` returns no results (old call removed)
- `npx tsc --noEmit` passes
  </verify>
  <done>Bot pipeline has i18n middleware installed in correct position (after session, before menus); per-language command descriptions registered for both DE and EN; old single-language setMyCommands removed from commands.ts</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` compiles without errors
- All 3 new files exist: i18n.ts, de.ftl, en.ftl
- Key count in de.ftl and en.ftl match (1:1 parity)
- i18n middleware is registered before menus and commands in bot.ts
- No MarkdownV2 escaping (backslash sequences) inside .ftl files
- German translations use proper Unicode umlauts (no ae/oe/ue)
</verification>

<success_criteria>
- ctx.t() is available in all bot handlers via i18n middleware
- i18n.t(locale, key) is available for standalone translation (for notifications)
- All ~100 translation keys exist in both de.ftl and en.ftl
- Bot compiles and starts without errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-telegram-bot-i18n/11-01-SUMMARY.md`
</output>
