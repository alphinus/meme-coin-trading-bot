---
phase: 19-ai-function-migration
plan: 03
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - server/src/search/engine.ts
  - server/src/search/tools.ts
autonomous: true

must_haves:
  truths:
    - "aiSearch() delegates to warm session instead of AI SDK generateText with tools"
    - "Search tools are plain TypeScript functions, not AI SDK tool() wrappers"
    - "Natural-language search over projects, decisions, events, and ideas still works"
    - "Search results include tool call info and audit events"
  artifacts:
    - path: "server/src/search/engine.ts"
      provides: "aiSearch() using warm session with prompt-based tool orchestration"
      exports: ["aiSearch"]
    - path: "server/src/search/tools.ts"
      provides: "Search tool definitions as plain functions"
      exports: ["searchTools", "searchToolDescriptions"]
  key_links:
    - from: "server/src/search/engine.ts"
      to: "server/src/agent/warm-session.ts"
      via: "warmSession.generate() call"
      pattern: "warmSession\\.generate"
    - from: "server/src/search/engine.ts"
      to: "server/src/search/tools.ts"
      via: "plain function calls for search tool execution"
      pattern: "searchTools\\."
---

<objective>
Rewrite the search engine gateway (aiSearch) and search tool definitions to use the warm Agent SDK session instead of AI SDK v6 generateText with tool-calling.

Purpose: Migrate the search subsystem (1 gateway + 4 search tools) to the Agent SDK. This is the third gateway function. After this plan, all generateText/stepCountIs imports in the server are eliminated.
Output: Rewritten `search/engine.ts` and `search/tools.ts`. The search route (`routes/search.ts`) works unchanged.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-ai-function-migration/19-RESEARCH.md
@.planning/phases/19-ai-function-migration/19-01-SUMMARY.md
@server/src/search/engine.ts
@server/src/search/tools.ts
@server/src/agent/warm-session.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert search tools to plain functions</name>
  <files>server/src/search/tools.ts</files>
  <action>
Rewrite `server/src/search/tools.ts` to remove AI SDK dependency:

1. **Remove:** `import { tool } from "ai"` and all Zod imports (Zod schemas are only needed for AI SDK tool() inputSchema)
2. **Keep:** All data access imports (`getAllProjects`, `readEvents`, `readAllEvents`)
3. **Define plain tool interface:**
   ```typescript
   export interface SearchTool {
     description: string;
     execute: (args: Record<string, unknown>) => Promise<unknown>;
   }
   ```
4. **Convert each of the 4 search tools** (`search_projects`, `search_decisions`, `search_events`, `search_ideas`) from `tool({ description, inputSchema, execute })` to `{ description, execute }`. The execute functions remain identical -- they are already pure TypeScript.
5. **Export `searchTools`** as `Record<string, SearchTool>` with same keys
6. **Add `searchToolDescriptions()`** helper function that returns a formatted string describing all tools and their parameters (for use in system prompts):
   ```typescript
   export function searchToolDescriptions(): string {
     return Object.entries(searchTools)
       .map(([name, t]) => `- ${name}: ${t.description}`)
       .join("\n");
   }
   ```
  </action>
  <verify>
1. No AI SDK imports: `grep "from \"ai\"" server/src/search/tools.ts` returns no matches
2. No Zod imports: `grep "from \"zod\"" server/src/search/tools.ts` returns no matches (Zod was only for inputSchema)
3. searchTools exported: `grep "export const searchTools" server/src/search/tools.ts` returns a match
4. All 4 tools present: `grep -c "description:" server/src/search/tools.ts` returns 4+
  </verify>
  <done>Search tools are plain TypeScript functions. No AI SDK dependency.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite aiSearch() to use warm session</name>
  <files>server/src/search/engine.ts</files>
  <action>
Rewrite `server/src/search/engine.ts` to use warm session with prompt-based search:

1. **Remove:** `import { generateText, stepCountIs } from "ai"` and `import { aiRegistry, getModelForTask } from "../ai/providers.js"`
2. **Add:** `import { warmSession } from "../agent/warm-session.js"` and `import { searchTools, searchToolDescriptions } from "./tools.js"`
3. **Keep:** `import { recordAiCost } from "../ai/cost/tracker.js"`, `import { appendEvent } from "../events/store.js"`, `SearchResult` type
4. **Keep the exact same function signature:** `aiSearch(query: string, teamId: string, language: "de" | "en"): Promise<SearchResult>`
5. **New implementation approach (prompt-based search with tool orchestration):**
   - Build a system prompt that includes the search tool descriptions:
     ```
     You are a search assistant for Eluma. To find data, specify which tool to call by responding with JSON:
     {"tool": "tool_name", "args": {...}}

     Available tools:
     ${searchToolDescriptions()}

     Rules: 1) ALWAYS use tools before answering. 2) ONLY report tool results. 3) After receiving tool results, provide a final text answer.
     ```
   - Send to warmSession.generate() with the user's query
   - Parse response: if it contains a tool call JSON, execute the tool via `searchTools[toolName].execute(args)`, then send a follow-up with tool results
   - Support up to 5 rounds of tool calling (matching the previous stepCountIs(5))
   - Extract final answer text
6. **Keep cost recording** with `recordAiCost()` (zero tokens for now)
7. **Keep audit event emission** with the same `search.query_executed` event shape
8. **Keep the same return shape:** `{ answer, sources, executedAt }`
9. **Keep the same error handling** with graceful fallback returning error message
  </action>
  <verify>
1. No AI SDK imports: `grep "from \"ai\"" server/src/search/engine.ts` returns no matches
2. No providers import: `grep "providers" server/src/search/engine.ts` returns no matches
3. Warm session import: `grep "warm-session" server/src/search/engine.ts` returns a match
4. Function exported: `grep "export async function aiSearch" server/src/search/engine.ts` returns a match
5. TypeScript compiles: error count not increased beyond 19
  </verify>
  <done>aiSearch() uses warm session with prompt-based tool orchestration. Search route (routes/search.ts) works unchanged. All AI SDK imports removed from search subsystem.</done>
</task>

</tasks>

<verification>
1. `grep -r "from \"ai\"" server/src/search/` -- no matches (all AI SDK imports removed)
2. `grep "warmSession" server/src/search/engine.ts` -- uses warm session
3. `grep "searchTools" server/src/search/engine.ts` -- uses plain function tools
4. routes/search.ts unchanged -- still imports and calls aiSearch()
5. TypeScript error count <= 19
</verification>

<success_criteria>
- aiSearch() delegates to warm session, returns same SearchResult shape
- Search tools are plain functions (no AI SDK tool() wrapper)
- Zero changes to routes/search.ts (caller unchanged)
- No new TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-ai-function-migration/19-03-SUMMARY.md`
</output>
