---
phase: 19-ai-function-migration
plan: 06
type: execute
wave: 4
depends_on: ["19-05"]
files_modified:
  - server/src/ai/cost/tracker.ts
  - server/src/ai/cost/dashboard.ts
  - server/src/routes/ai.ts
  - client/src/hooks/useAiCost.ts
  - client/src/components/AiCostDashboard.tsx
autonomous: true

must_haves:
  truths:
    - "Cost dashboard shows subscription usage metrics instead of per-token costs"
    - "Dashboard displays total request count, breakdown by task type, and breakdown by month"
    - "Dashboard shows subscription status (active/inactive) based on CLAUDE_CODE_OAUTH_TOKEN"
    - "No per-token cost breakdowns or dollar amounts are displayed"
  artifacts:
    - path: "server/src/ai/cost/tracker.ts"
      provides: "recordAiUsage() for session-based usage tracking (replaces recordAiCost)"
      exports: ["recordAiUsage"]
    - path: "server/src/ai/cost/dashboard.ts"
      provides: "getUsageSummary() for usage aggregation (replaces getCostSummary)"
      exports: ["getUsageSummary", "getUsageSummaryForProject"]
    - path: "client/src/components/AiCostDashboard.tsx"
      provides: "Updated dashboard showing usage metrics"
    - path: "client/src/hooks/useAiCost.ts"
      provides: "Updated hook fetching usage data"
  key_links:
    - from: "server/src/ai/cost/tracker.ts"
      to: "server/src/events/store.ts"
      via: "appendEvent with ai.usage_recorded type"
      pattern: "ai\\.usage_recorded"
    - from: "server/src/routes/ai.ts"
      to: "server/src/ai/cost/dashboard.ts"
      via: "getUsageSummary() call in GET /cost endpoint"
      pattern: "getUsageSummary"
    - from: "client/src/hooks/useAiCost.ts"
      to: "/api/ai/cost"
      via: "apiCall GET"
      pattern: "api/ai/cost"
---

<objective>
Update the AI cost dashboard from per-token cost tracking to subscription-based usage analytics. The dashboard now shows request counts, task type breakdown, and subscription status instead of dollar amounts.

Purpose: Reflect the subscription billing model (Claude Max). There are no per-token costs to track, so the dashboard shifts to usage monitoring: how many AI requests were made, by which task type, and over what time period.
Output: Updated tracker, dashboard aggregation, server route, client hook, and client component.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-ai-function-migration/19-RESEARCH.md
@.planning/phases/19-ai-function-migration/19-05-SUMMARY.md
@server/src/ai/cost/tracker.ts
@server/src/ai/cost/dashboard.ts
@server/src/routes/ai.ts
@client/src/hooks/useAiCost.ts
@client/src/components/AiCostDashboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite cost tracker and dashboard aggregation for usage model</name>
  <files>server/src/ai/cost/tracker.ts, server/src/ai/cost/dashboard.ts, server/src/routes/ai.ts</files>
  <action>
**Part A: Rewrite `server/src/ai/cost/tracker.ts`**

Replace per-token cost tracking with usage event recording:

1. **Remove:** `import { MODEL_PRICING } from "./pricing.js"` (pricing.ts was deleted in 19-05; if not yet removed from import, do it now)
2. **Rename function:** `recordAiCost` -> `recordAiUsage` (but keep backward compat by also exporting under old name)
   - Actually, to minimize changes to callers in generate.ts and runner.ts (already modified in 19-02), export BOTH names:
     ```typescript
     export function recordAiUsage(...) { ... }
     export const recordAiCost = recordAiUsage; // backward compat alias
     ```
3. **Simplify the function:**
   ```typescript
   export function recordAiUsage(
     projectId: string,
     modelId: string,
     taskType: string,
     usage: { inputTokens: number; outputTokens: number },
     correlationId: string
   ): void {
     appendEvent({
       type: "ai.usage_recorded",
       aggregateType: "ai_usage",
       aggregateId: projectId,
       userId: AI_SYSTEM_USER_ID,
       correlationId,
       version: 1,
       data: {
         taskType,
         authMethod: "subscription",
         timestamp: new Date().toISOString(),
       },
     });
   }
   ```
   - No dollar cost calculation
   - New event type: `ai.usage_recorded` (distinct from old `ai.cost_recorded`)
   - New aggregate type: `ai_usage` (distinct from old `ai_cost`)

**Part B: Rewrite `server/src/ai/cost/dashboard.ts`**

Replace cost aggregation with usage aggregation:

1. **New interface:**
   ```typescript
   export interface UsageSummary {
     totalRequests: number;
     byTaskType: Record<string, number>;
     byMonth: Record<string, number>;
     subscriptionStatus: "active" | "inactive" | "unknown";
     authMethod: string;
   }
   ```
2. **Rename functions:** `getCostSummary` -> `getUsageSummary`, `getCostSummaryForProject` -> `getUsageSummaryForProject`
   - Export backward compat aliases: `export const getCostSummary = getUsageSummary;` etc.
3. **Rewrite aggregation:**
   - Read from BOTH `ai_usage` (new events) and `ai_cost` (old events from before migration) aggregateTypes
   - Count events instead of summing costs
   - Group by `data.taskType` instead of `data.modelId`
   - Group by month from timestamp
   - Detect subscription status from `process.env.CLAUDE_CODE_OAUTH_TOKEN`
4. **Return shape matches new UsageSummary interface**

**Part C: Update `server/src/routes/ai.ts`**

Update the cost endpoints to use new functions:

1. Update imports: add `getUsageSummary, getUsageSummaryForProject` (backward compat aliases mean existing imports still work, but update for clarity)
2. The GET `/cost` and GET `/cost/:projectId` endpoints now return UsageSummary shape
3. No endpoint URL changes needed (keep `/cost` path for backward compat with client)
  </action>
  <verify>
1. No pricing import: `grep "pricing" server/src/ai/cost/tracker.ts` returns no matches
2. Usage event type: `grep "ai.usage_recorded" server/src/ai/cost/tracker.ts` returns a match
3. UsageSummary interface: `grep "UsageSummary" server/src/ai/cost/dashboard.ts` returns a match
4. Functions exported: `grep "getUsageSummary\|getCostSummary" server/src/ai/cost/dashboard.ts` returns matches for both
5. Route updated: `grep "getUsageSummary\|getCostSummary" server/src/routes/ai.ts` returns a match
6. TypeScript compiles: error count not increased
  </verify>
  <done>Server-side cost tracking rewritten to usage model. Events record task type and subscription status. Dashboard aggregates request counts.</done>
</task>

<task type="auto">
  <name>Task 2: Update client cost dashboard for usage display</name>
  <files>client/src/hooks/useAiCost.ts, client/src/components/AiCostDashboard.tsx</files>
  <action>
**Part A: Update `client/src/hooks/useAiCost.ts`**

1. **Update CostSummary interface** to match new server response:
   ```typescript
   export interface UsageSummary {
     totalRequests: number;
     byTaskType: Record<string, number>;
     byMonth: Record<string, number>;
     subscriptionStatus: "active" | "inactive" | "unknown";
     authMethod: string;
   }
   // Backward compat
   export type CostSummary = UsageSummary;
   ```
2. **Update hook return type** to use UsageSummary
3. **Keep the same API endpoint** (`/api/ai/cost`) -- server still serves at this path
4. **Rename hook export:** Keep `useAiCost` name for backward compat

**Part B: Update `client/src/components/AiCostDashboard.tsx`**

Redesign the dashboard display:

1. **Header:** Change "AI Costs" to "AI Usage" (use i18n: `t("aiUsage.title")` or hardcoded if i18n keys don't exist yet -- add i18n keys in both de.json and en.json)
2. **Top card:** Replace "Total Cost" / dollar amount with "Total Requests" / count number
   - Format as plain integer (no currency formatting)
3. **Subscription status badge:**
   - Show subscription status: "active" = green badge, "inactive" = red badge, "unknown" = gray badge
   - Text: "Subscription: Active" / "Subscription: Inactive"
4. **By Task Type table** (replaces "By Model"):
   - Header: "By Task Type"
   - Columns: Task Type | Requests
   - Show task type names formatted nicely (snake_case to Title Case: "email_routing" -> "Email Routing")
   - Sorted by request count descending
5. **By Month table** (same structure, but counts instead of costs):
   - Header: "By Month"
   - Columns: Month | Requests
   - Use the existing formatMonth() helper
   - Show counts instead of currency
6. **Remove:** `formatCost()` function (no longer needed), any EUR/USD formatting
7. **Add i18n strings** to both `client/src/i18n/locales/en.json` and `client/src/i18n/locales/de.json`:
   - `aiUsage.title`: "AI Usage" / "KI-Nutzung"
   - `aiUsage.totalRequests`: "Total Requests" / "Gesamtanfragen"
   - `aiUsage.subscription`: "Subscription" / "Abonnement"
   - `aiUsage.active`: "Active" / "Aktiv"
   - `aiUsage.inactive`: "Inactive" / "Inaktiv"
   - `aiUsage.byTaskType`: "By Task Type" / "Nach Aufgabentyp"
   - `aiUsage.byMonth`: "By Month" / "Nach Monat"
   - `aiUsage.taskType`: "Task Type" / "Aufgabentyp"
   - `aiUsage.requests`: "Requests" / "Anfragen"
  </action>
  <verify>
1. No currency formatting: `grep "formatCost\|currency\|EUR\|USD" client/src/components/AiCostDashboard.tsx` returns no matches
2. Usage title: `grep -i "usage\|nutzung" client/src/components/AiCostDashboard.tsx` returns matches
3. Subscription status: `grep "subscriptionStatus\|subscription" client/src/components/AiCostDashboard.tsx` returns matches
4. UsageSummary type: `grep "UsageSummary" client/src/hooks/useAiCost.ts` returns a match
5. i18n keys added: `grep "aiUsage" client/src/i18n/locales/en.json client/src/i18n/locales/de.json` returns matches in both files
6. Client builds: `cd /Users/developer/eluma && npx tsc --noEmit -p client/tsconfig.json 2>&1 | tail -5` -- no new errors
  </verify>
  <done>Client dashboard shows AI usage metrics: total requests, by task type, by month, subscription status. No per-token cost display. i18n strings added in both languages.</done>
</task>

</tasks>

<verification>
1. Server: `grep "ai.usage_recorded" server/src/ai/cost/tracker.ts` -- new event type
2. Server: `grep "UsageSummary" server/src/ai/cost/dashboard.ts` -- new interface
3. Client: `grep "totalRequests" client/src/hooks/useAiCost.ts client/src/components/AiCostDashboard.tsx` -- usage model
4. Client: no currency formatting functions remain
5. i18n: both en.json and de.json have aiUsage keys
6. TypeScript: no new errors in server or client
</verification>

<success_criteria>
- Cost tracker records usage events (ai.usage_recorded), not cost events
- Dashboard aggregates request counts by task type and month
- Client displays "AI Usage" with request counts and subscription status
- No per-token cost display or currency formatting
- i18n strings added in both German and English
- No new TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-ai-function-migration/19-06-SUMMARY.md`
</output>
