---
phase: 19-ai-function-migration
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - .env
  - .env.example
  - .gitignore
  - server/package.json
  - server/src/system/config.ts
  - server/src/routes/system.ts
  - client/src/components/SetupWizard/Step3System.tsx
  - client/src/hooks/useSystemCapabilities.ts
  - client/src/i18n/locales/en.json
  - client/src/i18n/locales/de.json
autonomous: true
gap_closure: true

must_haves:
  truths:
    - ".env contains only placeholder/example values — no real credentials"
    - ".env.example documents which keys are AI generation keys (removed) vs integration keys (kept)"
    - ".env.local is gitignored and holds real credentials"
    - "Grep for ANTHROPIC_API_KEY or OPENAI_API_KEY returns zero matches outside documentation/comments"
    - "Dev server loads both .env and .env.local so integration APIs (Telegram, GitHub, Google) work at runtime"
    - "Zero claudeApiKey references in server or client code — grep returns zero matches"
    - "Setup wizard has no API key input field — subscription auth is the only path"
  artifacts:
    - path: ".env"
      provides: "Template with placeholders only, no real secrets"
      contains: "<your-"
    - path: ".env.example"
      provides: "Documented env template with AI key removal explanation"
      contains: "AI generation API keys have been removed"
    - path: ".env.local"
      provides: "Actual credentials (gitignored)"
    - path: ".gitignore"
      provides: "Ignores .env.local"
      contains: ".env.local"
    - path: "server/package.json"
      provides: "Dev script loads both .env and .env.local"
      contains: "--env-file=.env --env-file=.env.local"
    - path: "server/src/system/config.ts"
      provides: "SystemConfig interface without claudeApiKey field"
    - path: "client/src/components/SetupWizard/Step3System.tsx"
      provides: "Setup wizard without API key input section"
  key_links:
    - from: ".env"
      to: ".env.example"
      via: "mirror structure"
      pattern: "same variable names, .env has placeholders, .env.example has docs"
    - from: "server/package.json"
      to: ".env.local"
      via: "node --env-file flag"
      pattern: "--env-file=.env --env-file=.env.local"
---

<objective>
Close verification gaps: credential hygiene, API key documentation, and dead claudeApiKey code removal.

Purpose: Phase 19 verification found two issues: (1) .env contains real integration credentials alongside cleaned-up AI config — an anti-pattern; (2) the setup wizard still shows a "Claude API Key" input field with `sk-ant-...` placeholder — dead code that misleadingly suggests API key auth is supported, when all AI calls exclusively use subscription auth (CLAUDE_CODE_OAUTH_TOKEN). This plan moves real credentials to .env.local, documents the API key removal in .env.example, and removes all claudeApiKey dead code from server config, routes, client wizard, hook, and i18n to guarantee 100% subscription-only auth.

Output: Clean .env with placeholders, documented .env.example, .env.local with real credentials, zero claudeApiKey references in codebase, setup wizard with no API key input.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/19-ai-function-migration/19-05-SUMMARY.md
@.env
@.env.example
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move real credentials to .env.local and clean .env</name>
  <files>.env, .env.local, .gitignore, server/package.json</files>
  <action>
1. Create `.env.local` with the real credential values currently in `.env`:
   - TELEGRAM_BOT_TOKEN (copy actual value from .env)
   - GITHUB_TOKEN (copy actual value from .env)
   - GOOGLE_CLIENT_ID (copy actual value from .env)
   - GOOGLE_CLIENT_SECRET (copy actual value from .env)
   Add a header comment: `# Local credentials — NOT committed to git (see .gitignore)`

2. Rewrite `.env` to contain only safe defaults and placeholder values:
   ```
   PORT=3000
   NODE_ENV=development
   SESSION_SECRET=change-me
   DATA_DIR=./data
   RP_ID=localhost
   ORIGIN=http://localhost:3000

   # --- AI Generation Keys ---
   # REMOVED in Phase 19 (AI Function Migration).
   # All AI calls now use the Agent SDK with subscription auth (Claude Max).
   # ANTHROPIC_API_KEY and OPENAI_API_KEY are no longer used anywhere in the codebase.

   # --- Agent SDK Authentication (subscription) ---
   # Run `claude setup-token` to generate, then paste in .env.local:
   # CLAUDE_CODE_OAUTH_TOKEN=<your-token>

   # --- Whisper.cpp (local transcription) ---
   # WHISPER_CLI_PATH=/path/to/whisper-cli
   # WHISPER_MODEL_PATH=/path/to/ggml-small.bin

   # --- Integration Keys ---
   # These are integration API keys (NOT AI generation keys).
   # Place real values in .env.local (gitignored).
   # TELEGRAM_BOT_TOKEN=<your-telegram-bot-token>
   # GITHUB_TOKEN=<your-github-token>
   # GOOGLE_CLIENT_ID=<your-google-client-id>
   # GOOGLE_CLIENT_SECRET=<your-google-client-secret>

   NODE_TLS_REJECT_UNAUTHORIZED=0
   ```

3. Add `.env.local` to `.gitignore` (append after the existing `.env` line):
   ```
   .env
   .env.local
   ```
   Keep it on a separate line right after `.env`.

4. Update `server/package.json` dev script to load BOTH env files. The project uses Node v22 `--env-file` flags (NOT dotenv). The current dev script is:
   ```
   "dev": "cd .. && node --env-file=.env --import tsx/esm server/src/index.ts"
   ```
   Change it to:
   ```
   "dev": "cd .. && node --env-file=.env --env-file=.env.local --import tsx/esm server/src/index.ts"
   ```
   Node v22 supports multiple `--env-file` flags. The second file overrides values from the first. This is CRITICAL: without this change, .env.local credentials are never loaded and all integration APIs (Telegram, GitHub, Google) break at runtime. Note: if .env.local doesn't exist yet, Node will error — this is fine because step 1 creates it.
  </action>
  <verify>
- `cat .env` shows NO real tokens/secrets — only placeholders like `<your-...>` or commented-out lines
- `cat .env.local` contains the 4 real credential values
- `grep '.env.local' .gitignore` returns a match
- `grep -c 'ANTHROPIC_API_KEY\|OPENAI_API_KEY' .env` returns 0 for active (uncommented) lines
- `grep "--env-file=.env --env-file=.env.local" server/package.json` returns a match (dev script loads both files)
  </verify>
  <done>.env contains zero real credentials. .env.local holds real credentials and is gitignored. .gitignore lists both .env and .env.local. Dev script in server/package.json loads both .env and .env.local via --env-file flags.</done>
</task>

<task type="auto">
  <name>Task 2: Update .env.example with API key removal documentation</name>
  <files>.env.example</files>
  <action>
Rewrite `.env.example` to mirror the new `.env` structure with full documentation. The key addition is an explicit section explaining the AI generation key removal:

```
PORT=3000
NODE_ENV=development
SESSION_SECRET=change-me
DATA_DIR=./data
RP_ID=localhost
ORIGIN=http://localhost:3000

# ============================================================
# AI Generation API Keys — REMOVED (Phase 19)
# ============================================================
# As of v1.3, all AI-powered features use the Claude Agent SDK
# with subscription auth (Claude Max). Direct API calls via
# Vercel AI SDK have been fully removed.
#
# The following keys are NO LONGER USED:
#   - ANTHROPIC_API_KEY (was: direct Anthropic API access)
#   - OPENAI_API_KEY (was: direct OpenAI API access)
#
# If you see references to these keys in older documentation,
# they are historical artifacts only.
# ============================================================

# --- Agent SDK Authentication (subscription) ---
# The Agent SDK uses subscription auth (Claude Max) via OAuth token.
# Run `claude setup-token` to generate, then paste in .env.local:
# CLAUDE_CODE_OAUTH_TOKEN=<your-token>

# --- Whisper.cpp (local transcription) ---
# Optional: override default paths if whisper.cpp is installed elsewhere.
# WHISPER_CLI_PATH=/path/to/whisper-cli
# WHISPER_MODEL_PATH=/path/to/ggml-small.bin

# --- Integration Keys ---
# These are integration API keys for external services.
# They are NOT AI generation keys and remain in use.
# Place real values in .env.local (gitignored), not here.
# TELEGRAM_BOT_TOKEN=<your-telegram-bot-token>
# GITHUB_TOKEN=<your-github-token>
# GOOGLE_CLIENT_ID=<your-google-client-id>
# GOOGLE_CLIENT_SECRET=<your-google-client-secret>

NODE_TLS_REJECT_UNAUTHORIZED=0
```

Ensure the comment block clearly distinguishes:
- AI generation keys (REMOVED) — ANTHROPIC_API_KEY, OPENAI_API_KEY
- Integration keys (KEPT) — TELEGRAM_BOT_TOKEN, GITHUB_TOKEN, GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET
- Agent SDK auth (NEW) — CLAUDE_CODE_OAUTH_TOKEN
  </action>
  <verify>
- `grep 'NO LONGER USED' .env.example` returns a match
- `grep 'ANTHROPIC_API_KEY' .env.example` returns matches ONLY in comment lines (prefixed with #)
- `grep 'OPENAI_API_KEY' .env.example` returns matches ONLY in comment lines (prefixed with #)
- `grep 'Integration Keys' .env.example` returns a match
- `grep '.env.local' .env.example` returns a match (references .env.local for real values)
  </verify>
  <done>.env.example clearly documents the distinction between removed AI generation keys and kept integration keys. All API key references are in comments explaining the removal.</done>
</task>

<task type="auto">
  <name>Task 3: Remove claudeApiKey dead code from setup wizard, hook, config, and route</name>
  <files>server/src/system/config.ts, server/src/routes/system.ts, client/src/components/SetupWizard/Step3System.tsx, client/src/hooks/useSystemCapabilities.ts, client/src/i18n/locales/en.json, client/src/i18n/locales/de.json</files>
  <action>
The setup wizard still shows a "Claude API Key" input field with `sk-ant-...` placeholder. This is dead code from the API-key era — the value is saved to config.json but never read by any AI call (warm-session.ts, generate.ts, runner.ts, engine.ts all use CLAUDE_CODE_OAUTH_TOKEN from env). Remove it completely to ensure subscription-only auth is the only path.

1. **server/src/system/config.ts** — Remove `claudeApiKey?: string;` from the `SystemConfig` interface (line 18).

2. **server/src/routes/system.ts** — Remove `claudeApiKey` from the Zod schema `saveCapabilitiesSchema` (line 32: `claudeApiKey: z.string().optional()`). In the POST handler, remove the `claudeApiKey` destructuring from `req.body` (line 127) and remove the `claudeApiKey: claudeApiKey || undefined` line from the config object (line 137).

3. **client/src/components/SetupWizard/Step3System.tsx**:
   - Remove `const [claudeApiKey, setClaudeApiKey] = useState("");` (line 37)
   - Change `saveCapabilities(currentEnabled, claudeApiKey || undefined)` to `saveCapabilities(currentEnabled)` (line 63-65)
   - Remove the entire "Claude API Key" section (lines 177-191): the `<div style={styles.apiKeySection}>` block with label, hint, and input
   - Remove the `apiKeySection` and `apiKeyHint` style entries from the styles object (lines 354-365)

4. **client/src/hooks/useSystemCapabilities.ts**:
   - Remove `claudeApiKey?: string` parameter from `saveCapabilities` in the interface (line 30)
   - Change function signature from `async (enabledNames: string[], claudeApiKey?: string)` to `async (enabledNames: string[])` (line 78)
   - Remove the `claudeApiKey` body construction (lines 81-86): change to just `const body = { enabled: enabledNames };`

5. **client/src/i18n/locales/en.json** — Remove the two keys:
   - `"claude_api_key": "Claude API Key"`
   - `"claude_api_key_hint": "Required for AI features. You can add this later."`

6. **client/src/i18n/locales/de.json** — Remove the two keys:
   - `"claude_api_key": "Claude API-Schlüssel"`
   - `"claude_api_key_hint": "Erforderlich für KI-Funktionen. Kann später hinzugefügt werden."`

IMPORTANT: Both i18n files updated in the same commit per CLAUDE.md rules.
  </action>
  <verify>
- `grep -rn "claudeApiKey" server/src/ client/src/ --include="*.ts" --include="*.tsx"` returns ZERO matches
- `grep -rn "claude_api_key" client/src/i18n/locales/` returns ZERO matches
- `grep -rn "sk-ant-" client/src/` returns ZERO matches
- `grep -rn "apiKeySection\|apiKeyHint" client/src/components/SetupWizard/` returns ZERO matches
- TypeScript compiles with zero errors: `cd server && npx tsc --noEmit`
  </verify>
  <done>All claudeApiKey dead code removed. Setup wizard has no API key input. SystemConfig has no API key field. The only auth path is subscription via CLAUDE_CODE_OAUTH_TOKEN environment variable.</done>
</task>

</tasks>

<verification>
1. `grep -rn 'ANTHROPIC_API_KEY\|OPENAI_API_KEY' .env .env.example` — only comment lines (# prefix)
2. `cat .env | grep -v '^#' | grep -v '^$'` — no real tokens visible in active lines
3. `cat .env.local` — contains real TELEGRAM_BOT_TOKEN, GITHUB_TOKEN, GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET
4. `grep '.env.local' .gitignore` — confirms .env.local is gitignored
5. `diff <(grep -v '^#' .env | grep -v '^$' | sort) <(grep -v '^#' .env.example | grep -v '^$' | sort)` — active lines should be identical (same structure)
6. `grep "--env-file=.env --env-file=.env.local" server/package.json` — dev script loads both env files
7. `grep -rn "claudeApiKey" server/src/ client/src/ --include="*.ts" --include="*.tsx"` — ZERO matches
8. `grep -rn "claude_api_key" client/src/i18n/locales/` — ZERO matches
9. `grep -rn "sk-ant-" client/src/` — ZERO matches
</verification>

<success_criteria>
- .env contains zero real credentials (only placeholders and safe defaults like PORT=3000)
- .env.example has explicit documentation block explaining ANTHROPIC_API_KEY and OPENAI_API_KEY removal
- .env.example distinguishes AI generation keys (removed) from integration keys (kept)
- .env.local exists with real credentials and is gitignored
- server/package.json dev script uses `--env-file=.env --env-file=.env.local` so credentials load at runtime
- Zero claudeApiKey references in server or client code
- Setup wizard has no API key input field — subscription auth via CLAUDE_CODE_OAUTH_TOKEN is the only path
- i18n files have no claude_api_key or claude_api_key_hint keys
- No functional behavior changes — only credential hygiene, dead code removal, and documentation
</success_criteria>

<output>
After completion, create `.planning/phases/19-ai-function-migration/19-07-SUMMARY.md`
</output>
