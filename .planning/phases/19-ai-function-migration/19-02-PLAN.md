---
phase: 19-ai-function-migration
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - server/src/ai/generate.ts
  - server/src/ai/tools/runner.ts
  - server/src/ai/tools/definitions.ts
  - server/src/ai/config.ts
autonomous: true

must_haves:
  truths:
    - "generateAiResponse() delegates to warm session instead of AI SDK generateText()"
    - "runAiTools() delegates to warm session with prompt-based tool calling instead of AI SDK tool()"
    - "All 9 generateAiResponse callers and 7 runAiTools callers continue working without modification"
    - "AI tool definitions are plain TypeScript functions, not AI SDK tool() wrappers"
  artifacts:
    - path: "server/src/ai/generate.ts"
      provides: "generateAiResponse() using warm session"
      exports: ["generateAiResponse"]
    - path: "server/src/ai/tools/runner.ts"
      provides: "runAiTools() using warm session with prompt-based tool orchestration"
      exports: ["runAiTools"]
    - path: "server/src/ai/tools/definitions.ts"
      provides: "AI tool definitions as plain functions (no AI SDK tool() dependency)"
      exports: ["AI_TOOLS", "AiToolName"]
  key_links:
    - from: "server/src/ai/generate.ts"
      to: "server/src/agent/warm-session.ts"
      via: "warmSession.generate() call"
      pattern: "warmSession\\.generate"
    - from: "server/src/ai/tools/runner.ts"
      to: "server/src/agent/warm-session.ts"
      via: "warmSession.generate() call for prompt-based tool orchestration"
      pattern: "warmSession\\.generate"
    - from: "server/src/ai/tools/runner.ts"
      to: "server/src/ai/tools/definitions.ts"
      via: "plain function calls for tool execution"
      pattern: "AI_TOOLS\\[.*\\]\\.execute"
---

<objective>
Rewrite the two main gateway functions (generateAiResponse and runAiTools) to use the warm Agent SDK session instead of AI SDK v6 generateText. Convert AI tool definitions from AI SDK tool() wrappers to plain TypeScript functions.

Purpose: Migrate all 16 call sites (9 generateAiResponse + 7 runAiTools) to the Agent SDK without touching any caller files. The gateway pattern means rewriting these 3 files migrates the entire non-search AI subsystem.
Output: Rewritten `generate.ts`, `runner.ts`, `definitions.ts`. All downstream callers work unchanged.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-ai-function-migration/19-RESEARCH.md
@.planning/phases/19-ai-function-migration/19-01-SUMMARY.md
@server/src/ai/generate.ts
@server/src/ai/tools/runner.ts
@server/src/ai/tools/definitions.ts
@server/src/ai/config.ts
@server/src/agent/warm-session.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite generateAiResponse() to use warm session</name>
  <files>server/src/ai/generate.ts</files>
  <action>
Rewrite `server/src/ai/generate.ts` to delegate to the warm session:

1. **Remove AI SDK imports:** Remove `import { generateText } from "ai"` and `import { aiRegistry, getModelForTask } from "./providers.js"`
2. **Add warm session import:** `import { warmSession } from "../agent/warm-session.js"`
3. **Keep existing imports:** `recordAiCost` from cost/tracker (will be updated in 19-06, still functional for now), `appendEvent` from events/store, config presets, types
4. **Rewrite the function body:**
   - Keep the exact same function signature: `async function generateAiResponse(options: AiGenerateOptions)`
   - Keep the exact same return type: `{ text, usage, finishReason, event }`
   - Build the language instruction the same way
   - Build the full system prompt the same way
   - Call `warmSession.generate({ systemPrompt: fullSystemPrompt, userPrompt, taskType })` instead of `generateText()`
   - For the return value:
     - `text` = result from warmSession.generate()
     - `usage` = `{ inputTokens: 0, outputTokens: 0 }` (subscription model: no per-token tracking, but keep the shape for backward compat)
     - `finishReason` = `"stop"`
   - Still call `recordAiCost()` with zero tokens (keeps event audit trail, cost will be zero)
   - Still emit `ai.response_generated` event with the same shape (use `"agent-sdk"` as modelId)
5. **Keep error handling** with the same catch pattern and error message format

**Critical: The function signature and return shape must NOT change.** All 9 callers depend on the existing contract: `{ text: string, usage: object, finishReason: string, event: object }`.
  </action>
  <verify>
1. No AI SDK imports: `grep "from \"ai\"" server/src/ai/generate.ts` returns no matches
2. No providers import: `grep "providers" server/src/ai/generate.ts` returns no matches
3. Warm session import: `grep "warm-session" server/src/ai/generate.ts` returns a match
4. Function still exported: `grep "export async function generateAiResponse" server/src/ai/generate.ts` returns a match
5. TypeScript compiles: `npx tsc --noEmit 2>&1 | grep "generate.ts"` returns no errors (or only pre-existing ones)
  </verify>
  <done>generateAiResponse() delegates to warm session. All 9 callers (reflection, mediation, email drafter, email router, google email routing, github analyzer, github fork, voice router analysis, idea refinement) work without modification.</done>
</task>

<task type="auto">
  <name>Task 2: Convert tool definitions to plain functions and rewrite runAiTools()</name>
  <files>server/src/ai/tools/definitions.ts, server/src/ai/tools/runner.ts</files>
  <action>
**Part A: Rewrite `server/src/ai/tools/definitions.ts`**

Convert each tool from AI SDK `tool()` wrappers to plain typed objects:

1. **Remove:** `import { tool } from "ai"`
2. **Keep:** All Zod imports (for parameter validation), all data access imports (getAllProjects, getAllIdeas, getOctokit, etc.)
3. **Define a plain tool interface:**
   ```typescript
   export interface PlainTool {
     description: string;
     execute: (args: Record<string, unknown>) => Promise<unknown>;
   }
   ```
4. **Convert each tool:** Replace `tool({ description, inputSchema, execute })` with `{ description, execute }` (plain object matching PlainTool interface). Keep the execute functions exactly as they are -- they are pure TypeScript already.
5. **Keep `AI_TOOLS` export** with the same keys but as `Record<string, PlainTool>` type
6. **Keep `AiToolName` type** and `AI_TOOL_NAMES` array unchanged

**Part B: Rewrite `server/src/ai/tools/runner.ts`**

Convert tool-calling from AI SDK multi-step generateText to prompt-based approach via warm session:

1. **Remove:** `import { generateText, stepCountIs } from "ai"` and `import { aiRegistry, getModelForTask } from "../providers.js"`
2. **Add:** `import { warmSession } from "../../agent/warm-session.js"`
3. **Keep the exact same function signature and return type** for `runAiTools()`
4. **New approach (prompt-based tool orchestration):**
   - Build a system prompt that describes available tools as a JSON schema
   - Format: "Available tools: [tool1: description, tool2: description]. To use a tool, respond with JSON: { \"tool\": \"toolName\", \"args\": { ... } }. After receiving tool results, synthesize a final answer."
   - Send to warmSession.generate()
   - Parse the response: if it contains a tool call JSON, execute the tool, then send a follow-up message with the result
   - If no tool call, treat as final answer
   - Maximum of `maxSteps` tool-calling rounds
5. **Keep the same return shape:** `{ text, toolCalls, toolResults, usage, finishReason, eventId }`
6. **Keep cost recording and audit event emission** (same as before, with zero-token usage)
  </action>
  <verify>
1. No AI SDK imports in definitions: `grep "from \"ai\"" server/src/ai/tools/definitions.ts` returns no matches
2. No AI SDK imports in runner: `grep "from \"ai\"" server/src/ai/tools/runner.ts` returns no matches
3. Warm session import in runner: `grep "warm-session" server/src/ai/tools/runner.ts` returns a match
4. AI_TOOLS still exported: `grep "export const AI_TOOLS" server/src/ai/tools/definitions.ts` returns a match
5. runAiTools still exported: `grep "export async function runAiTools" server/src/ai/tools/runner.ts` returns a match
6. TypeScript error count not increased: `npx tsc --noEmit 2>&1 | grep -c "error TS"` <= 19
  </verify>
  <done>AI tools are plain TypeScript functions. runAiTools() uses warm session with prompt-based tool orchestration. All 7 call sites in routes/ai-tools.ts and routes/search.ts work unchanged.</done>
</task>

</tasks>

<verification>
1. `grep -r "from \"ai\"" server/src/ai/generate.ts server/src/ai/tools/runner.ts server/src/ai/tools/definitions.ts` -- no matches (all AI SDK imports removed from these files)
2. `grep -r "warmSession" server/src/ai/generate.ts server/src/ai/tools/runner.ts` -- both files use warm session
3. All 16 downstream callers remain unchanged -- no file modifications outside the 3 gateway files
4. TypeScript compilation: error count not increased
</verification>

<success_criteria>
- generateAiResponse() delegates to warm session, returns same shape
- runAiTools() uses prompt-based tool orchestration via warm session
- AI tool definitions are plain functions (no AI SDK tool() wrapper)
- Zero changes to caller files (9 generateAiResponse callers + 7 runAiTools callers)
- No new TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-ai-function-migration/19-02-SUMMARY.md`
</output>
