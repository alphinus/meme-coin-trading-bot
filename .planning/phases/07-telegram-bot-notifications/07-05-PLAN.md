---
phase: 07-telegram-bot-notifications
plan: 05
type: execute
wave: 3
depends_on: ["07-01", "07-02", "07-03", "07-04"]
files_modified:
  - server/src/telegram/bot.ts
  - server/src/app.ts
  - server/src/notifications/emitter.ts
  - server/src/routes/auth.ts
  - server/src/routes/notifications.ts
  - client/src/i18n/locales/en.json
  - client/src/i18n/locales/de.json
  - client/src/hooks/useNotifications.ts
  - client/src/components/NotificationBell.tsx
  - client/src/pages/NotificationSettings.tsx
  - client/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "All bot handlers are registered and bot starts on server launch"
    - "Domain events automatically trigger notifications via dispatcher"
    - "Web client shows notification bell with unread count and notification list"
    - "User can configure notification preferences from the web UI"
    - "Telegram linking code can be generated from the web app settings"
    - "All Telegram bot messages are available in German and English"
  artifacts:
    - path: "server/src/notifications/emitter.ts"
      provides: "Domain event to notification bridge"
      exports: ["emitNotificationForEvent"]
    - path: "client/src/hooks/useNotifications.ts"
      provides: "Client hook for notification polling and preference management"
      exports: ["useNotifications"]
    - path: "client/src/components/NotificationBell.tsx"
      provides: "Nav bar notification bell with unread count + dropdown"
      exports: ["NotificationBell"]
    - path: "client/src/pages/NotificationSettings.tsx"
      provides: "Notification preference management page"
      exports: ["NotificationSettings"]
  key_links:
    - from: "server/src/notifications/emitter.ts"
      to: "server/src/notifications/dispatcher.ts"
      via: "dispatchNotification called from event handler"
      pattern: "dispatchNotification"
    - from: "server/src/telegram/bot.ts"
      to: "server/src/telegram/commands.ts"
      via: "registerCommands(bot) called during setup"
      pattern: "registerCommands"
    - from: "server/src/telegram/bot.ts"
      to: "server/src/telegram/menus/"
      via: "bot.use(menu) for all menus"
      pattern: "bot\\.use.*Menu"
    - from: "client/src/components/NotificationBell.tsx"
      to: "/api/notifications/unread"
      via: "useNotifications hook polling"
      pattern: "api/notifications"
    - from: "server/src/app.ts"
      to: "server/src/routes/notifications.ts"
      via: "app.use('/api/notifications', requireAuth, notificationsRouter)"
      pattern: "notificationsRouter"
---

<objective>
Wire everything together: register all bot handlers and menus in the bot setup, register notification routes in app.ts, create the domain-event-to-notification bridge, add i18n keys for all Telegram messages in DE/EN, build client notification components (bell + settings page), add Telegram linking code generation to web auth, and perform end-to-end verification.

Purpose: This is the integration plan that connects all Phase 7 components into a working whole. Without this, the bot handlers exist but are not registered, notifications exist but are not triggered, and the web UI has no notification features.
Output: Fully functional Telegram bot + multi-channel notification system integrated into the application.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-telegram-bot-notifications/07-RESEARCH.md
@.planning/phases/07-telegram-bot-notifications/07-01-SUMMARY.md
@.planning/phases/07-telegram-bot-notifications/07-02-SUMMARY.md
@.planning/phases/07-telegram-bot-notifications/07-03-SUMMARY.md
@.planning/phases/07-telegram-bot-notifications/07-04-SUMMARY.md

@eluma/server/src/app.ts
@eluma/server/src/telegram/bot.ts
@eluma/server/src/notifications/dispatcher.ts
@eluma/client/src/i18n/locales/en.json
@eluma/client/src/i18n/locales/de.json
@eluma/client/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire bot handlers, notification routes, event-to-notification bridge, and i18n</name>
  <files>
    server/src/telegram/bot.ts
    server/src/app.ts
    server/src/notifications/emitter.ts
    server/src/routes/auth.ts
    server/src/routes/notifications.ts
    client/src/i18n/locales/en.json
    client/src/i18n/locales/de.json
  </files>
  <action>
    1. Update server/src/telegram/bot.ts setupBot function to:
       - Import and call registerCommands(bot) from ./commands.js
       - Import all menus (projectMenu, projectDetailMenu, ideaMenu, ideaDetailMenu, settingsMenu, workflowMenu)
       - Register all menus with bot.use()
       - Import and register voice handler: bot.on("message:voice", handleVoiceMessage)
       - Import and register text handler: bot.on("message:text", handleTextMessage) -- AFTER commands
       - Import and register callback handler: bot.callbackQuery(/^wf:/, handleWorkflowCallback) and bot.callbackQuery(/^vr:/, handleVoiceRoutingCallback)
       - Call bot.api.setMyCommands() with all commands

    2. Update server/src/app.ts to:
       - Import notificationsRouter from ./routes/notifications.js
       - Add: app.use("/api/notifications", requireAuth, notificationsRouter)
       - Ensure setupBot() is called during server initialization (add to the existing async startup if not already)

    3. Create server/src/notifications/emitter.ts:
       - Import dispatchNotification from ./dispatcher.js
       - Import DomainEvent from shared/types/events.js
       - Define EVENT_NOTIFICATION_MAP: mapping from event types to notification metadata:
         - "project.created" -> priority: "medium", title: "New Project", body from event data
         - "project.phase_advanced" -> priority: "high", title: "Phase Advanced", body with project+phase name
         - "project.archived" -> priority: "low", title: "Project Archived"
         - "idea.created" -> priority: "low", title: "New Idea"
         - "idea.graduated" -> priority: "high", title: "Idea Graduated to Project"
         - "idea.graduation_proposed" -> priority: "medium", title: "Graduation Proposed"
         - "idea.graduation_voted" -> priority: "medium", title: "Graduation Vote Cast"
         - "workflow.step_completed" -> priority: "low", title: "Workflow Step Completed"
         - "ai.trigger_fired" -> priority: "medium", title: "AI Alert"
         - "ai.mediation_completed" -> priority: "high", title: "AI Mediation Complete"
       - emitNotificationForEvent(event: DomainEvent): checks EVENT_NOTIFICATION_MAP, if event type has mapping, gets all team members for the event's project/team, calls dispatchNotification for EACH member (except the user who triggered the event -- no self-notifications)
       - Export emitNotificationForEvent
       - Wire into existing fire-and-forget pattern: add comment showing how to call from route handlers (same pattern as processEventForDocumentation and evaluateTriggersForEvent)

    4. Update server/src/routes/auth.ts:
       - Add GET /telegram-link-code endpoint: calls generateLinkingCode(req.session.userId), returns { code, expiresAt }
       - This allows the web app to generate a linking code the user can send to the Telegram bot

    5. Add i18n keys to client/src/i18n/locales/en.json under new "telegram" and "notifications" sections:
       - telegram.linkInstructions, telegram.linkSuccess, telegram.notLinked, telegram.alreadyLinked
       - telegram.transcribing, telegram.transcriptionResult, telegram.routingSuggestions
       - telegram.workflowStepComplete, telegram.workflowPhaseAdvanced, telegram.noActiveWorkflow
       - telegram.help, telegram.status
       - notifications.title, notifications.settings, notifications.preferences
       - notifications.channels.web, notifications.channels.telegram, notifications.channels.email
       - notifications.priorities.low, notifications.priorities.medium, notifications.priorities.high, notifications.priorities.critical
       - notifications.noUnread, notifications.markRead, notifications.markAllRead

    6. Add same keys to client/src/i18n/locales/de.json with German translations.
  </action>
  <verify>cd /Users/developer/eluma && npx tsc --noEmit</verify>
  <done>Bot handlers registered in correct order, notification routes mounted, domain events trigger notifications via emitter, Telegram linking code available from web API, all i18n keys present in EN and DE</done>
</task>

<task type="auto">
  <name>Task 2: Build client notification components and route registration</name>
  <files>
    client/src/hooks/useNotifications.ts
    client/src/components/NotificationBell.tsx
    client/src/pages/NotificationSettings.tsx
    client/src/App.tsx
  </files>
  <action>
    1. Create client/src/hooks/useNotifications.ts:
       - Import apiCall from api/client.js (existing pattern)
       - useNotifications() hook:
         a. State: unread NotificationEvent[], preferences NotificationPreferenceState | null, loading boolean
         b. On mount: fetch GET /api/notifications/unread, fetch GET /api/notifications (preferences)
         c. Set up 30-second polling interval for unread (matches existing polling pattern)
         d. markRead(id: string): POST /api/notifications/{id}/read, remove from local state
         e. markAllRead(): for each unread, mark as read
         f. updatePreference(channel, priority, enabled): PUT /api/notifications/preferences, update local state
         g. Return { unread, unreadCount, preferences, loading, markRead, markAllRead, updatePreference }

    2. Create client/src/components/NotificationBell.tsx:
       - Import useNotifications
       - Render bell icon (Unicode bell character or SVG) in nav bar position
       - Show unread count badge (red circle with number) when count > 0
       - On click: toggle dropdown showing list of notifications
       - Each notification shows: priority color dot, title, body (truncated), relative timestamp
       - Click notification: markRead(id)
       - "Mark all read" button at bottom of dropdown
       - Empty state: "No new notifications"

    3. Create client/src/pages/NotificationSettings.tsx:
       - Import useNotifications for preferences
       - Section: "Telegram Linking"
         - If not linked: "Generate Linking Code" button that calls GET /api/auth/telegram-link-code
         - Shows code with instructions: "Send /start {code} to @{botName} in Telegram"
         - Code auto-expires text
       - Section: "Notification Preferences"
         - Grid/table layout: rows = priorities (critical, high, medium, low), columns = channels (Web, Telegram, Email)
         - Each cell is a toggle/checkbox
         - Changes call updatePreference immediately
         - Use same Tailwind patterns as existing settings/forms in the app

    4. Update client/src/App.tsx:
       - Import NotificationBell, add to nav bar (inside header, next to user menu)
       - Import NotificationSettings page
       - Add route: /settings/notifications -> NotificationSettings
       - Add nav link to settings/notifications in appropriate location (settings section or user menu)
  </action>
  <verify>cd /Users/developer/eluma && npx tsc --noEmit && cd /Users/developer/eluma && npx vite build --config client/vite.config.ts 2>&1 | tail -5</verify>
  <done>NotificationBell shows unread count with dropdown in nav, NotificationSettings page has Telegram linking + preference toggles, route registered in App.tsx</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: End-to-end verification of Telegram bot and notification system</name>
  <files>none</files>
  <action>
    Human verification of the complete Telegram bot and notification system integration.
    All automated work is complete in Tasks 1-2. This checkpoint verifies the full system works end-to-end.
  </action>
  <verify>
    1. Start the server: cd /Users/developer/eluma and npm run dev
    2. Check that the server starts without errors (look for "Bot" messages in console)
    3. Visit the web app, navigate to /settings/notifications
    4. Verify: Telegram linking section shows "Generate Linking Code" button
    5. Verify: Notification preferences grid shows channels x priorities
    6. Verify: NotificationBell appears in the nav bar
    7. If TELEGRAM_BOT_TOKEN is configured:
       a. Generate a linking code from the web app
       b. Send /start {code} to the bot in Telegram
       c. Send /projects to see project list
       d. Send /ideas to see idea pool
       e. Send a voice message and verify transcription response
    8. Check TypeScript compiles: npx tsc --noEmit
  </verify>
  <done>Server starts cleanly, web notification UI renders correctly, Telegram bot responds to commands (if token configured), TypeScript compiles without errors</done>
</task>

</tasks>

<verification>
- `cd /Users/developer/eluma && npx tsc --noEmit` compiles without errors
- `cd /Users/developer/eluma && npx vite build --config client/vite.config.ts` builds without errors
- `grep "notificationsRouter" server/src/app.ts` confirms notification routes registered
- `grep "setupBot" server/src/app.ts` confirms bot initialization
- `grep "emitNotificationForEvent" server/src/notifications/emitter.ts` confirms event bridge
- `grep "telegram-link-code" server/src/routes/auth.ts` confirms linking code endpoint
- `grep "NotificationBell" client/src/App.tsx` confirms bell in nav
- `grep "notifications" client/src/i18n/locales/en.json` confirms i18n keys
</verification>

<success_criteria>
- All bot handlers registered in correct priority order (commands > menus > voice > text)
- Notification routes mounted at /api/notifications with requireAuth
- Domain events trigger notifications to team members via emitter -> dispatcher -> channels
- Telegram linking code generatable from web app auth endpoint
- NotificationBell shows unread count with dropdown in web nav bar
- NotificationSettings page has Telegram linking and preference management
- All i18n keys present in both EN and DE
- TypeScript and Vite build both compile without errors
- Server starts without errors even when TELEGRAM_BOT_TOKEN is not set
</success_criteria>

<output>
After completion, create `.planning/phases/07-telegram-bot-notifications/07-05-SUMMARY.md`
</output>
