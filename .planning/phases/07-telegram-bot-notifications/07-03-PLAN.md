---
phase: 07-telegram-bot-notifications
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - server/src/telegram/formatters.ts
  - server/src/telegram/commands.ts
  - server/src/telegram/menus/project-menu.ts
  - server/src/telegram/menus/idea-menu.ts
  - server/src/telegram/menus/settings-menu.ts
autonomous: true

must_haves:
  truths:
    - "User can /start with a linking code to connect Telegram to Eluma account"
    - "User can list projects via /projects and navigate to project details with inline buttons"
    - "User can browse ideas via /ideas and trigger refinement or graduation actions"
    - "User can view and update notification preferences via /settings menu"
    - "/help lists all available commands"
  artifacts:
    - path: "server/src/telegram/commands.ts"
      provides: "Slash command handlers for /start, /projects, /ideas, /status, /help"
      exports: ["registerCommands"]
    - path: "server/src/telegram/menus/project-menu.ts"
      provides: "Dynamic project list menu with detail view"
      exports: ["projectMenu", "projectDetailMenu"]
    - path: "server/src/telegram/menus/idea-menu.ts"
      provides: "Idea pool browsing menu with refinement/graduation actions"
      exports: ["ideaMenu", "ideaDetailMenu"]
    - path: "server/src/telegram/menus/settings-menu.ts"
      provides: "Notification preference toggle menu"
      exports: ["settingsMenu"]
    - path: "server/src/telegram/formatters.ts"
      provides: "Message formatting helpers for Telegram Markdown"
      exports: ["formatProjectDetail", "formatProjectList", "formatIdeaDetail", "formatIdeaList", "formatStatus", "phaseEmoji"]
  key_links:
    - from: "server/src/telegram/commands.ts"
      to: "server/src/telegram/auth.ts"
      via: "/start command uses consumeLinkingCode + linkTelegramUser"
      pattern: "consumeLinkingCode"
    - from: "server/src/telegram/menus/project-menu.ts"
      to: "server/src/events/reducers/project.ts"
      via: "getProjectsForTeam via getAllProjects filter"
      pattern: "getAllProjects|getProjectById"
    - from: "server/src/telegram/menus/idea-menu.ts"
      to: "server/src/events/reducers/idea.ts"
      via: "getIdeasForTeam for idea listing"
      pattern: "getIdeasForTeam|getIdeaById"
    - from: "server/src/telegram/menus/settings-menu.ts"
      to: "server/src/notifications/preferences.ts"
      via: "getPreferencesForUser + updatePreference"
      pattern: "getPreferencesForUser|updatePreference"
---

<objective>
Build all Telegram slash commands (/start, /projects, /ideas, /status, /help) and interactive inline menus for project navigation, idea pool browsing, and notification settings. This makes the bot usable for core project and idea workflows via Telegram buttons.

Purpose: Satisfies TELE-01 (web app mirroring), TELE-02 (slash commands + button mini GUI), TELE-04 (project navigation via buttons), and TELE-05 (status updates in Telegram).
Output: Fully interactive bot with project/idea navigation and settings management.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-telegram-bot-notifications/07-RESEARCH.md
@.planning/phases/07-telegram-bot-notifications/07-01-SUMMARY.md

@eluma/server/src/telegram/bot.ts
@eluma/server/src/telegram/auth.ts
@eluma/server/src/telegram/types.ts
@eluma/server/src/events/reducers/project.ts
@eluma/server/src/events/reducers/idea.ts
@eluma/shared/types/models.ts
@eluma/shared/types/idea.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create formatters and slash command handlers</name>
  <files>
    server/src/telegram/formatters.ts
    server/src/telegram/commands.ts
  </files>
  <action>
    1. Create server/src/telegram/formatters.ts:
       - phaseEmoji(phase: ProjectPhase): returns emoji for each lifecycle phase (idea=lightbulb, feasibility=magnifying glass, effort_estimate=calculator, roi_kpi_initial=chart, risks_dependencies=warning, decision_point=traffic light, implementation=hammer, review_extraction=star)
       - statusEmoji(status: IdeaStatus): returns emoji per idea status (capturing=microphone, refining=gear, ready=checkmark, voting=ballot, graduated=rocket, archived=folder)
       - formatProjectDetail(project: ProjectState): Telegram MarkdownV2-safe string with name (bold), phase, description (truncated to 200 chars), member count, created date
       - formatProjectList(projects: ProjectState[]): numbered list with phase emoji + name, max 10 items with "and N more..." suffix
       - formatIdeaDetail(idea: IdeaState): title (bold), status, readiness score as bar (filled/empty blocks), refinement rounds, raw input excerpt (truncated to 300 chars)
       - formatIdeaList(ideas: IdeaState[]): numbered list with status emoji + title, max 10 items
       - formatStatus(projects: ProjectState[], ideas: IdeaState[]): summary showing active project count, idea count by status, most recent activity
       - escapeMd(text: string): escape Telegram MarkdownV2 special chars: _ * [ ] ( ) ~ ` > # + - = | { } . !

    2. Create server/src/telegram/commands.ts:
       - Import bot from ./bot.js, resolveElumaUser/consumeLinkingCode/linkTelegramUser from ./auth.js
       - Import getAllProjects from events/reducers/project.js, getIdeasForTeam from events/reducers/idea.js
       - Import formatters, import getTeamForUser from ./auth.js
       - Import setTelegramChatId from notifications/preferences.js

       registerCommands(bot): function that registers all command handlers:

       /start handler:
       - If message text contains a code after /start (e.g., "/start 123456"), try consumeLinkingCode
       - If code valid: linkTelegramUser with ctx.from.id, resolved elumaUserId, ctx.chat.id
       - Also call setTelegramChatId to store chatId for notifications
       - Reply with success message including user displayName
       - If code invalid/expired: reply with error message and instructions
       - If no code: check if already linked. If linked, reply "Already linked as {name}". If not, reply with instructions to generate a code from the web app.

       /projects handler:
       - Resolve Eluma user, if not linked reply with link instructions
       - Get team for user, get all projects for team
       - Reply with formatProjectList and attach projectMenu

       /ideas handler:
       - Resolve user + team, get ideas for team
       - Reply with formatIdeaList and attach ideaMenu

       /status handler:
       - Resolve user + team, get projects + ideas
       - Reply with formatStatus (summary overview)

       /help handler:
       - Reply with list of all commands and brief descriptions
       - Include: /start, /projects, /ideas, /status, /settings, /help

       Also call bot.api.setMyCommands() with all command descriptions.

       - Export registerCommands function
  </action>
  <verify>cd /Users/developer/eluma && npx tsc --noEmit</verify>
  <done>Formatters produce Telegram MarkdownV2-safe output for projects and ideas, /start links accounts, /projects and /ideas list items, /status gives overview, /help lists commands</done>
</task>

<task type="auto">
  <name>Task 2: Build interactive menus for projects, ideas, and notification settings</name>
  <files>
    server/src/telegram/menus/project-menu.ts
    server/src/telegram/menus/idea-menu.ts
    server/src/telegram/menus/settings-menu.ts
  </files>
  <action>
    1. Create server/src/telegram/menus/project-menu.ts:
       - Import Menu from @grammyjs/menu, BotContext from ../types.js
       - Import getAllProjects, getProjectById from events/reducers/project.js
       - Import getWorkflowState from workflow/engine.js, getStepDefinition from workflow/definitions.js
       - Import resolveElumaUser, getTeamForUser from ../auth.js
       - Import formatProjectDetail, phaseEmoji from ../formatters.js

       projectMenu = new Menu<BotContext>("project-list").dynamic():
       - Resolve user+team, get non-archived projects
       - For each project (max 10): text button with "{phaseEmoji} {name}", callback stores projectId in session and navigates to project-detail menu
       - Add row

       projectDetailMenu = new Menu<BotContext>("project-detail").dynamic():
       - Read session.currentProjectId, load project
       - Show buttons: "Phase: {currentPhase}" (info only), "Workflow >" (navigate to workflow -- will be wired in Plan 04), "Back" (navigate back to project-list)

       Register projectDetailMenu under projectMenu.
       Export both menus.

    2. Create server/src/telegram/menus/idea-menu.ts:
       - Import Menu from @grammyjs/menu, BotContext from ../types.js
       - Import getIdeasForTeam, getIdeaById from events/reducers/idea.js
       - Import resolveElumaUser, getTeamForUser from ../auth.js
       - Import formatIdeaDetail, statusEmoji from ../formatters.js
       - Import { refineIdea, proposeGraduation, castGraduationVote } from idea-pool/refinement.js and graduation.js

       ideaMenu = new Menu<BotContext>("idea-list").dynamic():
       - Resolve user+team, get non-archived ideas
       - For each idea (max 10): text button with "{statusEmoji} {title}", callback shows idea detail via editMessageText + navigate to idea-detail

       ideaDetailMenu = new Menu<BotContext>("idea-detail").dynamic():
       - Load idea from session state
       - If status is "refining": show "Refine" button that calls refineIdea and replies with the AI question
       - If status is "ready": show "Propose Graduation" button
       - If status is "voting": show "Vote Yes" / "Vote No" buttons
       - Always show "Back" button to return to idea-list

       Register ideaDetailMenu under ideaMenu.
       Export both menus.

    3. Create server/src/telegram/menus/settings-menu.ts:
       - Import Menu from @grammyjs/menu, BotContext from ../types.js
       - Import getPreferencesForUser, updatePreference from notifications/preferences.js
       - Import resolveElumaUser from ../auth.js

       settingsMenu = new Menu<BotContext>("settings").dynamic():
       - Resolve user, get preferences
       - For each channel (web, telegram, email):
         - Show channel name as header row
         - For each priority (low, medium, high, critical):
           - Show toggle button: "{checkmark or X} {priority}" that calls updatePreference to toggle
           - Short callback data using prefix pattern: "s:{channel[0]}:{priority[0]}:{0|1}"

       Register /settings command in commands.ts that replies with "Notification Settings" + settingsMenu.

       Export settingsMenu.
  </action>
  <verify>cd /Users/developer/eluma && npx tsc --noEmit</verify>
  <done>Project menu shows dynamic project list with detail navigation, idea menu shows ideas with status-dependent action buttons, settings menu toggles notification preferences per channel per priority</done>
</task>

</tasks>

<verification>
- `cd /Users/developer/eluma && npx tsc --noEmit` compiles without errors
- `grep -r "registerCommands\|projectMenu\|ideaMenu\|settingsMenu" server/src/telegram/` confirms all modules exist
- `grep "setMyCommands" server/src/telegram/commands.ts` confirms bot commands registered
- `grep "Menu" server/src/telegram/menus/` confirms @grammyjs/menu usage
</verification>

<success_criteria>
- /start links Telegram account to Eluma via 6-digit code
- /projects shows dynamic project list with inline keyboard navigation
- /ideas shows idea pool with status-dependent action buttons (refine/propose/vote)
- /status gives quick summary of projects and ideas
- /settings allows toggling notification preferences per channel/priority
- /help lists all commands
- All menus use @grammyjs/menu for state management
- Callback data stays within 64-byte Telegram limit using short prefixes
</success_criteria>

<output>
After completion, create `.planning/phases/07-telegram-bot-notifications/07-03-SUMMARY.md`
</output>
