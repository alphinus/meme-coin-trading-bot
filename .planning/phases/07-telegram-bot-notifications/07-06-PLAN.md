---
phase: 07-telegram-bot-notifications
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/telegram/menus/project-menu.ts
  - server/src/routes/projects.ts
  - server/src/routes/ideas.ts
  - server/src/routes/ai.ts
  - server/src/workflow/engine.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Telegram bot 'Workflow >' button in project detail menu renders the current workflow step (not 'coming soon')"
    - "Domain events emitted in route handlers and workflow engine trigger notifications via emitNotificationForEvent"
    - "Notifications appear in the web NotificationBell when projects are created, phases advance, ideas graduate, etc."
  artifacts:
    - path: "server/src/telegram/menus/project-menu.ts"
      provides: "Workflow button wired to renderCurrentWorkflowStep"
      contains: "renderCurrentWorkflowStep"
    - path: "server/src/routes/projects.ts"
      provides: "Notification emission for project events"
      contains: "emitNotificationForEvent"
    - path: "server/src/routes/ideas.ts"
      provides: "Notification emission for idea events"
      contains: "emitNotificationForEvent"
    - path: "server/src/routes/ai.ts"
      provides: "Notification emission for AI events"
      contains: "emitNotificationForEvent"
    - path: "server/src/workflow/engine.ts"
      provides: "Notification emission for workflow step_completed and phase events"
      contains: "emitNotificationForEvent"
  key_links:
    - from: "server/src/telegram/menus/project-menu.ts"
      to: "server/src/telegram/menus/workflow-menu.ts"
      via: "import renderCurrentWorkflowStep"
      pattern: "renderCurrentWorkflowStep"
    - from: "server/src/routes/projects.ts"
      to: "server/src/notifications/emitter.ts"
      via: "import emitNotificationForEvent"
      pattern: "emitNotificationForEvent"
    - from: "server/src/routes/ideas.ts"
      to: "server/src/notifications/emitter.ts"
      via: "import emitNotificationForEvent"
      pattern: "emitNotificationForEvent"
    - from: "server/src/workflow/engine.ts"
      to: "server/src/notifications/emitter.ts"
      via: "import emitNotificationForEvent"
      pattern: "emitNotificationForEvent"
---

<objective>
Close two critical wiring gaps identified in 07-VERIFICATION.md that prevent full phase goal achievement:
1. Wire the orphaned workflow-menu.ts module to the project detail menu's "Workflow >" button
2. Wire the orphaned emitter.ts module into all route handlers and the workflow engine

Purpose: These are the final two connections needed for the phase to pass verification. All underlying modules are complete -- only the wiring is missing.
Output: Both gaps closed; all 5 verification truths pass.
</objective>

<execution_context>
@/Users/developer/.claude/get-shit-done/workflows/execute-plan.md
@/Users/developer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-telegram-bot-notifications/07-VERIFICATION.md
@.planning/phases/07-telegram-bot-notifications/07-04-SUMMARY.md
@.planning/phases/07-telegram-bot-notifications/07-05-SUMMARY.md
@server/src/telegram/menus/project-menu.ts
@server/src/telegram/menus/workflow-menu.ts
@server/src/notifications/emitter.ts
@server/src/routes/projects.ts
@server/src/routes/ideas.ts
@server/src/routes/ai.ts
@server/src/workflow/engine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire workflow menu to project detail button</name>
  <files>server/src/telegram/menus/project-menu.ts</files>
  <action>
    Replace the stub "Workflow >" button handler in project-menu.ts (lines 40-44) with a call to the existing `renderCurrentWorkflowStep` function from workflow-menu.ts.

    Specific changes to `server/src/telegram/menus/project-menu.ts`:

    1. Add import at the top of the file:
       ```typescript
       import { renderCurrentWorkflowStep } from "./workflow-menu.js";
       ```

    2. Replace the stub handler (lines 40-44):
       ```typescript
       // OLD (remove):
       range.text("Workflow >", async (ctx) => {
         await ctx.answerCallbackQuery("Workflow coming soon");
       });

       // NEW (replace with):
       range.text("Workflow >", async (ctx) => {
         await ctx.answerCallbackQuery();
         await renderCurrentWorkflowStep(ctx, projectId);
       });
       ```

    The `projectId` variable is already in scope from line 20 (`ctx.session.currentProjectId`). The `answerCallbackQuery()` without arguments acknowledges the button press to remove Telegram's loading spinner. Then `renderCurrentWorkflowStep` sends the current workflow step as a new message with appropriate inline keyboard.

    Do NOT modify workflow-menu.ts, callback.ts, or any other file. The workflow callback handler (`wf:` prefix) is already registered in bot.ts and will handle subsequent workflow step interactions.
  </action>
  <verify>
    1. Run `npx tsc --noEmit` from server directory -- no new type errors
    2. Grep project-menu.ts for "coming soon" -- should return 0 matches
    3. Grep project-menu.ts for "renderCurrentWorkflowStep" -- should return 2 matches (import + call)
  </verify>
  <done>The "Workflow >" button in project detail menu calls renderCurrentWorkflowStep instead of showing "coming soon". Users can now access GSD workflow steps from Telegram.</done>
</task>

<task type="auto">
  <name>Task 2: Wire notification emitter into route handlers and workflow engine</name>
  <files>
    server/src/routes/projects.ts
    server/src/routes/ideas.ts
    server/src/routes/ai.ts
    server/src/workflow/engine.ts
  </files>
  <action>
    Add `emitNotificationForEvent` calls in fire-and-forget pattern alongside existing `processEventForDocumentation` and `evaluateTriggersForEvent` calls. This is the same pattern used throughout the codebase -- no await, just call and forget.

    **File 1: `server/src/routes/projects.ts`**

    1. Add import (next to the existing processEventForDocumentation import):
       ```typescript
       import { emitNotificationForEvent } from "../notifications/emitter.js";
       ```

    2. Add `emitNotificationForEvent(event)` call after every existing `evaluateTriggersForEvent(event)` call. There are 6 locations where this pair appears (lines ~115-116, ~372-373, ~449-450, ~466-467, ~482-483, ~629-630). After each `evaluateTriggersForEvent(...)` line, add:
       ```typescript
       emitNotificationForEvent(createdEvent); // Fire-and-forget notification
       ```
       (Use the same event variable name that the existing lines use.)

    **File 2: `server/src/routes/ideas.ts`**

    1. Add import (next to the existing processEventForDocumentation import):
       ```typescript
       import { emitNotificationForEvent } from "../notifications/emitter.js";
       ```

    2. Add `emitNotificationForEvent(event)` call after every existing `evaluateTriggersForEvent(event)` call. There are 8 locations (lines ~105-106, ~123-124, ~292-293, ~398-399, ~478-479, ~502-503, ~574-575). After each `evaluateTriggersForEvent(...)` line, add the corresponding `emitNotificationForEvent(...)` call.

    **File 3: `server/src/routes/ai.ts`**

    1. Add import:
       ```typescript
       import { emitNotificationForEvent } from "../notifications/emitter.js";
       ```

    2. The ai.ts route has `appendEvent` calls but does NOT have existing `processEventForDocumentation`/`evaluateTriggersForEvent` calls. Add `emitNotificationForEvent(event)` after each `appendEvent` call that produces an event type in the emitter's EVENT_NOTIFICATION_MAP. The relevant event types from ai.ts are:
       - `ai.mediation_requested` (line ~398) -- not in the map, but `ai.mediation_completed` IS. The mediation_completed event is emitted inside `mediateConflict()`, not in the route. Skip this.
       - For ai.ts, only add the import. The AI events that ARE in the notification map (ai.trigger_fired, ai.mediation_completed) are emitted from the AI trigger engine and mediation module, not from routes. Adding the import and a comment is sufficient for traceability.

    Actually, since ai.ts events (ai.member_configured, ai.message_read, ai.model_overridden, ai.decision_overridden, ai.mediation_requested) are NOT in the EVENT_NOTIFICATION_MAP in emitter.ts, calling emitNotificationForEvent on them would be a no-op (the function returns early for unmapped event types). For cleanliness, add the import and add calls after the `appendEvent` calls for `ai.model_overridden` and `ai.decision_overridden` (lines ~306, ~353) since these represent significant state changes that could be added to the notification map later. The emitter safely ignores unmapped events.

    **File 4: `server/src/workflow/engine.ts`**

    1. Add import:
       ```typescript
       import { emitNotificationForEvent } from "../notifications/emitter.js";
       ```

    2. Add `emitNotificationForEvent(event)` after each `appendEvent` call that emits an event type in the EVENT_NOTIFICATION_MAP. The relevant ones are:
       - `workflow.step_completed` (line ~115): Add `emitNotificationForEvent(stepEvent);`
       - `project.phase_completed` events (lines ~292, ~367): These use event type "project.phase_completed" which is NOT in the map, but the subsequent `project.phase_advanced` (line ~405) IS. Add after the advancedEvent.
       - `project.archived` events (lines ~309, ~387): Add `emitNotificationForEvent(archivedEvent);`
       - `project.phase_advanced` (line ~405): Add `emitNotificationForEvent(advancedEvent);`

    The fire-and-forget pattern means: do NOT await these calls. The emitter function handles its own errors internally via try/catch.
  </action>
  <verify>
    1. Run `npx tsc --noEmit` from server directory -- no new type errors
    2. Grep all route files for "emitNotificationForEvent":
       - `grep -r "emitNotificationForEvent" server/src/routes/` should show imports and calls in projects.ts, ideas.ts, and ai.ts
       - `grep "emitNotificationForEvent" server/src/workflow/engine.ts` should show import and calls
    3. Count total emitNotificationForEvent calls (excluding imports): should be >= 15 calls across all files
  </verify>
  <done>
    Domain events now trigger notifications via the multi-channel dispatcher. When a project is created, a phase advances, an idea graduates, or a workflow step completes, all team members (except the triggering user) receive notifications on their configured channels (web, Telegram, email).
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Workflow menu wiring:**
   - Grep `server/src/telegram/menus/project-menu.ts` for "coming soon" returns 0 matches
   - Grep `server/src/telegram/menus/project-menu.ts` for "renderCurrentWorkflowStep" returns 2 matches

2. **Notification emitter wiring:**
   - Grep `server/src/routes/projects.ts` for "emitNotificationForEvent" returns >= 7 matches (1 import + 6 calls)
   - Grep `server/src/routes/ideas.ts` for "emitNotificationForEvent" returns >= 8 matches (1 import + 7+ calls)
   - Grep `server/src/workflow/engine.ts` for "emitNotificationForEvent" returns >= 4 matches (1 import + 3+ calls)

3. **TypeScript compiles:** `npx tsc --noEmit` passes with no new errors

4. **Both verification truths from 07-VERIFICATION.md now pass:**
   - Truth #1 (partial -> pass): Workflow menu accessible from project detail
   - Truth #5 (failed -> pass): Domain events trigger notifications
</verification>

<success_criteria>
- No "Workflow coming soon" stub text remains in project-menu.ts
- emitNotificationForEvent is imported and called in projects.ts, ideas.ts, ai.ts, and workflow/engine.ts
- TypeScript compiles without errors
- All 5 phase verification truths achievable
</success_criteria>

<output>
After completion, create `.planning/phases/07-telegram-bot-notifications/07-06-SUMMARY.md`
</output>
